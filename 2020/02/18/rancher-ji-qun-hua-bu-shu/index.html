<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="rancher集群化部署, Java Android Python DevOps JamesLiAndroid 小李 运维 ">
    <meta name="baidu-site-verification" content>
    <meta name="google-site-verification" content>
    <meta name="360-site-verification" content>
    <meta name="description" content="Rancher集群化部署–在线安装前期准备目前我们的工作进展有序，已经实现了利用Docker部署各微服务，结合CI/CD进行微服务构建。
但是面对当前的部署方式，依旧存在局限性：

集群问题，部署时启动多套有难度
微服务停机或者升级时，或者">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>rancher集群化部署 | 时代与猫的脚步</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?46e79e71af0709a5b9106bf20cecc493";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">时代与猫的脚步</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">时代与猫的脚步</div>
        <div class="logo-desc">
            
            山东理工大学 | 电子信息工程
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                友情链接
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                留言板
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/JamesLiAndroid" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/JamesLiAndroid" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/1.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        rancher集群化部署
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        <span class="chip bg-color">无标签</span>
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-02-18
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    JamesLiAndroid
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    10k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    50 分
                </div>
                
                

                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Rancher集群化部署–在线安装"><a href="#Rancher集群化部署–在线安装" class="headerlink" title="Rancher集群化部署–在线安装"></a>Rancher集群化部署–在线安装</h1><h2 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h2><p>目前我们的工作进展有序，已经实现了利用Docker部署各微服务，结合CI/CD进行微服务构建。</p>
<p>但是面对当前的部署方式，依旧存在局限性：</p>
<ol>
<li>集群问题，部署时启动多套有难度</li>
<li>微服务停机或者升级时，或者微服务出现故障时，导致出现问题后不能及时上报</li>
<li>目前的部署方式必须进行停机更新，不满足服务不停机更新，且不满足滚动部署或者蓝绿部署的要求</li>
<li>微服务不能进行弹性伸缩，在熔断、限流、降级方面做的不足</li>
</ol>
<p>针对以上的问题，引入k8s进行微服务的集群化部署。利用Rancher来针对k8s集群进行统一管理，对整个集群进行运维。</p>
<h3 id="规划容量"><a href="#规划容量" class="headerlink" title="规划容量"></a>规划容量</h3><p>我们目前预测大概要到100多个的微服务集群信息，参考Rancher官网的容量规划，进行配置。初步确定服务器大概为7台，其中三台安装k8s，剩余一台做管理机，其它三台做备用机，进行日常添加删除主机的使用。</p>
<p>配置图如下：</p>
<table>
<thead>
<tr>
<th>主机名称</th>
<th>主机配置</th>
<th>主机ip</th>
<th>部署服务</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>k8s-rke-node-start</td>
<td>4c 16G 200G</td>
<td>192.168.238.240</td>
<td>nginx访问入口，rke、kubectl、helm安装工具</td>
<td>安装机和日常运维机器</td>
</tr>
<tr>
<td>k8s-master-node00</td>
<td>4c 16G 200G</td>
<td>192.168.238.239</td>
<td>k8s主节点工具、rancher</td>
<td>集群主节点1号</td>
</tr>
<tr>
<td>k8s-master-node01</td>
<td>4c 16G 200G</td>
<td>192.168.238.232</td>
<td>k8s主节点工具、rancher</td>
<td>集群主节点2号</td>
</tr>
<tr>
<td>k8s-master-node02</td>
<td>4c 16G 200G</td>
<td>192.168.238.241</td>
<td>k8s主节点工具、rancher</td>
<td>集群主节点3号</td>
</tr>
<tr>
<td>k8s-master-cluster-node01</td>
<td>2c 8G 100G</td>
<td>192.168.238.233</td>
<td>k8s从节点</td>
<td>集群从节点1号，未使用</td>
</tr>
<tr>
<td>k8s-master-cluster-node02</td>
<td>2c 8G 100G</td>
<td>192.168.238.234</td>
<td>k8s从节点</td>
<td>集群从节点2号，未使用</td>
</tr>
<tr>
<td>k8s-master-cluster-node03</td>
<td>2c 8G 100G</td>
<td>192.168.238.235</td>
<td>k8s从节点</td>
<td>集群从节点3号，未使用</td>
</tr>
</tbody></table>
<h3 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h3><ul>
<li>操作系统：CentOS 7.6 1810，以Basic Server方式安装</li>
<li>docker版本：19.03.6</li>
<li>kubernetes版本：1.17.2</li>
<li>rancher版本：2.3.5</li>
<li>nginx版本：1.16.1</li>
<li>工具链<ul>
<li>rke: 1.0.4</li>
<li>kubectl: 1.16.6</li>
<li>helm: 3.1.0</li>
</ul>
</li>
</ul>
<h3 id="一、服务器准备"><a href="#一、服务器准备" class="headerlink" title="一、服务器准备"></a>一、服务器准备</h3><p>参考 Linux日常运维操作 进行服务器准备，优先设置系统初始化的相关安装，以及docker软件的安装，这里不再说明，请参考。随后从docker安装完成后进行准备说明。在docker安装完成后，要对其进行锁定，避免因为使用yum update命令导致docker版本变动。</p>
<p><strong>下面的操作每一台服务器上都要进行操作。</strong></p>
<h4 id="1-docker的基本配置"><a href="#1-docker的基本配置" class="headerlink" title="1. docker的基本配置"></a>1. docker的基本配置</h4><p>daemon.json默认位于/etc/docker/daemon.json，如果没有可手动创建，基于systemd管理的系统都是相同的路径。通过修改daemon.json来改过Docker配置，也是Docker官方推荐的方法。</p>
<p>1、配置私有仓库（目前并未使用私有仓库，暂时不进行配置）<br>Docker默认只信任TLS加密的仓库地址(https)，所有非https仓库默认无法登陆也无法拉取镜像。insecure-registries字面意思为不安全的仓库，通过添加这个参数对非https仓库进行授信。可以设置多个insecure-registries地址，以数组形式书写，地址不能添加协议头(http)。<br>{<br>    “insecure-registries”: [“harbor.xxx.cn:30002”]<br>}</p>
<p>2、配置存储驱动<br>OverlayFS是一个新一代的联合文件系统，类似于AUFS，但速度更快，实现更简单。Docker为OverlayFS提供了两个存储驱动程序:旧版的overlay，新版的overlay2(更稳定)。</p>
<p>先决条件:</p>
<p>overlay2: Linux内核版本4.0或更高版本，或使用内核版本3.10.0-514+的RHEL或CentOS。<br>overlay: 主机Linux内核版本3.18+</p>
<p>支持的磁盘文件系统</p>
<p>ext4(仅限RHEL 7.1)<br>xfs(RHEL7.2及更高版本)，需要启用d_type=true。</p>
<p>{<br>    “storage-driver”: “overlay2”,<br>    “storage-opts”: [“overlay2.override_kernel_check=true”]<br>}</p>
<p>3、配置日志驱动（由于设置后会导致docker服务无法启动，暂时未进行设置）</p>
<p>容器在运行时会产生大量日志文件，很容易占满磁盘空间。通过配置日志驱动来限制文件大小与文件的数量。 &gt;限制单个日志文件为50M,最多产生3个日志文件<br>{<br>    “log-driver”: “json-file”,<br>    “log-opts”: {<br>        “max-size”: “50m”,<br>        “max-file”: “3”<br>    }<br>}</p>
<p>4、配置国内公共镜像</p>
<p> “registry-mirrors”: [<br>        “<a href="https://registry.cn-hangzhou.aliyuncs.com&quot;" target="_blank" rel="noopener">https://registry.cn-hangzhou.aliyuncs.com&quot;</a>,<br>        “<a href="https://docker.mirrors.ustc.edu.cn&quot;" target="_blank" rel="noopener">https://docker.mirrors.ustc.edu.cn&quot;</a>,<br>        “<a href="https://registry.docker-cn.com&quot;" target="_blank" rel="noopener">https://registry.docker-cn.com&quot;</a><br>    ],</p>
<p>最终配置文件如下：</p>
<pre><code>{
    &quot;registry-mirrors&quot;: [
        &quot;https://registry.cn-hangzhou.aliyuncs.com&quot;,
        &quot;https://docker.mirrors.ustc.edu.cn&quot;,
        &quot;https://registry.docker-cn.com&quot;
    ],
    &quot;insecure-registries&quot;: [&quot;harbor.xxx.cn:30002&quot;]，
    &quot;log-driver&quot;: &quot;json-file&quot;,
    &quot;log-opts&quot;: {
        &quot;max-size&quot;: &quot;50m&quot;,
        &quot;max-file&quot;: &quot;3&quot;
    }
}</code></pre><p>操作如下：</p>
<pre><code># vim /etc/docker/daemon.json

// 输入以下内容
{
&quot;registry-mirrors&quot;: [
    &quot;https://registry.cn-hangzhou.aliyuncs.com&quot;,
    &quot;https://docker.mirrors.ustc.edu.cn&quot;,
    &quot;https://registry.docker-cn.com&quot;
],
&quot;insecure-registries&quot;: [&quot;harbor.xxx.cn:30002&quot;]，
&quot;log-driver&quot;: &quot;json-file&quot;,
&quot;log-opts&quot;: {
    &quot;max-size&quot;: &quot;50m&quot;,
    &quot;max-file&quot;: &quot;3&quot;
    }
}

// :wq进行保存</code></pre><p>设置完成后，需要重启docker服务，操作如下：</p>
<pre><code>$ sudo systemctl daemon-reload
$ sudo systemctl restart docker</code></pre><h4 id="2-服务器名称修改"><a href="#2-服务器名称修改" class="headerlink" title="2. 服务器名称修改"></a>2. 服务器名称修改</h4><pre><code>// 变更服务器hostname
# hostnamectl set-hostname k8s-node-1

// 修改host文件
# vim /etc/hosts
// 在文件后续追加以下内容
192.168.238.239 k8s-master-node00
192.168.238.240 k8s-rke-node-start
192.168.238.232 k8s-cluster-node01
192.168.238.241 k8s-cluster-node02</code></pre><h4 id="3-开放端口"><a href="#3-开放端口" class="headerlink" title="3. 开放端口"></a>3. 开放端口</h4><pre><code>// 根据官方文档开放端口信息
$ sudo firewall-cmd --zone=public --add-port=80/tcp --permanent

$ sudo firewall-cmd --zone=public --add-port=443/tcp --permanent

$ sudo firewall-cmd --zone=public --add-port=2376/tcp --permanent

$ sudo firewall-cmd --zone=public --add-port=6443/tcp --permanent

$ sudo firewall-cmd --zone=public --add-port=2379/tcp --permanent

$ sudo firewall-cmd --zone=public --add-port=2380/tcp --permanent

$ sudo firewall-cmd --zone=public --add-port=8472/udp --permanent

$ sudo firewall-cmd --zone=public --add-port=9099/tcp --permanent

$ sudo firewall-cmd --zone=public --add-port=10250/tcp --permanent

$ sudo firewall-cmd --zone=public --add-port=10254/tcp --permanent

$ sudo firewall-cmd --zone=public --add-port=30000-32767/tcp --permanent

$ sudo firewall-cmd --zone=public --add-port=30000-32767/udp --permanent

// 使配置生效
$ sudo firewall-cmd --reload</code></pre><h4 id="4-关闭selinux"><a href="#4-关闭selinux" class="headerlink" title="4. 关闭selinux"></a>4. 关闭selinux</h4><pre><code>// 获取linux状态
$ sudo getenforce
// 命令行设置关闭selinux
$ sudo setenforce 0
// 修改配置文件
$ sudo vim /etc/selinux/config
// 将文件中的SELINUX=enforcing改为SELINUX=disabled

// :wq 保存文件退出</code></pre><h4 id="5-禁用swap"><a href="#5-禁用swap" class="headerlink" title="5. 禁用swap"></a>5. 禁用swap</h4><pre><code>// 删除 swap 区所有内容
# swapoff -a
删除 swap 挂载，这样系统下次启动不会再挂载 swap
// 编辑挂载文件，用 “#” 注释 swap 行
# vim /etc/fstab
// 找到/dev/mapper/centos-swap swap这一行，用“#”进行注释

// 重启系统，测试
# reboot

// 重启后查看
$ free -h
            total        used        free      shared  buff/cache   available
Mem:           3.7G        203M        3.1G        8.5M        384M        3.3G
Swap:            0B          0B          0B</code></pre><h4 id="7-操作系统及kernel调优"><a href="#7-操作系统及kernel调优" class="headerlink" title="7. 操作系统及kernel调优"></a>7. 操作系统及kernel调优</h4><pre><code>// 针对文件打开数调优。
# vim /etc/security/limits.conf
// 输入以下内容
root soft nofile 65535
root hard nofile 65535
*    soft nofile 65535
*    hard nofile 65535
// :wq保存退出

// 调整最大进程数
# sed -i &#39;s#4096#65535#g&#39; /etc/security/limits.d/20-nproc.conf

// kernel调优
# cat &gt;&gt; /etc/sysctl.conf&lt;&lt;EOF
net.ipv4.ip_forward=1
net.bridge.bridge-nf-call-iptables=1
net.bridge.bridge-nf-call-ip6tables=1
vm.swappiness=0
vm.max_map_count=655360
EOF

// 使修改生效
$ sudo sysctl -p</code></pre><h4 id="8-服务器免密登录"><a href="#8-服务器免密登录" class="headerlink" title="8. 服务器免密登录"></a>8. 服务器免密登录</h4><p>这一步操作从192.168.238.240所在的服务器进行操作，由此机器将ssh密钥生成并发送到各个目标机器上。</p>
<pre><code>// 生成密钥
$ ssh-keygen -t rsa

$ ssh-copy-id -p 15555 centos@192.168.238.232
$ ssh-copy-id -p 15555 centos@192.168.238.239
$ ssh-copy-id -p 15555 centos@192.168.238.241</code></pre><h3 id="二、安装工具链–rke、kubectl、helm"><a href="#二、安装工具链–rke、kubectl、helm" class="headerlink" title="二、安装工具链–rke、kubectl、helm"></a>二、安装工具链–rke、kubectl、helm</h3><h4 id="1-下载rke工具"><a href="#1-下载rke工具" class="headerlink" title="1. 下载rke工具"></a>1. 下载rke工具</h4><pre><code>// 在线下载，也可以下载完成后通过ftp传输到服务器上
$ wget https://github.com/rancher/rke/releases/download/v1.0.4/rke_linux-amd64

// 添加可执行权限
$ sudo chmod +x rke_linux-amd64

// 添加到环境变量，或者直接在~/.bashrc文件中用export命令暴露该工具
$ sudo mv rke_linux-amd64 /usr/local/bin/rke

// 测试是否已经安装完毕
$ rke --version
// 输出信息：
rke version v1.0.4</code></pre><h4 id="2-下载kubectl工具"><a href="#2-下载kubectl工具" class="headerlink" title="2. 下载kubectl工具"></a>2. 下载kubectl工具</h4><p>1.16.6版本对应</p>
<pre><code>// 有时候会下载不下来，多尝试几次
$ curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.16.6/bin/linux/amd64/kubectl

$ sudo chmod +x kubectl

$ sudo mv ./kubectl /usr/local/bin/kubectl

// 引入自动补全

// 安装自动补全工具
$ sudo yum install bash-completion -y
$ echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc</code></pre><h4 id="3-安装Helm"><a href="#3-安装Helm" class="headerlink" title="3. 安装Helm"></a>3. 安装Helm</h4><p>访问 Helm Github 下载页面 <a href="https://github.com/helm/helm/releases" target="_blank" rel="noopener">https://github.com/helm/helm/releases</a> 找到最新的客户端，里面有不同系统下的包，这里我们选择 Linux amd64，然后在 Linux 系统中使用 Wget 命令进行下载。</p>
<pre><code>// 下载Helm客户端
$ wget https://get.helm.sh/helm-v3.1.0-linux-amd64.tar.gz</code></pre><p>接下来解压下载的包，然后将客户端放置到 /usr/local/bin/ 目录下：</p>
<pre><code>// 解压 Helm
$ tar -zxvf helm-v3.1.0-linux-amd64.tar.gz

// 复制客户端执行文件到 bin 目录下，方便在系统下能执行 helm 命令
$ sudo mv linux-amd64/helm /usr/local/bin/helm

// 测试是否安装成功
$ helm version
// 输出以下内容
version.BuildInfo{Version:&quot;v3.1.0&quot;, GitCommit:&quot;b29d20baf09943e134c2fa5e1e1cab3bf93315fa&quot;, GitTreeState:&quot;clean&quot;, GoVersion:&quot;go1.13.7&quot;}

// 下面需要添加Chart仓库

$ helm repo add  elastic    https://helm.elastic.co

$ helm repo add  gitlab     https://charts.gitlab.io

$ helm repo add  harbor     https://helm.goharbor.io

$ helm repo add  bitnami    https://charts.bitnami.com/bitnami

$ helm repo add  incubator  http://mirror.azure.cn/kubernetes/charts-incubator/

$ helm repo add  stable     http://mirror.azure.cn/kubernetes/charts-incubator/

$ helm repo add  rancher-stable    http://releases.rancher.com/server-charts/stable

$ helm repo update</code></pre><h3 id="三、利用rke安装k8s"><a href="#三、利用rke安装k8s" class="headerlink" title="三、利用rke安装k8s"></a>三、利用rke安装k8s</h3><h4 id="1-生成配置文件并进行集群部署"><a href="#1-生成配置文件并进行集群部署" class="headerlink" title="1. 生成配置文件并进行集群部署"></a>1. 生成配置文件并进行集群部署</h4><p>可以用两种方式创建配置文件，一种是直接编写yml文件，另一种是通过交互式方式生成yml文件。我这边在实践的过程中，发现通过交互式生成生成的配置文件，在安装过程中出现了各种各样的问题。利用交互式生成配置文件，然后进行进行裁剪，参考官网步骤进行配置。这里直接进行编写。</p>
<pre><code>$ mkdir cluster

// 运行rke config交互式配置向导
$ rke config

// 配置完成后编辑生成的文件cluster.yml
$ vim cluster.yml
// 文件最终内容如下：</code></pre><pre><code># If you intened to deploy Kubernetes in an air-gapped environment,               
# please consult the documentation on how to configure custom RKE images.         
nodes:                                                                            
- address: 192.168.238.239                                                            
  port: &quot;15555&quot;                                                                   
  internal_address: &quot;&quot;                                                            
  role:                                                                           
  - controlplane                                                                  
  - worker                                                                        
  - etcd                                                                          
  hostname_override: &quot;&quot;                                                           
  user: centos                                                                    
  docker_socket: /var/run/docker.sock                                             
  ssh_key: &quot;&quot;                                                                     
  ssh_key_path: ~/.ssh/id_rsa                                                     
  ssh_cert: &quot;&quot;                                                                    
  ssh_cert_path: &quot;&quot;                                                               
  labels: {}                                                                      
  taints: []                                                                      
- address: 192.168.238.232                                                            
  port: &quot;15555&quot;                                                                   
  internal_address: &quot;&quot;                                                            
  role:                                                                           
  - controlplane                                                                  
  - worker                                                                        
  - etcd                                                                          
  hostname_override: &quot;&quot;                                                           
  user: centos                                                                    
  docker_socket: /var/run/docker.sock                                             
  ssh_key: &quot;&quot;                                                                     
  ssh_key_path: ~/.ssh/id_rsa                                                     
  ssh_cert: &quot;&quot;                                                                    
  ssh_cert_path: &quot;&quot;                                                               
  labels: {}                                                                      
  taints: []                                                                      
- address: 192.168.238.241                                                            
  port: &quot;15555&quot;                                                                   
  internal_address: &quot;&quot;                                                            
  role:                                                                           
  - controlplane                                                                  
  - worker                                                                        
  - etcd                                                                          
  hostname_override: &quot;&quot;
  user: centos
  docker_socket: /var/run/docker.sock
  ssh_key: &quot;&quot;
  ssh_key_path: ~/.ssh/id_rsa
  ssh_cert: &quot;&quot;
  ssh_cert_path: &quot;&quot;
  labels: {}
  taints: []
services:
  etcd:
    snapshot: true
    retention: 24h
    creation: 6h
# 如果这里你使用自带的ssl签名或者使用公用签名，可以不添加下面的选项
ingress:
  provider: nginx
  options:
    use-forwarded-headers: &quot;true&quot;</code></pre><p>设置完成后，下面可以正式开始部署了。执行下面的命令开始安装：</p>
<pre><code>// 部署并启动k8s集群
$ rke up --config ./cluster.yml</code></pre><p>这时候开始进入部署状态。将会在三台服务器上进行部署，拉取相应镜像进行操作。</p>
<p>但是在部署过程中会存在各种各样的问题，下面单独设置一个章节讲解。假设现在一切顺利，安装完成了。最终在控制台上显示</p>
<pre><code>INFO[0172] Finished building Kubernetes cluster successfully</code></pre><p>说明安装完成。这时候k8s集群就正式完成了。部署完成后，在同级别目录下会存在三个文件，其中两个是主动生成的，分别为：</p>
<pre><code>cluster.yml：RKE集群配置文件。
kube_config_cluster.yml：集群的Kubeconfig文件，此文件包含完全访问集群的凭据。
cluster.rkestate：Kubernetes集群状态文件，此文件包含集群部署的状态，用于升级和更新。    </code></pre><h4 id="2-问题总结"><a href="#2-问题总结" class="headerlink" title="2. 问题总结"></a>2. 问题总结</h4><ul>
<li><strong>前提</strong>：如果出现错误，请先准备好清理脚本，重新进行安装。在232、239、241服务器上进行下面创建脚本的操作。</li>
</ul>
<p>如果有错误，先停止所有机器的镜像，无论是否在运行，通过执行下面的清理脚本恢复服务器初始状态。操作如下：</p>
<pre><code>$ vim rancher_clean-dirs.sh 
// 输入以下内容
#!/bin/sh

if [ $(id -u) -ne 0 ]; then
    echo &quot;Must be run as root!&quot;
    exit
fi 

DLIST=&quot;/var/lib/etcd /etc/kubernetes /etc/cni /opt/cni /var/lib/cni /var/run/calico /opt/rke&quot;
for dir in $DLIST; do
    echo &quot;Removing $dir&quot;
    rm -rf $dir
done
// :wq进行保存退出

$ vim rancher_clean-docker.sh
// 输入以下内容
#!/bin/sh

CLIST=$(docker ps -qa)
if [ &quot;x&quot;$CLIST == &quot;x&quot; ]; then
    echo &quot;No containers exist - skipping container cleanup&quot;
else
    docker rm -f $CLIST
fi

ILIST=$(docker images -a -q)
if [ &quot;x&quot;$ILIST == &quot;x&quot; ]; then
    echo &quot;No images exist - skipping image cleanup&quot;
else
    docker rmi $ILIST
fi

VLIST=$(docker volume ls -q)
if [ &quot;x&quot;$VLIST == &quot;x&quot; ]; then
    echo &quot;No volumes exist - skipping volume cleanup&quot;
else
    docker volume rm -f $VLIST
fi
// :wq进行保存退出

// 针对每个文件添加可执行权限
$ sudo chmod +x rancher_clean-dirs.sh 

$ sudo chmod +x rancher_clean-docker.sh </code></pre><p>这样在具体执行的时候，在目标服务器上，进行以下操作：</p>
<pre><code>$ sudo ./rancher_clean-docker.sh

$ sudo ./rancher_clean-docker.sh </code></pre><p>即可进行服务器清理操作，对目标服务器清理完成后，再回到240服务器进行执行部署命令。</p>
<ul>
<li>问题列表</li>
</ul>
<ol>
<li>安装报错：</li>
</ol>
<p>如果这一步报错下边的内容：</p>
<pre><code>if the SSH server version is at least version 6.7 or higher. If you are using RedHat/CentOS, you can&#39;t use the user `root`. Please refer to the documentation for more instructions</code></pre><p>则可能是系统的openssh版本太低，只需执行如下命令升级即可：</p>
<pre><code>$ ssh -V
OpenSSH_6.6.1p1, OpenSSL 1.0.1e-fips 11 Feb 2013  
// 低于上边要求的6.7
// 切换管理员权限
$ sudo su
# yum -y update openssh
# ssh -V
OpenSSH_7.4p1, OpenSSL 1.0.2k-fips  26 Jan 2017</code></pre><p>然后再切回centos用户执行安装即可！</p>
<ol start="2">
<li>安装报错：</li>
</ol>
<p>错误日志如下：</p>
<pre><code>WARN[0934] Failed to create Docker container [etcd-fix-perm] on host [192.168.238.239]: Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?
WARN[0934] Failed to create Docker container [etcd-fix-perm] on host [192.168.238.239]: Error response from daemon: Conflict. The container name &quot;/etcd-fix-perm&quot; is already in use by container &quot;3d0a7d0a9d12fb088eeda6a02c5f18c98a561149fadf9d4fa0b261b0f79273b5&quot;. You have to remove (or rename) that container to be able to reuse that name.
WARN[0934] Failed to create Docker container [etcd-fix-perm] on host [192.168.238.239]: Error response from daemon: Conflict. The container name &quot;/etcd-fix-perm&quot; is already in use by container &quot;3d0a7d0a9d12fb088eeda6a02c5f18c98a561149fadf9d4fa0b261b0f79273b5&quot;. You have to remove (or rename) that container to be able to reuse that name.
FATA[0934] [etcd] Failed to bring up Etcd Plane: Failed to create [etcd-fix-perm] container on host [192.168.238.239]: Failed to create Docker container [etcd-fix-perm] on host [192.168.238.239]: &lt;nil&gt;</code></pre><p>只在239机器上执行清理脚本后，再转回到240机器，运行rke up –config cluster.yml。</p>
<ol start="3">
<li>安装报错：</li>
</ol>
<p>错误日志如下：</p>
<pre><code>FATA[0700] Failed to get job complete status for job rke-network-plugin-deploy-job in namespace kube-system</code></pre><p>根据之前cluster.yml中的配置，创建docker网络，参考service_cluster_ip_range的配置项，默认为10.43.0.0/16</p>
<pre><code>docker network create --driver=bridge --subnet=10.43.0.0/16 br0_rke</code></pre><p>如果不创建也可以，重新执行rke up –name cluster.yml命令。</p>
<ol start="4">
<li>安装报错</li>
</ol>
<p>清理完成后还是报错：</p>
<pre><code>WARN[0224] [etcd] host [192.168.238.239] failed to check etcd health: failed to get /health for host [192.168.238.239]: Get https://192.168.238.239:2379/health: remote error: tls: bad certificate
WARN[0239] [etcd] host [192.168.238.232] failed to check etcd health: failed to get /health for host [192.168.238.232]: Get https://192.168.238.232:2379/health: remote error: tls: bad certificate
WARN[0255] [etcd] host [192.168.238.241] failed to check etcd health: failed to get /health for host [192.168.238.241]: Get https://192.168.238.241:2379/health: remote error: tls: bad certificate
FATA[0255] [etcd] Failed to bring up Etcd Plane: etcd cluster is unhealthy: hosts [192.168.238.239,192.168.238.232,192.168.238.241] failed to report healthy. Check etcd container logs on each host for more information</code></pre><p>请检查时钟同步问题，第二个是检查是否有未开放的端口信息。如果还有问题，需要重新执行清理脚本后，再运行rke config –name rancher-cluster.yml。</p>
<h4 id="3-配置信息指定"><a href="#3-配置信息指定" class="headerlink" title="3. 配置信息指定"></a>3. 配置信息指定</h4><p>安装完成后，查看各个节点信息，执行以下命令：</p>
<pre><code>$ kubectl get nodes</code></pre><p>可能会出现以下报错</p>
<pre><code>The connection to the server localhost:8080 was refused - did you specify the right host or port?</code></pre><p>或者报错情况如下： </p>
<pre><code>Config not found: /home/centos/kube_config_cluster.yml
The connection to the server localhost:8080 was refused - did you specify the right host or port?</code></pre><p>原因：kubenetes master没有与本机绑定，集群初始化的时候没有设置</p>
<p>解决办法：</p>
<pre><code>// 在命令行直接执行：
$ export KUBECONFIG=/home/centos/kube_config_cluster.conf

// 或者将该命令放到~/.bashrc中 
$ vim ~/.bashrc
// 文件末尾追加
export KUBECONFIG=/home/centos/kube_config_cluster.conf
// :wq保存
// 使配置生效
$ source ~/.bashrc

// 或者 在执行命令时手动指定配置文件，利用--kubeconfig。例如：
$ kubectl get nodes --kubeconfig=/home/centos/kube_config_cluster.conf</code></pre><!-- /etc/kubernetes/admin.conf这个文件主要是集群初始化的时候用来传递参数的 -->

<p>解决完上述问题，这时重新执行命令即可。</p>
<pre><code>$ kubectl get nodes
NAME          STATUS   ROLES                      AGE   VERSION
192.168.238.232   Ready    controlplane,etcd,worker   36m   v1.16.6
192.168.238.239   Ready    controlplane,etcd,worker   36m   v1.16.6
192.168.238.241   Ready    controlplane,etcd,worker   36m   v1.16.6

$  kubectl get pods --all-namespaces

NAMESPACE       NAME                                      READY   STATUS      RESTARTS   AGE
ingress-nginx   default-http-backend-67cf578fc4-2g498     1/1     Running     0          7m4s
ingress-nginx   nginx-ingress-controller-44wzn            1/1     Running     0          7m5s
ingress-nginx   nginx-ingress-controller-cf84g            1/1     Running     0          7m5s
ingress-nginx   nginx-ingress-controller-dxpxq            1/1     Running     0          7m5s
kube-system     canal-28m8p                               2/2     Running     0          32m
kube-system     canal-479px                               2/2     Running     0          32m
kube-system     canal-vdcvf                               2/2     Running     0          32m
kube-system     coredns-7c5566588d-flshv                  1/1     Running     0          7m29s
kube-system     coredns-7c5566588d-t6vx6                  1/1     Running     0          6m35s
kube-system     coredns-autoscaler-65bfc8d47d-bnj2h       1/1     Running     0          7m26s
kube-system     metrics-server-6b55c64f86-fgpkd           1/1     Running     0          7m15s
kube-system     rke-coredns-addon-deploy-job-vtnrs        0/1     Completed   0          7m34s
kube-system     rke-ingress-controller-deploy-job-d556q   0/1     Completed   0          7m13s
kube-system     rke-metrics-addon-deploy-job-dpdhq        0/1     Completed   0          7m23s
kube-system     rke-network-plugin-deploy-job-xkmgs       0/1     Completed   0          33m</code></pre><p>说明已经完成。需要注意的是，有些服务并未处在Running状态，一定要保证全部处于Running状态时，才能进行下一步操作。</p>
<h3 id="四、Rancher集群的安装"><a href="#四、Rancher集群的安装" class="headerlink" title="四、Rancher集群的安装"></a>四、Rancher集群的安装</h3><p>在进行Rancher集群安装之前，需要说明，这里采用私有签发CA证书的方式来实现SSL访问。首先进行证书的签发，然后进行rancher集群的安装。</p>
<h4 id="1-证书签发"><a href="#1-证书签发" class="headerlink" title="1. 证书签发"></a>1. 证书签发</h4><p>使用openssl创建自己的CA certificate</p>
<pre><code>// # ① 生成CA私钥文件
$ openssl genrsa -out ca.key 2048</code></pre><p>值得注意的是，Common Name一定要填写*.exmaple.org，以表示这个证书是一个通配证书（Wildcard Certificates），浏览器检查一个证书是否匹配，检查的就是Common Name。</p>
<pre><code>// # ② 生成CA证书文件
$ openssl req -new -x509 -key ca.key -out ca.crt</code></pre><p>这时候根证书已经完成，下面利用根证书来进行签发CA证书。操作如下：</p>
<pre><code>// 签发对应域名的私有密钥
$ openssl genrsa -out rancher.mine.com.key 2048

// 签发csr证书文件
$ openssl req -new -key rancher.mine.com.key -out rancher.mine.com.csr

// 编辑cnf配置文件
$ vim rancher.mine.com.cnf
// 输入以下信息
basicConstraints=CA:FALSE
subjectAltName=@my_subject_alt_names
subjectKeyIdentifier = hash

[ my_subject_alt_names ]
DNS.1 = *.rancher.mine.com
DNS.2 = rancher.mine.com

// :wq进行保存
// 这里两个DNS配置表示，进行通配证书的签发

// 最后执行，生成公钥信息
$ openssl x509 -req -in rancher.mine.com.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out rancher.mine.com.x4.crt -extfile rancher.mine.com.cnf -sha256

// 验证证书
$ openssl verify -CAfile ca.crt rancher.mine.com.x4.crt</code></pre><p>这样在一个文件夹下，就有多个个证书文件了，分别是下面的几个：</p>
<pre><code>ca.crt  ca.srl      rancher.mine.com.cnf  rancher.mine.com.key
ca.key  rancher.mine.com.csr  rancher.mine.com.x4.crt</code></pre><p>我们在这里用到的是<strong>rancher.mine.com.key</strong>和<strong>rancher.mine.com.x4.crt</strong>文件。</p>
<h4 id="2-rancher集群部署"><a href="#2-rancher集群部署" class="headerlink" title="2. rancher集群部署"></a>2. rancher集群部署</h4><p>执行以下命令：</p>
<pre><code>// 添加rancher的源仓库
$ helm repo add rancher-stable https://releases.rancher.com/server-charts/stable

// 在k8s中创建cattle-system命名空间，只能是这个名字
$ kubectl create namespace cattle-system

// 以私有证书的方式进行rancher的安装，标志为：--set ingress.tls.source=secret
$ helm install rancher rancher-stable/rancher --namespace cattle-system --set hostname=rancher.mine.com --set ingress.tls.source=secret

// 输出如下
NAME: rancher
LAST DEPLOYED: Sun Feb 23 13:32:13 2020
NAMESPACE: cattle-system
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
Rancher Server has been installed.

NOTE: Rancher may take several minutes to fully initialize. Please standby while Certificates are being issued and Ingress comes up.

Check out our docs at https://rancher.com/docs/rancher/v2.x/en/

Browse to https://rancher.mine.org

Happy Containering!</code></pre><p>当出现<strong>Happy Containering!</strong>的时候，就说明安装已经完成了。这时候可以通过以下命令进行测试：</p>
<pre><code>$ kubectl -n cattle-system rollout status deploy/rancher
// 输出以下内容时，可认为安装完成
Waiting for deployment &quot;rancher&quot; rollout to finish: 0 of 3 updated replicas are available...
deployment &quot;rancher&quot; successfully rolled out

// 查看服务状态
$ kubectl -n cattle-system get deploy rancher
NAME      DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
rancher   3         3         3            3           3m</code></pre><p>这样当Rancher安装完毕后，需要将私有的签名信息添加到Rancher集群的访问中。操作如下：</p>
<pre><code>$ kubectl -n cattle-system create secret tls tls-rancher-ingress --cert=rancher.mine.com.x4.crt --key=rancher.mine.com.key
// 输出下面的内容
secret/tls-rancher-ingress created</code></pre><p>证书生效后，创建tls-rancher-ingress，这样Rancher就可以在服务器内部被访问了。可以随便在232、239、241的服务器上执行：</p>
<pre><code>$ curl -L rancher.mine.com -k
// 可以出现JSON数据</code></pre><h3 id="五、Nginx负载均衡配置"><a href="#五、Nginx负载均衡配置" class="headerlink" title="五、Nginx负载均衡配置"></a>五、Nginx负载均衡配置</h3><h4 id="1-Nginx安装配置"><a href="#1-Nginx安装配置" class="headerlink" title="1. Nginx安装配置"></a>1. Nginx安装配置</h4><pre><code>// 安装nginx 

$ sudo yum install -y nginx

$ sudo systemctl enable nginx

// 将上面生成的证书拷贝到nginx安装目录下

$ cd /etc/nginx

$ sudo mkdir cert

$ sudo cp ~/nginx/rancher.mine.com.key /etc/nginx/cert

$ sudo cp ~/nginx/rancher.mine.com.x4.crt /etc/nginx/cert

// 修改配置文件如下
$ sudo mv nginx.conf nginx.conf.bak

$ sudo vim /etc/nginx/nginx.conf
// 将以下信息填入
user nginx;
worker_processes 4;
worker_rlimit_nofile 40000;

events {
    worker_connections 8192;
}

http {

    upstream rancher_servers {
        least_conn;
        server 192.168.238.232:80 max_fails=3 fail_timeout=5s;
        server 192.168.238.239:80 max_fails=3 fail_timeout=5s;
        server 192.168.238.241:80 max_fails=3 fail_timeout=5s;
    }

    map $http_upgrade $connection_upgrade {
        default Upgrade;
        &#39;&#39;      close;
    }

    gzip on;
    gzip_disable &quot;msie6&quot;;
    gzip_disable &quot;MSIE [1-6].(?!.*SV1)&quot;;
    gzip_vary on;
    gzip_static on;
    gzip_proxied any;
    gzip_min_length 0;
    gzip_comp_level 8;
    gzip_buffers 16 8k;
    gzip_http_version 1.1;
    gzip_types text/xml application/xml application/atom+xml application/rss+xml application/xhtml+xml image/svg+xml application/font-woff text/javascript application/javascript application/x-javascript text/x-json application/json application/x-web-app-manifest+json text/css text/plain text/x-component font/opentype application/x-font-ttf application/vnd.ms-fontobject font/woff2 image/x-icon image/png image/jpeg;
    server {
        listen         80;
        server_name    rancher.mine.com;
        rewrite ^(.*) https://$server_name$1 permanent;
    }

    server {
        listen     443 ssl;
        server_name    rancher.mine.com;
        ssl_certificate cert/rancher.mine.com.x4.crt;
        ssl_certificate_key cert/rancher.mine.com.key;
        ssl_session_timeout 5m;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
        ssl_prefer_server_ciphers on;
        location / {
            proxy_set_header Host $host;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Port $server_port;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass http://rancher_servers;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }
    }
}
// :wq进行保存后退出                                                 

// 测试nginx配置文件是否正常
$ sudo nginx -t
// 正常后重启Nginx服务
$ sudo systemctl restart nginx</code></pre><h4 id="2-设置hosts文件地址映射"><a href="#2-设置hosts文件地址映射" class="headerlink" title="2. 设置hosts文件地址映射"></a>2. 设置hosts文件地址映射</h4><p>rancher.com就是后面访问rancher的域名，需要在232、239、241服务器上的/etc/hosts文件中添加关联：</p>
<pre><code># echo &quot;192.168.238.240 rancher.mine.com&quot; &gt;&gt; /etc/hosts</code></pre><p>在你访问Rancher的web页面的机器上，也要配置hosts，例如在win10中，修改hosts文件，添加</p>
<pre><code>192.168.238.240 rancher.mine.com</code></pre><p>到文件末尾保存即可。这时打开浏览器，直接访问rancher.mine.com即可。如下图：</p>
<p>最后设置管理员账号密码即可，默认密码为admin，调整为我们常用的123456，完成。</p>
<p>后续登录的用户名为admin，密码为123456。地址为rancher.mine.com，记住一定设置host文件将ip和域名地址对应。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本次安装选择了较新的版本，一方面是屏蔽之前的bug，另一方面是该版本对于istio的支持较好，后续实施istio的时候可以比较方便。</p>
<h2 id="其它问题"><a href="#其它问题" class="headerlink" title="其它问题"></a>其它问题</h2><p>一、<strong>在后续运行的过程中，发现有部分服务始终处于CrashLoopBackOff的状态并且重启次数过多。</strong>如下：</p>
<pre><code>$ kubectl get pod -n cattle-system
NAME                                    READY   STATUS             RESTARTS   AGE
cattle-cluster-agent-568688f988-lfg6b   0/1     CrashLoopBackOff   627        3d3h
cattle-node-agent-8h4jg                 0/1     CrashLoopBackOff   888        3d3h
cattle-node-agent-9qthg                 0/1     CrashLoopBackOff   889        3d3h
cattle-node-agent-jp2rx                 0/1     CrashLoopBackOff   889        3d3h
rancher-7d769c47d6-9cdss                1/1     Running            2          3d22h
rancher-7d769c47d6-rn6kn                1/1     Running            1          3d22h
rancher-7d769c47d6-wrtbd                1/1     Running            1          3d22h</code></pre><p>并且有时在观察过程中node-agent或者cluster-agent处在Running状态，过一会儿又切换为CrashLoopBackOff。这时需要进一步进行排查。操作如下：</p>
<pre><code>$ kubectl logs -f cattle-cluster-agent-568688f988-lfg6b -n cattle-system
INFO: Environment: CATTLE_ADDRESS=10.42.2.4 CATTLE_CA_CHECKSUM= CATTLE_CLUSTER=true CATTLE_INTERNAL_ADDRESS= CATTLE_K8S_MANAGED=true CATTLE_NODE_NAME=cattle-cluster-agent-568688f988-lfg6b CATTLE_SERVER=https://rancher.mine.com
INFO: Using resolv.conf: nameserver 10.43.0.10 search cattle-system.svc.cluster.local svc.cluster.local cluster.local options ndots:5
ERROR: https://rancher.mine.com/ping is not accessible (Failed to connect to rancher.mine.com port 443: Connection timed out)</code></pre><p>cluster-agent并不能进行通讯，看到443问题，猜想是证书出了问题，随便查看一个node-agent的状态，如下：</p>
<pre><code>$ kubectl logs -f cattle-node-agent-9qthg -n cattle-system
INFO: Environment: CATTLE_ADDRESS=192.168.188.239 CATTLE_AGENT_CONNECT=true CATTLE_CA_CHECKSUM= CATTLE_CLUSTER=false CATTLE_INTERNAL_ADDRESS= CATTLE_K8S_MANAGED=true CATTLE_NODE_NAME=192.168.188.239 CATTLE_SERVER=https://rancher.mine.com
INFO: Using resolv.conf: nameserver 114.114.114.114 nameserver 8.8.8.8 nameserver 1.1.1.1
INFO: https://rancher.mine.com/ping is accessible
INFO: rancher.mine.com resolves to 192.168.188.240
time=&quot;2020-02-28T06:04:22Z&quot; level=info msg=&quot;Rancher agent version v2.3.5 is starting&quot;
time=&quot;2020-02-28T06:04:22Z&quot; level=info msg=&quot;Listening on /tmp/log.sock&quot;
time=&quot;2020-02-28T06:04:22Z&quot; level=info msg=&quot;Option customConfig=map[address:192.168.188.239 internalAddress: label:map[] roles:[] taints:[]]&quot;
time=&quot;2020-02-28T06:04:22Z&quot; level=info msg=&quot;Option etcd=false&quot;
time=&quot;2020-02-28T06:04:22Z&quot; level=info msg=&quot;Option controlPlane=false&quot;
time=&quot;2020-02-28T06:04:22Z&quot; level=info msg=&quot;Option worker=false&quot;
time=&quot;2020-02-28T06:04:22Z&quot; level=info msg=&quot;Option requestedHostname=192.168.188.239&quot;
time=&quot;2020-02-28T06:04:22Z&quot; level=info msg=&quot;Certificate details from https://rancher.mine.com&quot;
time=&quot;2020-02-28T06:04:22Z&quot; level=info msg=&quot;Certificate #0 (https://rancher.mine.com)&quot;
time=&quot;2020-02-28T06:04:22Z&quot; level=info msg=&quot;Subject: CN=*.rancher.mine.com,O=Default Company Ltd,L=Default City,C=CN&quot;
time=&quot;2020-02-28T06:04:22Z&quot; level=info msg=&quot;Issuer: CN=rancher.mine.com,O=Default Company Ltd,L=Default City,C=CN&quot;
time=&quot;2020-02-28T06:04:22Z&quot; level=info msg=&quot;IsCA: false&quot;
time=&quot;2020-02-28T06:04:22Z&quot; level=info msg=&quot;DNS Names: [*.rancher.mine.com rancher.mine.com]&quot;
time=&quot;2020-02-28T06:04:22Z&quot; level=info msg=&quot;IPAddresses: &lt;none&gt;&quot;
time=&quot;2020-02-28T06:04:22Z&quot; level=info msg=&quot;NotBefore: 2020-02-24 10:32:05 +0000 UTC&quot;
time=&quot;2020-02-28T06:04:22Z&quot; level=info msg=&quot;NotAfter: 2020-03-25 10:32:05 +0000 UTC&quot;
time=&quot;2020-02-28T06:04:22Z&quot; level=info msg=&quot;SignatureAlgorithm: SHA256-RSA&quot;
time=&quot;2020-02-28T06:04:22Z&quot; level=info msg=&quot;PublicKeyAlgorithm: RSA&quot;
time=&quot;2020-02-28T06:04:22Z&quot; level=fatal msg=&quot;Certificate chain is not complete, please check if all needed intermediate certificates are included in the server certificate (in the correct order) and if the cacerts setting in Rancher either contains the correct CA certificate (in the case of using self signed certificates) or is empty (in the case of using a certificate signed by a recognized CA). Certificate information is displayed above. error: Get https://rancher.mine.com: x509: certificate signed by unknown authority&quot;</code></pre><p>出现了x509问题，但是查询证书信息已经按照上面的教程导入了。如下：</p>
<pre><code>$ kubectl get secrets -n cattle-system
NAME                            TYPE                                  DATA   AGE
cattle-credentials-67b70c2      Opaque                                2      3d3h
cattle-token-r5q62              kubernetes.io/service-account-token   3      3d3h
default-token-hd9nl             kubernetes.io/service-account-token   3      3d23h
rancher-token-2kqn9             kubernetes.io/service-account-token   3      3d23h
sh.helm.release.v1.rancher.v1   helm.sh/release.v1                    1      3d23h
tls-rancher                     kubernetes.io/tls                     2      3d22h
tls-rancher-ingress             kubernetes.io/tls                     2      3d19h

$ kubectl describe secret tls-rancher-ingress -n cattle-system
Name:         tls-rancher-ingress
Namespace:    cattle-system
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Type:  kubernetes.io/tls

Data
====
tls.key:  1675 bytes
tls.crt:  1334 bytes</code></pre><p>临时不影响使用，rancher可以照常进行访问。但是在两天后，整个系统挂掉了。rancher页面在访问的时候报错了，所有rancher相关的docker镜像失败了。</p>
<p>尝试使用网上的方案解决，在命令行执行以下命令：</p>
<pre><code>$ kubectl  -n cattle-system \
patch deployments cattle-cluster-agent --patch &#39;{
    &quot;spec&quot;: {
        &quot;template&quot;: {
            &quot;spec&quot;: {
                &quot;hostAliases&quot;: [
                    {
                        &quot;hostnames&quot;:
                        [
                            &quot;rancher.mine.com&quot;
                        ],
                            &quot;ip&quot;: &quot;192.168.238.240&quot;
                    }
                ]
            }
        }
    }
}&#39;

$ kubectl -n cattle-system \
patch  daemonsets cattle-node-agent --patch &#39;{
    &quot;spec&quot;: {
        &quot;template&quot;: {
            &quot;spec&quot;: {
                &quot;hostAliases&quot;: [
                    {
                        &quot;hostnames&quot;:
                        [
                            &quot;rancher.mine.com&quot;
                        ],
                            &quot;ip&quot;: &quot;192.168.238.240&quot;
                    }
                ]
            }
        }
    }
}&#39;</code></pre><p>执行过后，agent相关的pod依旧在重启。</p>
<p>目前怀疑是证书的问题，现在通过重新签发证书，再进行操作。</p>
<p><strong>解决方案：</strong></p>
<ol>
<li><p>重新签发证书  </p>
<p> $ docker pull superseb/omgwtfssl</p>
<p> // 开始签发证书，将证书存储在/home/centos/nginx/new_cert路径中<br> $ docker run -v /home/centos/nginx/new_cert:/certs -e CA_SUBJECT=”mine-root-CA” -e CA_EXPIRE=”1825” -e SSL_EXPIRE=”365” -e SSL_SUBJECT=”rancher.mine.com” -e SSL_DNS=”rancher.mine.com” -e SILENT=”true” superseb/omgwtfssl</p>
<p> // 查看生成的证书信息<br> $ ls<br> ca-key.pem    ca.pem     ca.srl    cert.pem    key.csr    key.pem     openssl.cnf    secret.yaml</p>
<p> // 证书变更<br> $ cp ca.pem cacert.pem</p>
</li>
</ol>
<p>证书生成后，需要使用的是cacert.pem、cert.pem和key.pem这三个证书。</p>
<ol start="2">
<li><p>清理rancher安装，使用新的清理脚本，参考自：<a href="https://github.com/theAkito/rancher-helpers/blob/master/scripts/cleanup_rancher.sh" target="_blank" rel="noopener">https://github.com/theAkito/rancher-helpers/blob/master/scripts/cleanup_rancher.sh</a></p>
<p> $ vim clean-all.sh<br> // 在该文件中输入下面的信息</p>
<pre><code> #!/bin/bash
 #########################################################################
 # Copyright (C) 2019-2020 Akito &lt;the@akito.ooo&gt;                         #
 #                                                                       #
 # This program is free software: you can redistribute it and/or modify  #
 # it under the terms of the GNU General Public License as published by  #
 # the Free Software Foundation, either version 3 of the License, or     #
 # (at your option) any later version.                                   #
 #                                                                       #
 # This program is distributed in the hope that it will be useful,       #
 # but WITHOUT ANY WARRANTY; without even the implied warranty of        #
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the          #
 # GNU General Public License for more details.                          #
 #                                                                       #
 # You should have received a copy of the GNU General Public License     #
 # along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.  #
 #########################################################################
 # Based on
 # https://github.com/rancher/rancher/issues/19882#issuecomment-501056386

 ## Cleans up Rancher with Kubernetes *entirely*.
 ## After running this script you are able to
 ## set up Rancher entirely from scratch
 ## without any complaints about remains
 ## from the previous installation.

 ## Run as root!
 ## Only works reliably with GNU Bash.
 ## Expects `systemd` on the host.

 #################################   Boilerplate of the Boilerplate   ####################################################
 # Coloured Echoes                                                                                                       #
 function red_echo      { echo -e &quot;\033[31m$@\033[0m&quot;;   }                                                               #
 function green_echo    { echo -e &quot;\033[32m$@\033[0m&quot;;   }                                                               #
 function yellow_echo   { echo -e &quot;\033[33m$@\033[0m&quot;;   }                                                               #
 function white_echo    { echo -e &quot;\033[1;37m$@\033[0m&quot;; }                                                               #
 # Coloured Printfs                                                                                                      #
 function red_printf    { printf &quot;\033[31m$@\033[0m&quot;;    }                                                               #
 function green_printf  { printf &quot;\033[32m$@\033[0m&quot;;    }                                                               #
 function yellow_printf { printf &quot;\033[33m$@\033[0m&quot;;    }                                                               #
 function white_printf  { printf &quot;\033[1;37m$@\033[0m&quot;;  }                                                               #
 # Debugging Outputs                                                                                                     #
 function white_brackets { local args=&quot;$@&quot;; white_printf &quot;[&quot;; printf &quot;${args}&quot;; white_printf &quot;]&quot;; }                      #
 function echoInfo   { local args=&quot;$@&quot;; white_brackets $(green_printf &quot;INFO&quot;) &amp;&amp; echo &quot; ${args}&quot;; }                      #
 function echoWarn   { local args=&quot;$@&quot;;  echo &quot;$(white_brackets &quot;$(yellow_printf &quot;WARN&quot;)&quot; &amp;&amp; echo &quot; ${args}&quot;;)&quot; 1&gt;&amp;2; }  #
 function echoError  { local args=&quot;$@&quot;; echo &quot;$(white_brackets &quot;$(red_printf    &quot;ERROR&quot;)&quot; &amp;&amp; echo &quot; ${args}&quot;;)&quot; 1&gt;&amp;2; }  #
 # Silences commands&#39; STDOUT as well as STDERR.                                                                          #
 function silence { local args=&quot;$@&quot;; ${args} &amp;&gt;/dev/null; }                                                              #
 # Check your privilege.                                                                                                 #
 function checkPriv { if [[ &quot;$EUID&quot; != 0 ]]; then echoError &quot;Please run me as root.&quot;; exit 1; fi;  }                     #
 # Returns 0 if script is sourced, returns 1 if script is run in a subshell.                                             #
 function checkSrc { (return 0 2&gt;/dev/null); if [[ &quot;$?&quot; == 0 ]]; then return 0; else return 1; fi; }                     #
 # Prints directory the script is run from. Useful for local imports of BASH modules.                                    #
 # This only works if this function is defined in the actual script. So copy pasting is needed.                          #
 function whereAmI { printf &quot;$( cd &quot;$( dirname &quot;${BASH_SOURCE[0]}&quot; )&quot; &gt;/dev/null 2&gt;&amp;1 &amp;&amp; pwd )&quot;;   }                     #
 # Alternatively, this alias works in the sourcing script, but you need to enable alias expansion.                       #
 alias whereIsMe=&#39;printf &quot;$( cd &quot;$( dirname &quot;${BASH_SOURCE[0]}&quot; )&quot; &gt;/dev/null 2&gt;&amp;1 &amp;&amp; pwd )&quot;&#39;                            #
 #########################################################################################################################
 function containerd_restart { silence &quot;systemctl restart containerd&quot;; }
 function rmMetaDB { silence &quot;rm -f /var/lib/containerd/io.containerd.metadata.v1.bolt/meta.db&quot;; }
 function docker_start { silence &quot;systemctl start docker&quot;; }
 function docker_stop { silence &quot;systemctl stop docker&quot;; }
 function finish_line { white_printf &quot;OK\n&quot;; }
 function checkSys {
 ## Makes sure that script is not accidentally run on wrong target system.
 ## Exits if Docker is not installed.
 silence &quot;docker version&quot;
 if [[ $? == 0 ]]; then
     echoInfo &quot;Docker exists.&quot;
     return 0
 else
     echoError &quot;Docker not installed/running on system. Exiting.&quot;
     exit 1
 fi
 }
 function docker_restart {
 docker_stop
 echoInfo &quot;Restarting Docker...&quot;
 sleep 10;
 docker_start
 if [[ $? == 0 ]]; then
     echoInfo &quot;Docker restarted!&quot;
     return 0
 else
     echoError &quot;Docker restart failed!&quot;
     white_printf &quot;Manually stop docker then wait 20 seconds and start it again.\n&quot;
     exit 1
 fi
 }
 function rmContainers {
 ## Removes ALL containers.
 silence &quot;docker rm -f $(docker ps -aq)&quot; &amp;&amp; \
 echoInfo &quot;Successfully removed all Docker containers.&quot; || \
 echoInfo &quot;No Docker containers exist! Skipping.&quot;
 }
 function rmVolumes {
 ## Removes ALL volumes.
 silence &quot;docker volume rm $(docker volume ls -q)&quot; &amp;&amp; \
 echoInfo &quot;Successfully removed all Docker volumes.&quot; || \
 echoInfo &quot;No Docker volumes exist! Skipping.&quot;
 }
 function rmLocs {
 ## Removes all Rancher and Kubernetes related folders.
 declare -a FOLDERS
 FOLDERS=( &quot;/etc/ceph&quot; \
             &quot;/etc/cni&quot; \
             &quot;/etc/kubernetes&quot; \
             &quot;/opt/cni&quot; \
             &quot;/opt/rke&quot; \
             &quot;/run/secrets/kubernetes.io&quot; \
             &quot;/run/calico&quot; \
             &quot;/run/flannel&quot; \
             &quot;/var/lib/calico&quot; \
             &quot;/var/lib/etcd&quot; \
             &quot;/var/lib/cni&quot; \
             &quot;/var/lib/kubelet&quot; \
             &quot;/var/lib/rancher/rke/log&quot; \
             &quot;/var/log/containers&quot; \
             &quot;/var/log/pods&quot; \
             &quot;/var/run/calico&quot; \
         )
 for loc in &quot;${FOLDERS[@]}&quot;; do
     if [ -d ${loc} ]; then
     timeout 15s rm -fr ${loc} || \
         { \
         echoError   &quot;Timed out while trying to remove ${loc}.&quot;
         yellow_echo &quot;Run \&quot;rm -fr ${loc}\&quot; manually.&quot;
         exit 2
         }
     echoInfo &quot;${loc} successfully deleted.&quot;
     else
     echoInfo &quot;${loc} not found! Skipping.&quot;
     fi
 done
 ## Removes Rancher installation from default installation directory.
 local rancher_loc=&quot;/opt/rancher&quot;
 if [ -d ${rancher_loc} ]; then
     silence &quot;rm -fr /opt/rancher&quot; &amp;&amp; \
     echoInfo &quot;Rancher successfully removed from ${rancher_loc}.&quot; || \
     echoError &quot;Rancher could not be removed from ${rancher_loc}!&quot;
 else
     echoInfo &quot;Rancher not found in ${rancher_loc}! Skipping.&quot;
 fi
 }
 function cleanFirewall {
 ## Removes Firewall entries related to Rancher or Kubernetes.
 IPTABLES=&quot;/sbin/iptables&quot;
 cat /proc/net/ip_tables_names | while read table; do
     silence &quot;$IPTABLES -t $table -L -n&quot; | while read c chain rest; do
         if test &quot;X$c&quot; = &quot;XChain&quot; ; then
         silence &quot;$IPTABLES -t $table -F $chain&quot;
         fi
     done
     silence &quot;$IPTABLES -t $table -X&quot;
 done
 echoInfo &quot;Firewall rules cleared.&quot;
 }
 function rmDevs {
 ## Unmounts all Rancher and Kubernetes related virtual devices and volumes.
 fail_mount=false
 fail_pvc=false
 local -a mount_list=( $(mount | grep tmpfs | grep &#39;/var/lib/kubelet&#39; | awk &#39;{ print $3 }&#39;) )
 for mount in &quot;${mount_list[@]}&quot; /var/lib/kubelet /var/lib/rancher; do
     silence &quot;umount -f ${mount}&quot;
     if [[ $? ]]; then
     echoInfo  &quot;${mount} successfully unmounted.&quot;
     else
     echoError &quot;${mount} could not be unmounted.&quot;
     fi
 done
 ## Unmounts all Persistent Volume Claims, forcefully.
 local -a pvc_list=( $(mount | grep &#39;/var/lib/kubelet/pods&#39; | awk &#39;{ print $3 }&#39;) )
 for pvc in &quot;${pvc_list[@]}&quot;; do
     silence &quot;umount -f ${pvc}&quot;
     if [[ $? ]]; then
     echoInfo  &quot;$(printf ${pvc} | cut -c 1-45)... successfully unmounted.&quot;
     else
     echoError &quot;${pvc} could not be unmounted.&quot;
     fi
 done
 }
 function fazit {
 ## Checks for fail flags set during other processes and
 ## outputs a summary of possible errors.
 if   [[  $fail_mount == false ]] &amp;&amp; [[  $fail_pvc == false ]]; then
     :
 elif [[  $fail_mount == true ]] || [[  $fail_pvc == true ]]; then
     echoError &quot;Failed to unmount some volumes.&quot;
 fi
 }
 ############################################
 ############################################
 # Checks if user running the script is root.
 checkPriv
 # Makes sure that script is not accidentally run on wrong target system.
 # Exits if Docker is not installed.
 checkSys
 # Removes ALL containers.
 rmContainers
 # Removes ALL volumes.
 rmVolumes
 # Unmounts all Rancher and Kubernetes related virtual devices and volumes.
 rmDevs
 # Removes all Rancher and Kubernetes related folders.
 # Removes Rancher installation from default installation directory.
 rmLocs
 # Removes metadata database.
 rmMetaDB
 # Removes Firewall entries related to Rancher or Kubernetes.
 cleanFirewall
 # Restarts services, to apply previous removals.
 containerd_restart
 # Slowed down Docker restart. Needs a pause, because else it complains about &quot;too quick&quot; restarts.
 docker_restart
 # Checks for fail flags set during other processes and outputs a summary of possible errors.
 fazit
 # Process finished.
 finish_line</code></pre><p> // :wq对文件进行保存</p>
<p> $ sudo chmod +x clean-all.sh</p>
<p> // 执行清理操作，一定使用sudo提权<br> $ sudo ./clean-all.sh  </p>
</li>
<li><p>重新安装，制定证书信息 </p>
</li>
</ol>
<p>清理完成后，重新使用rke安装k8s，配置文件cluster.yml不变。可以拷贝到其它文件夹进行操作</p>
<pre><code>$ mkdir new_rancher

$ cd new_rancher/

// 拷贝到该文件夹
$ cp /home/centos/cluster/cluster.yml ./

// 执行配置文件
$ rke up --config ./cluster.yml</code></pre><p>当安装完成后，操作参考之前的步骤即可。验证安装后，等待10分钟左右，开始安装rancher集群。</p>
<pre><code>// 转到生成证书的文件夹
$ cd /home/centos/nginx/new_cert

// 创建namespace
$ kubectl create ns cattle-system

// 创建证书信息
$ kubectl -n cattle-system create secret tls tls-rancher-ingress --cert=./cert.pem --key=./key.pem

// 创建生成证书的根证书信息
$ kubectl -n cattle-system create secret generic tls-ca --from-file=cacerts.pem

// 执行新的安装方式，多了一个--set privateCA=true
$ helm install rancher rancher-stable/rancher\
      --namespace cattle-system \
      --set hostname=rancher.mine.com \
      --set ingress.tls.source=secret \
      --set privateCA=true</code></pre><p>这样就可以了。</p>
<ol start="4">
<li>nginx证书更换 </li>
</ol>
<p>需要将已有的证书拷贝到之前nginx证书所在的目录信息。</p>
<pre><code>$ sudo cp cert.pem /etc/nginx/cert/

$ sudo cp key.pem /etc/nginx/cert/

// 修改配置文件信息
$ sudo vim /etc/nginx/nginx.conf
// 找到ssl_certificate开头的内容进行修改
ssl_certificate cert/cert.pem;
ssl_certificate_key cert/key.pem;

// :wq保存退出

// 检测配置文件修改
$ sudo nginx -t

// 重启nginx
$ sudo systemctl restart nginx </code></pre><ol start="5">
<li><p>重新访问</p>
<p> // 使用curl进行访问<br> $ curl -L -k rancher.mine.com</p>
<p> // 输出json信息，已经可以了</p>
</li>
<li><p>重新设置环境变量</p>
</li>
</ol>
<p>由于配置文件的变更，需要更改kube_config_cluster.yml的新路径。由于cluster.yml有变更，生成了新的kube_config_cluster.yml文件。</p>
<pre><code>$ vim ~/.bashrc
// 将原来
// export KUBECONFIG=/home/centos/cluster/kube_config_cluster.conf
// 更改为
export KUBECONFIG=/home/centos/cluster/new_rancher/kube_config_cluster.conf

// :wq保存退出</code></pre><p>后续使用kubectl进行管理即可。</p>
<p>二、<strong>关于cattle-cluster-agent处于CrashLoopBackOff的问题</strong></p>
<pre><code>$ kubectl get pods -n cattle-system
NAME                                    READY   STATUS             RESTARTS   AGE
cattle-cluster-agent-85f4fcb5db-pwlgh   0/1     CrashLoopBackOff   23         147m
cattle-node-agent-2mt2z                 1/1     Running            0          147m
cattle-node-agent-c29zr                 1/1     Running            0          147m
cattle-node-agent-dzc7z                 1/1     Running            0          147m
rancher-7745c8fdbb-2x576                1/1     Running            2          164m
rancher-7745c8fdbb-kpdz2                1/1     Running            2          164m
rancher-7745c8fdbb-w2vxz                1/1     Running            0          164m

$ kubedescribe pod cattle-cluster-agent-85f4fcb5db-pwlghwlgh -n cattle-system
Name:         cattle-cluster-agent-85f4fcb5db-pwlgh
Namespace:    cattle-system
Priority:     0
Node:         192.168.123.232/192.168.123.232
Start Time:   Tue, 03 Mar 2020 14:58:49 +0800
Labels:       app=cattle-cluster-agent
            pod-template-hash=85f4fcb5db
Annotations:  cni.projectcalico.org/podIP: 10.42.2.5/32
Status:       Running
IP:           10.42.2.5
IPs:
IP:           10.42.2.5
Controlled By:  ReplicaSet/cattle-cluster-agent-85f4fcb5db
Containers:
cluster-register:
    Container ID:   docker://b6caca843298a2544fac374e28bbb8f9e1d901c7cad4b7b4915b40608ef1260b
    Image:          rancher/rancher-agent:v2.3.5
    Image ID:       docker-pullable://rancher/rancher-agent@sha256:e6aa36cca0d3ce9fea180add5b620baabd823fb34f9d100b7a8d3eb734392c37
    Port:           &lt;none&gt;
    Host Port:      &lt;none&gt;
    State:          Waiting
    Reason:       CrashLoopBackOff
    Last State:     Terminated
    Reason:       Error
    Exit Code:    1
    Started:      Tue, 03 Mar 2020 17:29:35 +0800
    Finished:     Tue, 03 Mar 2020 17:31:45 +0800
    Ready:          False
    Restart Count:  24
    Environment:
    CATTLE_SERVER:       https://rancher.icpcloud.com
    CATTLE_CA_CHECKSUM:  903483819f88d325eb730ee3017172cac4370a13b7bb1579b7a6373da2defc1e
    CATTLE_CLUSTER:      true
    CATTLE_K8S_MANAGED:  true
    Mounts:
    /cattle-credentials from cattle-credentials (ro)
    /var/run/secrets/kubernetes.io/serviceaccount from cattle-token-zrzb4 (ro)
Conditions:
Type              Status
Initialized       True
Ready             False
ContainersReady   False
PodScheduled      True
Volumes:
cattle-credentials:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  cattle-credentials-687d480
    Optional:    false
cattle-token-zrzb4:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  cattle-token-zrzb4
    Optional:    false
QoS Class:       BestEffort
Node-Selectors:  &lt;none&gt;
Tolerations:
Events:
Type     Reason   Age                    From                  Message
----     ------   ----                   ----                  -------
Warning  BackOff  3m4s (x444 over 147m)  kubelet, 192.168.123.232  Back-off restarting failed container
$ ssh -p 15555 centos@192.168.123.232
Last login: Tue Mar  3 16:04:54 2020 from k8s-rke-node-start
$ curl -k https://rancher.icpcloud.com/ping
pong

$ kubectl logs -f cattle-cluster-agent-85f4fcb5db-pwlgh -n cattle-system
INFO: Environment: CATTLE_ADDRESS=10.42.2.5 CATTLE_CA_CHECKSUM=903483819f88d325eb730ee3017172cac4370a13b7bb1579b7a6373da2defc1e CATTLE_CLUSTER=true CATTLE_INTERNAL_ADDRESS= CATTLE_K8S_MANAGED=true CATTLE_NODE_NAME=cattle-cluster-agent-85f4fcb5db-pwlgh CATTLE_SERVER=https://rancher.icpcloud.com
INFO: Using resolv.conf: nameserver 10.43.0.10 search cattle-system.svc.cluster.local svc.cluster.local cluster.local options ndots:5
ERROR: https://rancher.icpcloud.com/ping is not accessible (Failed to connect to rancher.icpcloud.com port 443: Connection timed out)</code></pre><p><strong>解决方案：</strong></p>
<p>利用kubectl edit命令进行修改：</p>
<pre><code>$ kubectl edit deploy/cattle-cluster-agent -n cattle-system
// 在出现的文本操作环境中，找到dnsPolicy: ClusterFirst选项，作如下修改
dnsPolicy: Default

// :wq保存退出

// 查看状态
$ kubectl get pods -n cattle-system
NAME                                    READY   STATUS        RESTARTS   AGE
cattle-cluster-agent-6c5485c4fc-vd6bm   1/1     Running       0          8s
cattle-cluster-agent-85f4fcb5db-pwlgh   1/1     Terminating   26         166m</code></pre><p>参考自：<a href="https://github.com/rancher/rancher/issues/16454#issuecomment-544621587" target="_blank" rel="noopener">https://github.com/rancher/rancher/issues/16454#issuecomment-544621587</a></p>
<p>三、关于kubernetes通过rke工具进行扩容的操作</p>
<p>这里提前准备两台服务器，一台是192.168.123.233，另一台是192.168.123.234。登录192.168.123.240服务器，然后执行下命令：</p>
<pre><code>// 转到部署文件所在的位置
$ cd ~/cluster/new_rancher

// 对配置文件进行备份
$ cp cluster.yml cluster.yml.bak

// 执行下更新功能
$ rke --debug up --config cluster.yml --update-only
</code></pre><p>执行成功后，最终提示：Finished building Kubernetes cluster successfully，说明已经完成。</p>
<p>随后修改cluster.yml文件，添加以下内容：</p>
<pre><code>- address: 192.168.123.233
  port: &quot;15555&quot;
  internal_address: &quot;&quot;
  role:
  - worker
  hostname_override: &quot;&quot;
  user: centos
  docker_socket: /var/run/docker.sock
  ssh_key: &quot;&quot;
  ssh_key_path: ~/.ssh/id_rsa
  ssh_cert: &quot;&quot;
  ssh_cert_path: &quot;&quot;
  labels: {}
  taints: []
- address: 192.168.123.234
  port: &quot;15555&quot;
  internal_address: &quot;&quot;
  role:
  - worker
  hostname_override: &quot;&quot;
  user: centos
  docker_socket: /var/run/docker.sock
  ssh_key: &quot;&quot;
  ssh_key_path: ~/.ssh/id_rsa
  ssh_cert: &quot;&quot;
  ssh_cert_path: &quot;&quot;
  labels: {}
  taints: []</code></pre><p>追加在192.168.123.241的配置信息之后，修改完成后保存退出，重新执行下面的命令：</p>
<pre><code>$ rke --debug up --config cluster.yml --update-only</code></pre><p>最终提示：Finished building Kubernetes cluster successfully，说明已经完成。</p>
<p>在一开始，不执行更新命令，直接修改cluster.yml，出现各种各样的问题，例如：</p>
<pre><code>1. Cannot connect to the Docker daemon at unix:/var/run/docker.sock. Is the docker daemon running?

2. docker: Error response from daemon: Conflict. The container name &quot;rke-log-linker&quot; is already in use

3. 节点连接不上
</code></pre><p>所以一定使用这个操作顺序进行增加节点！</p>
<h2 id="番外，清理脚本内容"><a href="#番外，清理脚本内容" class="headerlink" title="番外，清理脚本内容"></a>番外，清理脚本内容</h2><pre><code>
kubeadm reset
ifconfig cni0 down
ip link delete cni0
ifconfig flannel.1 down
ip link delete flannel.1
rm -rf /var/lib/cni/
</code></pre><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ul>
<li>官网安装文档：<a href="https://rancher.com/docs/rancher/v2.x/en/installation/" target="_blank" rel="noopener">https://rancher.com/docs/rancher/v2.x/en/installation/</a></li>
<li>新版本发布：<a href="https://www.cnblogs.com/rancherlabs/p/11956279.html" target="_blank" rel="noopener">https://www.cnblogs.com/rancherlabs/p/11956279.html</a></li>
<li>rancher中文社区：<a href="https://forums.cnrancher.com/" target="_blank" rel="noopener">https://forums.cnrancher.com/</a></li>
<li>部署文章：<a href="https://www.dazhuanlan.com/2019/10/25/5db2df23374e5/" target="_blank" rel="noopener">https://www.dazhuanlan.com/2019/10/25/5db2df23374e5/</a></li>
<li>部署文章：<a href="https://blog.51cto.com/bilibili/2440304" target="_blank" rel="noopener">https://blog.51cto.com/bilibili/2440304</a></li>
<li>部署文章：<a href="http://www.eryajf.net/2723.html" target="_blank" rel="noopener">http://www.eryajf.net/2723.html</a></li>
<li>部署文章：<a href="https://fs.tn/post/PmaL-uIiQ/" target="_blank" rel="noopener">https://fs.tn/post/PmaL-uIiQ/</a></li>
<li>k8s部署文章：<a href="https://www.pocketdigi.com/2019-09/install-k8s-in-china.html" target="_blank" rel="noopener">https://www.pocketdigi.com/2019-09/install-k8s-in-china.html</a></li>
<li>常见问题：<a href="http://blog.ponycool.com/archives/94.html" target="_blank" rel="noopener">http://blog.ponycool.com/archives/94.html</a></li>
<li>常见问题：<a href="https://blog.csdn.net/isea533/article/details/98172030" target="_blank" rel="noopener">https://blog.csdn.net/isea533/article/details/98172030</a></li>
<li>视频教程：<a href="https://space.bilibili.com/430496045?from=search&amp;seid=8060734016441754889" target="_blank" rel="noopener">https://space.bilibili.com/430496045?from=search&amp;seid=8060734016441754889</a></li>
<li>私有证书签发：<a href="https://linkscue.com/posts/2019-06-26-ca-and-self-signed-certificates/" target="_blank" rel="noopener">https://linkscue.com/posts/2019-06-26-ca-and-self-signed-certificates/</a></li>
<li>nginx证书安装：<a href="https://www.jianshu.com/p/02c25d0dd451" target="_blank" rel="noopener">https://www.jianshu.com/p/02c25d0dd451</a></li>
<li>付费文章，解决证书问题：<a href="https://blog.csdn.net/wxb880114/article/details/102787872" target="_blank" rel="noopener">https://blog.csdn.net/wxb880114/article/details/102787872</a></li>
<li>docker方式签发证书：<a href="https://medium.com/@superseb/zero-to-rancher-2-x-single-install-using-created-self-signed-certificates-in-5-minutes-5f9fe11fceb0" target="_blank" rel="noopener">https://medium.com/@superseb/zero-to-rancher-2-x-single-install-using-created-self-signed-certificates-in-5-minutes-5f9fe11fceb0</a></li>
</ul>

            </div>
            <hr />

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">写作不易，客官能否打赏一杯奶茶？</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《rancher集群化部署》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/2020/02/18/rancher-ji-qun-hua-bu-shu/" property="cc:attributionName"
               rel="cc:attributionURL">
                JamesLiAndroid
            </a> 采用
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    

    

    

    

    
    <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script> -->

<script>
    new Valine({
        el: '#vcomments',
        appId: '',
        appKey: '',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'false' === 'true',
        avatar: 'wavatar',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '如果你没有GitHub账号，还可以在这里评论啦！'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/02/19/guan-yu-docker-nei-jvm-nei-cun-hao-jin-dao-zhi-fu-wu-ting-ji-de-wen-ti-jie-jue/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/26.jpg" class="responsive-img" alt="关于docker内jvm内存耗尽导致服务停机的问题解决">
                        
                        <span class="card-title">关于docker内jvm内存耗尽导致服务停机的问题解决</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            关于docker内jvm内存耗尽导致服务停机的问题解决最开始的设置情况jvm设置参数如下：
-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap -XX:MaxR
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2020-02-19
                        </span>
                        <span class="publish-author">
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/02/12/k8s-fang-an-gui-hua/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/23.jpg" class="responsive-img" alt="k8s方案规划">
                        
                        <span class="card-title">k8s方案规划</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            k8s方案规划概述随着我们微服务开发的深入，从微服务的单一jar包部署转到了单一镜像部署模式，初步实现了CI/CD自动化流水线部署模式，能够极大的满足我们目前的开发方式。但是随着微服务数量的增加，运维的难度也在不断升高，bug的排除，请求的
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2020-02-12
                            </span>
                        <span class="publish-author">
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 时代与猫的脚步<br />'
            + '作者: JamesLiAndroid<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。感谢您的支持。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>

    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; 2019 WeiYang. All Rights Reserved.
            <a href="http://www.beian.miit.gov.cn">鲁ICP备17011350号</a>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">271.6k</span>
            

            <br>
            <span id="sitetime"></span>

            
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/JamesLiAndroid" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:lsy1234567@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="https://zhihu.com/people/li-tian-90-66" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-inverse">知</i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 80000;
        var uvcountOffset = 20000;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2020, 01, 28, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <script type="text/javascript"> var OriginTitile = document.title, st; document.addEventListener("visibilitychange", function () { document.hidden ? (document.title = "Σ(っ °Д °;)っ喔哟，崩溃啦！", clearTimeout(st)) : (document.title = "φ(゜▽゜*)♪咦，又好了！", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) })
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->



    
    <script src="/libs/others/clicklove.js"></script>
    

    

    <!-- 雪花特效 -->
    

</body>

</html>