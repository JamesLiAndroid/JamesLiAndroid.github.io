<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="keywords" content="k8s一阶段学习记录, Java Android Python DevOps JamesLiAndroid 小李 运维 ">
    <meta name="baidu-site-verification" content>
    <meta name="google-site-verification" content>
    <meta name="360-site-verification" content>
    <meta name="description" content="k8s学习
第一章 kubeadm方式安装k8s集群
安装部分

安装前注意：

不要使用中文目录或者克隆过的虚拟机（网卡问题）
生产环境建议使用二进制安装
VIP不要和内网ip地址重复，需要和主机ip在同一个局域网段内

1.1 容器化安">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>k8s一阶段学习记录 | 时代与猫的脚步</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
    <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
    <script>
        var _hmt = _hmt || [];
        (function () {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?46e79e71af0709a5b9106bf20cecc493";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>

<body>

    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">时代与猫的脚步</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/contact" class="waves-effect waves-light">
            
            <span>留言板</span>
        </a>
    </li>
    
    <li>
        <a href="#searchModal" class="modal-trigger waves-effect waves-light">
            <i id="searchIcon" class="fa fa-search" title="搜索"></i>
        </a>
    </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">时代与猫的脚步</div>
        <div class="logo-desc">
            
            山东理工大学 | 电子信息工程
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                友情链接
            </a>
        </li>
        
        <li>
            <a href="/contact" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-link"></i>
                
                留言板
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/JamesLiAndroid" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>

        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/JamesLiAndroid" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    
<script src="/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/7.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        k8s一阶段学习记录
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 20px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        <span class="chip bg-color">无标签</span>
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2021-03-19
                </div>

                <div class="post-author info-break-policy">
                    <i class="fa fa-user-o fa-fw"></i>作者:&nbsp;&nbsp;
                    
                    JamesLiAndroid
                    
                </div>

                
                
                <div class="info-break-policy">
                    <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                    32.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    157 分
                </div>
                
                

                
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <p>k8s学习</p>
<h2 id="第一章-kubeadm方式安装k8s集群"><a href="#第一章-kubeadm方式安装k8s集群" class="headerlink" title="第一章 kubeadm方式安装k8s集群"></a>第一章 kubeadm方式安装k8s集群</h2><ol>
<li>安装部分</li>
</ol>
<p>安装前注意：</p>
<ol>
<li>不要使用中文目录或者克隆过的虚拟机（网卡问题）</li>
<li>生产环境建议使用二进制安装</li>
<li>VIP不要和内网ip地址重复，需要和主机ip在同一个局域网段内</li>
</ol>
<p>1.1 容器化安装</p>
<p>第一部分：初始化</p>
<p>修改各个机器的名称</p>
<pre><code># hostnamectl set-hostname k8s-master-01
</code></pre><p>在所有机器上同步执行</p>
<pre><code># vim /etc/hosts

192.168.229.51 k8s-master-01
192.168.229.52 k8s-master-02
192.168.229.53 k8s-master-03
192.168.229.60 k8s-master-lb
192.168.229.54 k8s-node-01
192.168.229.55 k8s-node-02
</code></pre><p>修改yum源</p>
<pre><code>mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak

wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo

yum install -y yum-utils \
                    device-mapper-persistent-data \
                    lvm2

yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg
       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF


sed -i -e &#39;/mirrors.cloud.aliyuncs.com/d&#39; -e &#39;/mirrors.aliyuncs.com/d&#39; /etc/yum.repos.d/CentOS-Base.repo

yum update -y --exclude=kernel* 
</code></pre><p>安装必备工具</p>
<pre><code>yum install -y wget git unzip net-tools curl vim telnet psmisc  tree sshpass jq</code></pre><p>关闭防火墙，selinux、dnsmasq、NetworkManager</p>
<pre><code>systemctl disable --now firewalld
systemctl disable --now dnsmasq
systemctl disable --now NetworkManager

setenforce 0
sed -i &#39;s#SELINUX=enforcing#SELINUX=disabled#g&#39; /etc/sysconfig/selinux
sed -i &#39;s#SELINUX=enforcing#SELINUX=disabled#g&#39; /etc/selinux/config
</code></pre><p>注意：selinux关闭时必须两个同时修改</p>
<p>关闭swap分区<br>swapoff -a &amp;&amp; sysctl -w vm.swappiness=0<br>sed -ri ‘/^[^#]*swap/s@^@#@’ /etc/fstab</p>
<p>时钟同步,时钟不一致可能会导致证书出现问题</p>
<p>rpm -ivh <a href="http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm" target="_blank" rel="noopener">http://mirrors.wlnmp.com/centos/wlnmp-release-centos.noarch.rpm</a><br>yum install ntpdate -y</p>
<p>设置时区<br>ln -df /usr/share/zoneinfo/Asia/Shanghai /etc/localtime<br>echo ‘Asia/Shanghai’ &gt; /etc/timezone<br>ntpdate time2.aliyun.com<br>crontab -e<br>*/5 * * * * ntpdate time2.aliyun.com</p>
<p>临时设置ulimit<br>ulimit -SHn 65535</p>
<p>永久生效方式<br>vim /etc/security/limits.conf</p>
<ul>
<li>soft nofile 655360</li>
<li>hard nofile 131072</li>
<li>soft nproc 655350</li>
<li>hard nproc 655350</li>
<li>soft memlock unlimited</li>
<li>hard memlock unlimited</li>
</ul>
<p>在master01上生成证书并传输到其它机器上</p>
<p>ssh-keygen -t rsa<br>for i in k8s-master-02 k8s-master-03 k8s-node-01 k8s-node-02; do ssh-copy-id -i /root/.ssh/id_rsa.pub $i;done</p>
<p>第二部分：内核配置</p>
<p>更新并重启机器，排除内核信息<br>yum update -y –exclude=kernel* &amp;&amp; reboot</p>
<p>在生产环境中必须进行内核升级，CentOS 7需要内核版本在4.18+。 这里使用4.19版本</p>
<p>cd /root<br>wget <a href="http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm" target="_blank" rel="noopener">http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm</a><br>wget <a href="http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm" target="_blank" rel="noopener">http://193.49.22.109/elrepo/kernel/el7/x86_64/RPMS/kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm</a></p>
<p>可以使用idm下载后再上传到各个服务器上。</p>
<p>将内核文件传输到各个机器上<br>for i in k8s-master-02 k8s-master-03 k8s-node-01 k8s-node-02; do scp kernel-ml-4.19.12-1.el7.elrepo.x86_64.rpm kernel-ml-devel-4.19.12-1.el7.elrepo.x86_64.rpm $i:/root/ ;done</p>
<p>批量在各个机器上执行以下命令<br>cd /root/ &amp;&amp; yum localinstall kernel-ml* -y</p>
<p>更改内核启动顺序<br>grub2-set-default 0 &amp;&amp; grub2-mkconfig -o /etc/grub2.cfg<br>grubby –args=”user_namespace.enable=1” –update-kernel=”$(grubby –default-kernel)”</p>
<p>检查内核版本<br>grubby –default-kernel<br>/boot/vmlinuz-4.19.12-1.el7.elrepo.x86_64</p>
<p>所有节点重启，再检查内核信息</p>
<p>第三部分：安装ipvs工具</p>
<p>生产环境中推荐使用ipvs工具，不推荐使用iptables<br>yum install ipvsadm ipset sysstat conntrack libseccomp -y</p>
<p>所有内核节点配置ipvs模块，4.19+版本内核需要把nf_conntrack_ipv4更改为nf_conntrack，4.18及以下可以继续使用。<br>vim /etc/modules-load.d/ipvs.conf<br>//添加<br>ip_vs<br>ip_vs_lc<br>ip_vs_wlc<br>ip_vs_rr<br>ip_vs_wrr<br>ip_vs_lbtc<br>ip_vs_lblcr<br>ip_vs_dh<br>ip_vs_sh<br>ip_vs_fo<br>ip_vs_nq<br>ip_vs_sed<br>ip_vs_ftp<br>ip_vs_sh<br>nf_conntrack<br>ip_tables<br>ip_set<br>xt_set<br>ipt_set<br>ipt_rpfilter<br>ipt_REJECT<br>ipip</p>
<p>systemctl enable –now systemd-modules-load.service</p>
<p>注意：ip_vs_lbtc这个配置项可能导致无法启动systemd-modules-load.service。</p>
<p>// 校验是否开启，如果无输出信息，需要重启机器<br>lsmod | grep -e ip_vs -e nf_conntrack</p>
<p>开启内核参数</p>
<p>cat &gt;&gt; /etc/sysctl.d/k8s.conf&lt;&lt;EOF<br>net.ipv4.ip_forward=1<br>net.bridge.bridge-nf-call-iptables=1<br>net.bridge.bridge-nf-call-ip6tables=1<br>fs.may_datch_mounts=1<br>vm.overcommit_memory=1<br>vm.panic_on_oom=1<br>fs.inotify.max_user_watches=89100<br>fs.file-max=52706963<br>fs.nr_open=52706963<br>net.netfilter.nf_conntrack_max=2310720</p>
<p>net.ipv4.tcp_keepalive_time=600<br>net.ipv4.tcp_keepalive_probes=3<br>net.ipv4.tcp_keepalive_intvl=15<br>net.ipv4.tcp_max_tw_buckets=36000<br>net.ipv4.tcp_tw_reuse=1<br>net.ipv4.tcp_max_orphans=327680<br>net.ipv4.tcp_orphan_retries=3<br>net.ipv4.tcp_syncookies=1<br>net.ipv4.tcp_max_syn_backlog=16384<br>net.ipv4.ip_conntrack_max=65536<br>net.ipv4.tcp_timestamps=0<br>net.core.somaxconn=16384<br>EOF</p>
<p>sysctl –system</p>
<p>重启后进行验证<br>lsmod | grep -e ip_vs -e nf_conntrack<br>ip_vs_ftp              16384  0<br>nf_nat                 32768  1 ip_vs_ftp<br>ip_vs_sed              16384  0<br>ip_vs_nq               16384  0<br>ip_vs_fo               16384  0<br>ip_vs_sh               16384  0<br>ip_vs_dh               16384  0<br>ip_vs_lblcr            16384  0<br>ip_vs_wrr              16384  0<br>ip_vs_rr               16384  0<br>ip_vs_wlc              16384  0<br>ip_vs_lc               16384  0<br>ip_vs                 151552  22 ip_vs_wlc,ip_vs_rr,ip_vs_dh,ip_vs_lblcr,ip_vs_sh,ip_vs_fo,ip_vs_nq,ip_vs_wrr,ip_vs_lc,ip_vs_sed,ip_vs_ftp<br>nf_conntrack          143360  2 nf_nat,ip_vs<br>nf_defrag_ipv6         20480  1 nf_conntrack<br>nf_defrag_ipv4         16384  1 nf_conntrack<br>libcrc32c              16384  4 nf_conntrack,nf_nat,xfs,ip_vs</p>
<p>第四部分：docker以及kubenetes组件安装</p>
<p>安装docker<br>yum install docker-ce-19.03.* -y</p>
<p>修改cgroup运行方式<br>mkdir /etc/docker<br>cat &gt; /etc/docker/daemon.json &lt;&lt;EOF<br>{<br>    “exec-opts”: [“native.cgroupdriver=systemd”]<br>}<br>EOF</p>
<p>systemctl daemon-reload &amp;&amp; systemctl enable –now docker</p>
<p>安装k8s组件</p>
<p>注意，版本号后面小版本大于5时再去选择使用该版本运行在生产环境中，例如1.18.9、1.19.5这样版本，尽量不要选择如1.19.1、1.18.3这样的版本。</p>
<p>查看最新版本的组件信息<br>yum list kubeadm –showduplicates |sort -r</p>
<p>安装kubeadm<br>yum install kubeadm -y</p>
<p>安装完成后，需要进行设置。注意：–cgroup-driver 一定要指定为和docker相同的systemd，否则容易导致k8s无法启动。</p>
<p>默认配置的pause镜像使用gcr.io仓库，国内访问科学上网问题，需要配置使用阿里云的镜像。</p>
<p>cat &gt;/etc/sysconfig/kubelet&lt;&lt;EOF<br>KUBELET_EXTRA_ARGS=”–cgroup-driver=systemd –pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause-amd64:3.2”<br>EOF</p>
<p>配置开机启动。未初始化之前可能存在启动失败的问题，临时不需要关心，由于kubelet没有配置文件，所以无法启动，待初始化后可用<br>systemctl daemon-reload &amp;&amp; systemctl enable –now kubelet</p>
<p>第五部分：高可用组件安装</p>
<p>下面操作针对所有master节点，进行安装。</p>
<p>安装HAProxy和keepalived</p>
<p>yum install haproxy keepalived -y</p>
<p>编写HAProxy的配置文件，三个节点的配置文件相同</p>
<p>vim /etc/haproxy/haproxy.cfg</p>
<p>#———————————————————————<br>defaults<br>    mode                    http<br>    log                     global<br>    option                  httplog<br>    timeout http-request    15s<br>    timeout connect         5000<br>    timeout client          50000<br>    timeout server          50000<br>    timeout http-keep-alive 15s</p>
<p>#———————————————————————</p>
<h1 id="main-frontend-which-proxys-to-the-backends"><a href="#main-frontend-which-proxys-to-the-backends" class="headerlink" title="main frontend which proxys to the backends"></a>main frontend which proxys to the backends</h1><p>#———————————————————————<br>frontend monitor-in<br>    bind *:33305<br>    mode http<br>    option httplog<br>    monitor-uri /monitor</p>
<p>frontend k8s-master<br>    bind 0.0.0.0:16443<br>    bind 127.0.0.1:16443<br>    mode tcp<br>    option tcplog<br>    tcp-request inspect-delay 5s<br>    default_backend k8s-master</p>
<p>#———————————————————————</p>
<h1 id="round-robin-balancing-between-the-various-backends"><a href="#round-robin-balancing-between-the-various-backends" class="headerlink" title="round robin balancing between the various backends"></a>round robin balancing between the various backends</h1><p>#———————————————————————<br>backend k8s-master<br>    mode tcp<br>    option tcplog<br>    option tcp-check<br>    balance roundrobin<br>    default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100<br>    server  k8s-master01 192.168.229.51:6443 check<br>    server  k8s-master02 192.168.229.52:6443 check<br>    server  k8s-master03 192.168.229.53:6443 check</p>
<p>编写keepalived的配置，注意区分每个节点的ip地址和网卡信息：</p>
<p>vim /etc/keepalived/keepalived.conf<br>! Configuration File for keepalived</p>
<p>global_defs {<br>   router_id LVS_DEVEL<br>   script_user root<br>   enable_script_security<br>}</p>
<p>vrrp_script chk_apiserver {<br>   script “/etc/keepalived/check_apiserver.sh”<br>   interval 5<br>   weight -5<br>   fall 2<br>   rise 1<br>}</p>
<p>vrrp_instance VI_1 {<br>    state MASTER<br>    interface ens33               # 这个位置为网卡信息，需要更改<br>    mcast_src_ip 192.168.229.51   # 这个位置是宿主机的真实IP地址，需要更改<br>    virtual_router_id 51<br>    priority 101<br>    advert_int 2<br>    authentication {<br>        auth_type PASS<br>        auth_pass K8SHA_KA_AUTH<br>    }<br>    virtual_ipaddress {<br>        192.168.229.60    # 注意这个位置是设置的VIP<br>    }<br>    track_script {<br>        chk_apiserver<br>    }<br>}</p>
<p>注意健康检查track_script部分要打开。</p>
<p>所有的master节点需要配置keepalived的健康检查脚本</p>
<p>vim /etc/keepalived/check_apiserver.sh</p>
<p>#!/bin/bash</p>
<p>err=0<br>for i in $(seq 1 3)<br>do<br>  check_code=$(pgrep haproxy)<br>  if [[ $check_code == “” ]]; then<br>    err=$(expr $err+1)<br>    sleep 1<br>    continue<br>  else<br>    err=0<br>    break<br>  fi<br>done</p>
<p>if [[ $err != “0” ]]; then<br>  echo “systemctl stop keepalived”<br>  /usr/bin/systemctl stop keepalived<br>  exit 1<br>else<br>  exit 0<br>fi</p>
<p>赋予脚本可执行权限<br>chmod +x /etc/keepalived/check_apiserver.sh</p>
<p>启动haproxy和keepalived<br>systemctl daemon-reload &amp;&amp; systemctl enable –now haproxy &amp;&amp; keepalived</p>
<p>查看生效状况<br>ip addr | grep 60<br>    inet 192.168.229.60/32 scope global ens33<br>    inet6 fe80::20c:29ff:febf:7608/64 scope link</p>
<p>telnet 192.168.229.51 16443<br>Trying 192.168.229.51…<br>Connected to 192.168.229.51.<br>Escape character is ‘^]’.<br>Connection closed by foreign host.</p>
<p>问题排查：VIP ping不通，而且telnet没有出现]标志<br>查看keepalived 是否存在问题，查看keepalived运行状态，查看selinux、haproxy和keepalived的状态和监听端口</p>
<p>第五部分：集群初始化</p>
<p>下面的命令在master节点上执行</p>
<p>创建kubeadm初始化的yaml文件，最好使用配置文件去执行，否则使用命令时指定的参数过多容易导致执行失败。</p>
<p>vim kubeadm-config.yaml</p>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubeadm.k8s.io/v1beta2
<span class="token comment" spellcheck="true"># 设置加入集群的token信息，24小时内有效，过期后需要处理</span>
<span class="token key atrule">bootstrapTokens</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">groups</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> system<span class="token punctuation">:</span>bootstrappers<span class="token punctuation">:</span>kubeadm<span class="token punctuation">:</span>default<span class="token punctuation">-</span>node<span class="token punctuation">-</span>token
  <span class="token key atrule">token</span><span class="token punctuation">:</span> 7t2weq.bjbawausm0jaxury
  <span class="token key atrule">ttl</span><span class="token punctuation">:</span> 24h0m0s
  <span class="token key atrule">usages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> signing
  <span class="token punctuation">-</span> authentication 
<span class="token key atrule">kind</span><span class="token punctuation">:</span> InitConfiguration
<span class="token comment" spellcheck="true"># 本机信息配置，ip地址需要配置为本机的ip地址</span>
<span class="token key atrule">localAPIEndpoint</span><span class="token punctuation">:</span>
  <span class="token key atrule">advertiseAddress</span><span class="token punctuation">:</span> 192.168.229.51
  <span class="token key atrule">bindPort</span><span class="token punctuation">:</span> <span class="token number">6443</span>
<span class="token key atrule">nodeRegistration</span><span class="token punctuation">:</span>
  <span class="token key atrule">criSocket</span><span class="token punctuation">:</span> /var/run/dockershim.sock
  <span class="token key atrule">name</span><span class="token punctuation">:</span> k8s<span class="token punctuation">-</span>master<span class="token punctuation">-</span><span class="token number">01</span>
  <span class="token comment" spellcheck="true"># 添加一个容忍，配置master节点不允许部署容器</span>
  <span class="token key atrule">taints</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
    <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubenetes.io/master
<span class="token punctuation">---</span>
<span class="token key atrule">apiServer</span><span class="token punctuation">:</span>
  <span class="token key atrule">certSANs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> 192.168.229.60
  <span class="token key atrule">timeoutForControlPlane</span><span class="token punctuation">:</span> 4m0s
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> kubeadm.k8s.io/v1beta2
<span class="token key atrule">certificatesDir</span><span class="token punctuation">:</span> /etc/kubernetes/pki
<span class="token key atrule">clusterName</span><span class="token punctuation">:</span> kubernetes
<span class="token key atrule">controlPlaneEndpoint</span><span class="token punctuation">:</span> 192.168.229.60<span class="token punctuation">:</span><span class="token number">16443</span>
<span class="token key atrule">controllerManager</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token key atrule">dns</span><span class="token punctuation">:</span> 
  <span class="token key atrule">type</span><span class="token punctuation">:</span> CoreDNS
<span class="token key atrule">etcd</span><span class="token punctuation">:</span>
  <span class="token key atrule">local</span><span class="token punctuation">:</span>    
    <span class="token key atrule">dataDir</span><span class="token punctuation">:</span> /var/lib/etcd
<span class="token key atrule">imageRepository</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>hangzhou.aliyuncs.com/google_containers
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterConfiguration
<span class="token key atrule">kubernetesVersion</span><span class="token punctuation">:</span> v1.20.1
<span class="token key atrule">networking</span><span class="token punctuation">:</span> 
  <span class="token key atrule">dnsDomain</span><span class="token punctuation">:</span> cluster.local  
  <span class="token key atrule">podSubnet</span><span class="token punctuation">:</span> 172.168.0.0/12
  <span class="token key atrule">serviceSubnet</span><span class="token punctuation">:</span> 10.96.0.0/12
<span class="token key atrule">scheduler</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>更新kubadm-config.yaml<br>kubeadm config migrate –old-config kubeadm-config.yaml –new-config new.yaml</p>
<p>更新完成后将其它文件复制到其它master节点<br>for i in k8s-master-02 k8s-master-03 ; do scp new.yaml $i:/root/ ;done</p>
<p>下载镜像<br>kubeadm config images pull –config /root/new.yaml</p>
<p>在master01节点执行k8s集群的初始化<br>kubeadm init –config /root/new.yaml –upload-certs</p>
<p>[init] Using Kubernetes version: v1.20.1<br>[preflight] Running pre-flight checks<br>[preflight] Pulling images required for setting up a Kubernetes cluster<br>[preflight] This might take a minute or two, depending on the speed of your internet connection<br>[preflight] You can also perform this action in beforehand using ‘kubeadm config images pull’<br>[certs] Using certificateDir folder “/etc/kubernetes/pki”<br>[certs] Generating “ca” certificate and key<br>[certs] Generating “apiserver” certificate and key<br>[certs] apiserver serving cert is signed for DNS names [k8s-master-01 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 192.168.229.51 192.168.229.60]<br>[certs] Generating “apiserver-kubelet-client” certificate and key<br>[certs] Generating “front-proxy-ca” certificate and key<br>[certs] Generating “front-proxy-client” certificate and key<br>[certs] Generating “etcd/ca” certificate and key<br>[certs] Generating “etcd/server” certificate and key<br>[certs] etcd/server serving cert is signed for DNS names [k8s-master-01 localhost] and IPs [192.168.229.51 127.0.0.1 ::1]<br>[certs] Generating “etcd/peer” certificate and key<br>[certs] etcd/peer serving cert is signed for DNS names [k8s-master-01 localhost] and IPs [192.168.229.51 127.0.0.1 ::1]<br>[certs] Generating “etcd/healthcheck-client” certificate and key<br>[certs] Generating “apiserver-etcd-client” certificate and key<br>[certs] Generating “sa” key and public key<br>[kubeconfig] Using kubeconfig folder “/etc/kubernetes”<br>[endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address<br>[kubeconfig] Writing “admin.conf” kubeconfig file<br>[endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address<br>[kubeconfig] Writing “kubelet.conf” kubeconfig file<br>[endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address<br>[kubeconfig] Writing “controller-manager.conf” kubeconfig file<br>[endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address<br>[kubeconfig] Writing “scheduler.conf” kubeconfig file<br>[kubelet-start] Writing kubelet environment file with flags to file “/var/lib/kubelet/kubeadm-flags.env”<br>[kubelet-start] Writing kubelet configuration to file “/var/lib/kubelet/config.yaml”<br>[kubelet-start] Starting the kubelet<br>[control-plane] Using manifest folder “/etc/kubernetes/manifests”<br>[control-plane] Creating static Pod manifest for “kube-apiserver”<br>[control-plane] Creating static Pod manifest for “kube-controller-manager”<br>[control-plane] Creating static Pod manifest for “kube-scheduler”<br>[etcd] Creating static Pod manifest for local etcd in “/etc/kubernetes/manifests”<br>[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory “/etc/kubernetes/manifests”. This can take up to 4m0s<br>[apiclient] All control plane components are healthy after 30.040077 seconds<br>[upload-config] Storing the configuration used in ConfigMap “kubeadm-config” in the “kube-system” Namespace<br>[kubelet] Creating a ConfigMap “kubelet-config-1.20” in namespace kube-system with the configuration for the kubelets in the cluster<br>[upload-certs] Storing the certificates in Secret “kubeadm-certs” in the “kube-system” Namespace<br>[upload-certs] Using certificate key:<br>afe317744fa848eceadb7df6960133e77c96f9c282656d361706b7e515a4286f<br>[mark-control-plane] Marking the node k8s-master-01 as control-plane by adding the labels “node-role.kubernetes.io/master=’’” and “node-role.kubernetes.io/control-plane=’’ (deprecated)”<br>[mark-control-plane] Marking the node k8s-master-01 as control-plane by adding the taints [node-role.kubemetes.io/naster:NoSchedule]<br>[bootstrap-token] Using token: 7t2weq.bjbawausm0jaxury<br>[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles<br>[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get nodes<br>[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials<br>[bootstrap-token] configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token<br>[bootstrap-token] configured RBAC rules to allow certificate rotation for all node client certificates in the cluster<br>[bootstrap-token] Creating the “cluster-info” ConfigMap in the “kube-public” namespace<br>[kubelet-finalize] Updating “/etc/kubernetes/kubelet.conf” to point to a rotatable kubelet client certificate and key<br>[addons] Applied essential addon: CoreDNS<br>[endpoint] WARNING: port specified in controlPlaneEndpoint overrides bindPort in the controlplane address<br>[addons] Applied essential addon: kube-proxy</p>
<p>Your Kubernetes control-plane has initialized successfully!</p>
<p>To start using your cluster, you need to run the following as a regular user:</p>
<p>  mkdir -p $HOME/.kube<br>  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config<br>  sudo chown $(id -u):$(id -g) $HOME/.kube/config</p>
<p>Alternatively, if you are the root user, you can run:</p>
<p>  export KUBECONFIG=/etc/kubernetes/admin.conf</p>
<p>You should now deploy a pod network to the cluster.<br>Run “kubectl apply -f [podnetwork].yaml” with one of the options listed at:<br>  <a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/" target="_blank" rel="noopener">https://kubernetes.io/docs/concepts/cluster-administration/addons/</a></p>
<p>You can now join any number of the control-plane node running the following command on each as root:</p>
<p>  kubeadm join 192.168.229.60:16443 –token 7t2weq.bjbawausm0jaxury <br>    –discovery-token-ca-cert-hash sha256:246203ceb832292331df2fedae4e1db305859ce79cab901873d4410af5403242 <br>    –control-plane –certificate-key afe317744fa848eceadb7df6960133e77c96f9c282656d361706b7e515a4286f</p>
<p>Please note that the certificate-key gives access to cluster sensitive data, keep it secret!<br>As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use<br>“kubeadm init phase upload-certs –upload-certs” to reload certs afterward.</p>
<p>Then you can join any number of worker nodes by running the following on each as root:</p>
<p>kubeadm join 192.168.229.60:16443 –token 7t2weq.bjbawausm0jaxury <br>    –discovery-token-ca-cert-hash sha256:246203ceb832292331df2fedae4e1db305859ce79cab901873d4410af5403242</p>
<p>在master01节点配置环境变量，用于访问kubernetes集群：<br>cat &lt;<eof>&gt; /root/.bashrc<br>export KUBECONFIG=/etc/kubernetes/admin.conf<br>EOF</eof></p>
<p>source /root/.bashrc</p>
<p>这时候配置完成，可以使用kubectl命令来进行集群的管理<br>kubectl get node<br>NAME            STATUS     ROLES                  AGE     VERSION<br>k8s-master-01   NotReady   control-plane,master   4m36s   v1.20.1</p>
<p>kubectl get svc<br>NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE<br>kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   5m12s</none></p>
<p>kubectl get pod -n kube-system -o wide<br>NAME                                    READY   STATUS    RESTARTS   AGE     IP               NODE            NOMINATED NODE   READINESS GATES<br>coredns-54d67798b7-66z7x                0/1     Pending   0          6m27s   <none>           <none>          <none>           <none><br>coredns-54d67798b7-jzql9                0/1     Pending   0          6m27s   <none>           <none>          <none>           <none><br>etcd-k8s-master-01                      1/1     Running   0          6m21s   192.168.229.51   k8s-master-01   <none>           <none><br>kube-apiserver-k8s-master-01            1/1     Running   0          6m21s   192.168.229.51   k8s-master-01   <none>           <none><br>kube-controller-manager-k8s-master-01   1/1     Running   0          6m21s   192.168.229.51   k8s-master-01   <none>           <none><br>kube-proxy-pqh28                        1/1     Running   0          6m26s   192.168.229.51   k8s-master-01   <none>           <none><br>kube-scheduler-k8s-master-01            1/1     Running   0          6m21s   192.168.229.51   k8s-master-01   <none>           <none></none></none></none></none></none></none></none></none></none></none></none></none></none></none></none></none></none></none></p>
<p>第六部分：master节点高可用</p>
<p>注意master节点加入命令和node节点加入命令有所不同</p>
<p>master节点加入命令：</p>
<p>  kubeadm join 192.168.229.60:16443 –token 7t2weq.bjbawausm0jaxury <br>    –discovery-token-ca-cert-hash sha256:246203ceb832292331df2fedae4e1db305859ce79cab901873d4410af5403242 <br>    –control-plane –certificate-key afe317744fa848eceadb7df6960133e77c96f9c282656d361706b7e515a4286f</p>
<p>node节点加入命令</p>
<p>  kubeadm join 192.168.229.60:16443 –token 7t2weq.bjbawausm0jaxury <br>    –discovery-token-ca-cert-hash sha256:246203ceb832292331df2fedae4e1db305859ce79cab901873d4410af5403242</p>
<p>区别在于是否指定了control-plane相关的正式信息</p>
<p>首先将k8s-master-02机器加入master节点，加入后在k8s-master-01中执行</p>
<p>kubectl get node<br>NAME            STATUS     ROLES                  AGE    VERSION<br>k8s-master-01   NotReady   control-plane,master   14m    v1.20.1<br>k8s-master-02   NotReady   control-plane,master   3m9s   v1.20.1</p>
<p>如果出现了token过期，造成master节点无法加入的情况，处理如下：</p>
<p>一、 生成新的token信息<br>kubeadm token create –print-join-command<br>kubeadm join 192.168.229.60:16443 –token dvm83r.k0gpb2vqpsg49zak     –discovery-token-ca-cert-hash sha256:246203ceb832292331df2fedae4e1db305859ce79cab901873d4410af5403242</p>
<p>二、 生成新的certificate-key<br>kubeadm init phase upload-certs –upload-certs<br>[upload-certs] Storing the certificates in Secret “kubeadm-certs” in the “kube-system” Namespace<br>[upload-certs] Using certificate key:<br>8222ab7c36a228960e05327d352e1cf12716d3fe536abac8620ec4dd250c2098</p>
<p>将k8s-master-03加入k8s集群<br>kubeadm join 192.168.229.60:16443 –token dvm83r.k0gpb2vqpsg49zak     –discovery-token-ca-cert-hash sha256:246203ceb832292331df2fedae4e1db305859ce79cab901873d4410af5403242 –control-plane –certificate-key 8222ab7c36a228960e05327d352e1cf12716d3fe536abac8620ec4dd250c2098</p>
<p>查看所有节点信息<br>kubectl get node<br>NAME            STATUS     ROLES                  AGE   VERSION<br>k8s-master-01   NotReady   control-plane,master   35m   v1.20.1<br>k8s-master-02   NotReady   control-plane,master   23m   v1.20.1<br>k8s-master-03   NotReady   control-plane,master   81s   v1.20.1</p>
<p>同理，将k8s-node-01、k8s-node-02作为node节点加入，<br>kubeadm join 192.168.229.60:16443 –token dvm83r.k0gpb2vqpsg49zak     –discovery-token-ca-cert-hash sha256:246203ceb832292331df2fedae4e1db305859ce79cab901873d4410af5403242</p>
<p>最终查看所有节点信息<br> kubectl get node<br>NAME            STATUS     ROLES                  AGE     VERSION<br>k8s-master-01   NotReady   control-plane,master   39m     v1.20.1<br>k8s-master-02   NotReady   control-plane,master   27m     v1.20.1<br>k8s-master-03   NotReady   control-plane,master   5m42s   v1.20.1<br>k8s-node-01     NotReady   <none>                 28s     v1.20.1<br>k8s-node-02     NotReady   <none>                 16s     v1.20.1</none></none></p>
<p>最后通过配置文件安装calico网络组件</p>
<p>编辑calico.yaml文件</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token punctuation">---</span>
<span class="token comment" spellcheck="true"># Source: calico/templates/calico-etcd-secrets.yaml</span>
<span class="token comment" spellcheck="true"># The following contains k8s Secrets for use with a TLS enabled etcd cluster.</span>
<span class="token comment" spellcheck="true"># For information on populating Secrets, see http://kubernetes.io/docs/user-guide/secrets/</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>secrets
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token comment" spellcheck="true"># Populate the following with etcd TLS configuration if desired, but leave blank if</span>
  <span class="token comment" spellcheck="true"># not using TLS for etcd.</span>
  <span class="token comment" spellcheck="true"># The keys below should be uncommented and the values populated with the base64</span>
  <span class="token comment" spellcheck="true"># encoded contents of each file that would be associated with the TLS data.</span>
  <span class="token comment" spellcheck="true"># Example command for encoding a file contents: cat &lt;file> | base64 -w 0</span>
  <span class="token comment" spellcheck="true"># 修改2：etcd的证书文件信息添加</span>
  <span class="token key atrule">etcd-key</span><span class="token punctuation">:</span> LS0tLS1CRUdJTiBSU0EgUFJJVkFURSBLRVktLS0tLQpNSUlFb3dJQkFBS0NBUUVBOEJmajZxb2VMNVE4cldRcGgyMTdrdy9xYnU1aXljWkhUa0kwd3BxWTJIV1FlMlNxCjRkYVg1VmFleFlwT2dzSzlBTE5BbmtKSjVCeFkrYWdLNFBpNGo3eVkrNTNwVkJqNDZzWjlyTmxkQzVwS2w2aE0KSUd4UHNubklyRFB4aTZnOE5HeW5YaVZFOEh4TUxGclJuQlpvaFVqV2dDMkVhamN0WW8zWWFQMzhUTC9TKytPNwpPcnM1RVdhZ2FyYUhJUXVzaiszOWtaeGF2ZE1uVi82MktrSE9pQnFpRkZTWVRqWTgxK2VncnlnNTVKcDg2UGdMCkplZ0orcWpsK2pMVCtucTFhTTFSbXdiMmozRkVSVUJ2a1htRFVPdVlpRWZRQWU4dmgxaVFVMnNRZG9CUWQ5Ti8Kb25zMkRieGE3R0pjT1VsdHI0SlJVcU96SDZHMjNMSk1XWkE4QXdJREFRQUJBb0lCQUYyUXNkMk5sbDNzWXdrZgpjNSszWnVVVTJzT0lXeTlPK2hMaGNqWTBrVVFwN0xocHJyNThKbzNWaCtKcjE5VFZsMXBpZ05ncjlTZlVkRWcyCjJLWjd4MUVjcW5IRVJGM2xyWHV4QnVFSmhGMDFMOFNTYmJoay9Wb01ZOHZZSWxYT3BrZTM0REdzVElWN3F5UE4KOE1ubllhd3Zpb2hCTk0wLzI0d0F3MG1IVVgrR3NLVEZ4WVNiY1VQZko0ZndiNVEyVGxrS0lJcXFUdXhOdjR5dQpnK3RQeTFzNWd2WmtkTEhFcmt1ODREWWVhbW1mbFN5SFZIejFNVnVPejhrdkpWYXN2QjZEampnQTNKcDZWL0IzCjZzUXR5OGNDa3BuSUVkRWcxdTEwV3lLU2hsSTRrTkZUUWVsckRwWGwxUWVKbERma1dlOTNZZVJEWFQ4bm4xWXQKbjdFZEo4RUNnWUVBL2R3cDJ2YTZtc3AzWU1VZC9OWEg5Zk8wVCtTMlpNTFdSazE4emZRaUlHcDdEOHFDbG5SLwoxS0xQdmF3V3hlbytnY2JBYjFPNnlIZGhMNXBNejRVMWdjS3g1dVJid29qSzJqZm53dnhoSTExdWUxaHRjcmIyCk4xR1Evc0xDL0dxdzNrdzdiMnY0OUJmVzc5aFJVOVhPZjY1OGVnbnB6ZXpEZzNNMjdzY2k1TmtDZ1lFQThoNEUKbHBiVHNickRCK3ppSGhMcDRJNGJnd3dzVDFMZDk5U0ZNRko1R21FWHdGRTBGaE5hbDFxTXBCTVVWYUJlVVlqNQpGNHhROU5oNlpkTnJnVXJleGhSZWFCSmZkYXFhMTgwZUJqdEhjaERHRytaK2phSlp5OE5SaHF1VlEra3VLRmFkCk0vaFFPR2laejlJZ094ZThxbDRIRWZ3MjJtTmZlcG5UV21DS3Jqc0NnWUVBcll6S2dJdVUzeVh6bnhDamc2cVQKWGE0U1kxdzA1WVhkLzRvUi9Lc2VlWkxTTnVWM2lXeHp4K2JXcHhEek1MTUhzS2t6L2VmOEZmaW5WR2ZrZ3lySwpmYitnNS96T1RwdytNaGx1Tkh0ZDNWT09xSHkzdG1rbXdvTGM0WTQ4eDF3Wk5xQmZNYmxiSldUMjZGbTJuOTNYCm9xcWpKcnVJUCtQUmRoaGFRYnVhTzJFQ2dZQnRBWHJMV2NpaG9oWWd3VlBrZWx0MTBFVXVzUkpaL0ZNWE8wVmoKeGgzajlJYSsvVkJZQ0FxblRnczM2NmNpRGZ1bzllUS81OXFqQWJ2SmtIQThXN3NFcnpMNTVCdTZYRDh1blpqQQo4WHR2TFlJa0daZ3NxRVdKYWJ5UXh6dUN3YjhZUmphc3FVVmt3Q05QMzZqSE1oNnREWHhkYXBJL3JMSFYvdCtiCk53LzQ5UUtCZ0U3Slk4ZHUzQlRrWE5XdDF5NXZUL0hINit4RktTMVo0R0ZMTktPMFNsdlBqN05QSWhuMjNkMkMKa3U3M0VMeDhzUUQvWUVVbUxsZGsyc2FRbWlJZzRhNnV0aDA3MW8rU01GWm9IZzlxNHVpS3l6R0dCSHZPU1k0egpURlJmaU14TXpwMXhqZ2w2bG5NU2VKZnZpZThJckJGWTAwRzBCSXFFWm1saTdEN00ybyszCi0tLS0tRU5EIFJTQSBQUklWQVRFIEtFWS0tLS0tCg==
  <span class="token key atrule">etcd-cert</span><span class="token punctuation">:</span> LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURRekNDQWl1Z0F3SUJBZ0lJT2dtLzhHRDliQzB3RFFZSktvWklodmNOQVFFTEJRQXdFakVRTUE0R0ExVUUKQXhNSFpYUmpaQzFqWVRBZUZ3MHlNVEF4TURreE1EUXpNalJhRncweU1qQXhNRGt4TURRek1qVmFNQmd4RmpBVQpCZ05WQkFNVERXczRjeTF0WVhOMFpYSXRNREV3Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLCkFvSUJBUUR3RitQcXFoNHZsRHl0WkNtSGJYdVREK3B1N21MSnhrZE9RalRDbXBqWWRaQjdaS3JoMXBmbFZwN0YKaWs2Q3dyMEFzMENlUWtua0hGajVxQXJnK0xpUHZKajduZWxVR1BqcXhuMnMyVjBMbWtxWHFFd2diRSt5ZWNpcwpNL0dMcUR3MGJLZGVKVVR3ZkV3c1d0R2NGbWlGU05hQUxZUnFOeTFpamRoby9meE12OUw3NDdzNnV6a1JacUJxCnRvY2hDNnlQN2YyUm5GcTkweWRYL3JZcVFjNklHcUlVVkpoT05qelg1NkN2S0Rua21uem8rQXNsNkFuNnFPWDYKTXRQNmVyVm96VkdiQnZhUGNVUkZRRytSZVlOUTY1aUlSOUFCN3krSFdKQlRheEIyZ0ZCMzAzK2llellOdkZycwpZbHc1U1cydmdsRlNvN01mb2JiY3NreFprRHdEQWdNQkFBR2pnWll3Z1pNd0RnWURWUjBQQVFIL0JBUURBZ1dnCk1CMEdBMVVkSlFRV01CUUdDQ3NHQVFVRkJ3TUJCZ2dyQmdFRkJRY0RBakFmQmdOVkhTTUVHREFXZ0JTNERCbE8KeEFVVFVQQjdyYXJzeGE0eGtNenAxekJCQmdOVkhSRUVPakE0Z2cxck9ITXRiV0Z6ZEdWeUxUQXhnZ2xzYjJOaApiR2h2YzNTSEJNQ281VE9IQkg4QUFBR0hFQUFBQUFBQUFBQUFBQUFBQUFBQUFBRXdEUVlKS29aSWh2Y05BUUVMCkJRQURnZ0VCQUJTVjV4NGZRVCtvN1JiUnYrZWxCd1VUc3A0dmVWbFVZNVB2LzJjUWE2b0h1dUZ3eHFlYmZjRkMKcTVlbHIzUHMxUVUrTERtMUFXeFhTUTRqaHhiTUZ0ZEVtdGxaR0I4YUhaWU95dnpDTVhOcGVWRVArUTNTWUZKQwpSdHNuSmFrQ0ZTS2ZTcVliMzYxZHRUOCtpc2tzL0ZSTUlNMFVOZ1J1U2xRM0prdmRlOGNleitQWUliR0RkQUlTCkIxZ25WWTRNRVowNXVOSmxNU05jcXZyQy9JNHdjdXV6YURkdVBZNlVQMjJLYjZKay9CdWlkKzdHVmF5QUdBNksKN0E3RDJiRUR6a3RtQm1Hei9zeHBGTW5URnh1V3F1eEVybnRWanVkV085T1pSREJadTBWVHA3aHBHUG9KTkJqVgpCZG1tVzZ6QU4xd0ZsNlJpWk9rbzRoanNEUVVHeXVNPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
  <span class="token key atrule">etcd-ca</span><span class="token punctuation">:</span> LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM0VENDQWNtZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRc0ZBREFTTVJBd0RnWURWUVFERXdkbGRHTmsKTFdOaE1CNFhEVEl4TURFd09URXdORE15TkZvWERUTXhNREV3TnpFd05ETXlORm93RWpFUU1BNEdBMVVFQXhNSApaWFJqWkMxallUQ0NBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQUpQcUsxUVVQNzBFCmJYOWpXYysyQ0FTVi9qRVo2T1ZrTkVyTmE0TC9POThZWmtKOWN6a3ZvTS9nSUIzcGFVemc1SmViazZFUnpFTjAKV0dCdU9vWnJuNHNUOERDWDc4U1N0TkxmOXpaOERvbjBVZXNRVUdnRnpQOE4vWTdlckxUT3dLMEhNVmNxSE5NaQpLb2labEFuc1piWGhxYnh0MDRJemIwckxxejZXcmcxdXZoWS9Iam52MDVjUjRZN094UTFLalBIZDR2cHhzZ1pZCjl6Lzhnem9FV3pTSlY4cDB4TzUzejNFN3NTcTBzOWJQdWtvOWp1Vm1Ra0RhQXE0aStBOGR3R25lU2hQRWJXZFMKTGVKMTNlYlpiRVN1OTZ4VVBXRTlTQndqNGpWVExqSi9XZ1VXZ043TXFNc2RtWGkxWGhDL2pIRFErNmEyV2FRVwpRRG1EL3lpUUtBOENBd0VBQWFOQ01FQXdEZ1lEVlIwUEFRSC9CQVFEQWdLa01BOEdBMVVkRXdFQi93UUZNQU1CCkFmOHdIUVlEVlIwT0JCWUVGTGdNR1U3RUJSTlE4SHV0cXV6RnJqR1F6T25YTUEwR0NTcUdTSWIzRFFFQkN3VUEKQTRJQkFRQ0ZPVkdRekZYbXRXVFFlNVZqRE9GTmZVSWVvbkZ6RDJRaE5FZ21zak9MMWdQcThmQlhQWDB4cFFMcwpvcTgza2lNL1hYZnI5cmxaR1A2NXJZVXYvcHJOS3kyZlZFYmJOYUxGRi83WUdPV3EwU1RUSk1vVXdBS1ltS0IvCnE0U2QvNXk2U1hvYmEzTmZqeDhzQnNKcTNBRXBXcmlyd3JyWGtoVHMzdW1RMTVBb0ZQdGpYaG5WTkt5UTNjbSsKVk9PSk81U0M0bnpaQndwbms2bUFtMXhaZmlXY2xXbDgyVmRKWjkxYm9qVEJlWUoxeGRyMlhIUHZsYllNMjk5NAp3V0M2V05PRG5lamZ2U0RMenJoYVJOdkJVTytzUGE1cENTQW5jRlNVUG1Xemg1d0QyVVdJbmMveGlqSkZSVVFWCjVGV3NQUWtIV0VmM3daa2hrYlR0NXFXTHpmcjUKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
<span class="token punctuation">---</span>
<span class="token comment" spellcheck="true"># Source: calico/templates/calico-config.yaml</span>
<span class="token comment" spellcheck="true"># This ConfigMap is used to configure a self-hosted Calico installation.</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token comment" spellcheck="true"># Configure this with the location of your etcd cluster.</span>
  <span class="token comment" spellcheck="true"># 修改1：修改为ETCD的节点</span>
  <span class="token comment" spellcheck="true"># 记住这个位置一定要使用https，否则会无法连接到etcd</span>
  <span class="token key atrule">etcd_endpoints</span><span class="token punctuation">:</span> <span class="token string">"https://192.168.229.51:2379,https://192.168.229.52:2379,https://192.168.229.53:2379"</span>
  <span class="token comment" spellcheck="true"># If you're using TLS enabled etcd uncomment the following.</span>
  <span class="token comment" spellcheck="true"># You must also populate the Secret below with these files.</span>
  <span class="token key atrule">etcd_ca</span><span class="token punctuation">:</span> <span class="token string">"/calico-secrets/etcd-ca"</span>   <span class="token comment" spellcheck="true"># "/calico-secrets/etcd-ca"</span>
  <span class="token key atrule">etcd_cert</span><span class="token punctuation">:</span> <span class="token string">"/calico-secrets/etcd-cert"</span> <span class="token comment" spellcheck="true"># "/calico-secrets/etcd-cert"</span>
  <span class="token key atrule">etcd_key</span><span class="token punctuation">:</span> <span class="token string">"/calico-secrets/etcd-key"</span>  <span class="token comment" spellcheck="true"># "/calico-secrets/etcd-key"</span>
  <span class="token comment" spellcheck="true"># Typha is disabled.</span>
  <span class="token key atrule">typha_service_name</span><span class="token punctuation">:</span> <span class="token string">"none"</span>
  <span class="token comment" spellcheck="true"># Configure the backend to use.</span>
  <span class="token key atrule">calico_backend</span><span class="token punctuation">:</span> <span class="token string">"bird"</span>
  <span class="token comment" spellcheck="true"># Configure the MTU to use for workload interfaces and tunnels.</span>
  <span class="token comment" spellcheck="true"># - If Wireguard is enabled, set to your network MTU - 60</span>
  <span class="token comment" spellcheck="true"># - Otherwise, if VXLAN or BPF mode is enabled, set to your network MTU - 50</span>
  <span class="token comment" spellcheck="true"># - Otherwise, if IPIP is enabled, set to your network MTU - 20</span>
  <span class="token comment" spellcheck="true"># - Otherwise, if not using any encapsulation, set to your network MTU.</span>
  <span class="token key atrule">veth_mtu</span><span class="token punctuation">:</span> <span class="token string">"1440"</span>

  <span class="token comment" spellcheck="true"># The CNI network configuration to install on each node. The special</span>
  <span class="token comment" spellcheck="true"># values in this config will be automatically populated.</span>
  <span class="token key atrule">cni_network_config</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token punctuation">-</span>
    <span class="token punctuation">{</span>
      <span class="token key atrule">"name"</span><span class="token punctuation">:</span> <span class="token string">"k8s-pod-network"</span><span class="token punctuation">,</span>
      <span class="token key atrule">"cniVersion"</span><span class="token punctuation">:</span> <span class="token string">"0.3.1"</span><span class="token punctuation">,</span>
      <span class="token key atrule">"plugins"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token key atrule">"type"</span><span class="token punctuation">:</span> <span class="token string">"calico"</span><span class="token punctuation">,</span>
          <span class="token key atrule">"log_level"</span><span class="token punctuation">:</span> <span class="token string">"info"</span><span class="token punctuation">,</span>
          <span class="token key atrule">"etcd_endpoints"</span><span class="token punctuation">:</span> <span class="token string">"__ETCD_ENDPOINTS__"</span><span class="token punctuation">,</span>
          <span class="token key atrule">"etcd_key_file"</span><span class="token punctuation">:</span> <span class="token string">"__ETCD_KEY_FILE__"</span><span class="token punctuation">,</span>
          <span class="token key atrule">"etcd_cert_file"</span><span class="token punctuation">:</span> <span class="token string">"__ETCD_CERT_FILE__"</span><span class="token punctuation">,</span>
          <span class="token key atrule">"etcd_ca_cert_file"</span><span class="token punctuation">:</span> <span class="token string">"__ETCD_CA_CERT_FILE__"</span><span class="token punctuation">,</span>
          <span class="token key atrule">"mtu"</span><span class="token punctuation">:</span> __CNI_MTU__<span class="token punctuation">,</span>
          <span class="token key atrule">"ipam"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
              <span class="token key atrule">"type"</span><span class="token punctuation">:</span> <span class="token string">"calico-ipam"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token key atrule">"policy"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
              <span class="token key atrule">"type"</span><span class="token punctuation">:</span> <span class="token string">"k8s"</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token key atrule">"kubernetes"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
              <span class="token key atrule">"kubeconfig"</span><span class="token punctuation">:</span> <span class="token string">"__KUBECONFIG_FILEPATH__"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token key atrule">"type"</span><span class="token punctuation">:</span> <span class="token string">"portmap"</span><span class="token punctuation">,</span>
          <span class="token key atrule">"snat"</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">,</span>
          <span class="token key atrule">"capabilities"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">"portMappings"</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token key atrule">"type"</span><span class="token punctuation">:</span> <span class="token string">"bandwidth"</span><span class="token punctuation">,</span>
          <span class="token key atrule">"capabilities"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token key atrule">"bandwidth"</span><span class="token punctuation">:</span> <span class="token boolean important">true</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">---</span>
<span class="token comment" spellcheck="true"># Source: calico/templates/calico-kube-controllers-rbac.yaml</span>

<span class="token comment" spellcheck="true"># Include a clusterrole for the kube-controllers component,</span>
<span class="token comment" spellcheck="true"># and bind it to the calico-kube-controllers serviceaccount.</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token comment" spellcheck="true"># Pods are monitored for changing labels.</span>
  <span class="token comment" spellcheck="true"># The node controller monitors Kubernetes nodes.</span>
  <span class="token comment" spellcheck="true"># Namespace and serviceaccount labels are used for policy.</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> pods
      <span class="token punctuation">-</span> nodes
      <span class="token punctuation">-</span> namespaces
      <span class="token punctuation">-</span> serviceaccounts
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> watch
      <span class="token punctuation">-</span> list
      <span class="token punctuation">-</span> get
  <span class="token comment" spellcheck="true"># Watch for changes to Kubernetes NetworkPolicies.</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"networking.k8s.io"</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> networkpolicies
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> watch
      <span class="token punctuation">-</span> list
<span class="token punctuation">---</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token punctuation">---</span>

<span class="token punctuation">---</span>
<span class="token comment" spellcheck="true"># Source: calico/templates/calico-node-rbac.yaml</span>
<span class="token comment" spellcheck="true"># Include a clusterrole for the calico-node DaemonSet,</span>
<span class="token comment" spellcheck="true"># and bind it to the calico-node serviceaccount.</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token comment" spellcheck="true"># The CNI plugin needs to get pods, nodes, and namespaces.</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> pods
      <span class="token punctuation">-</span> nodes
      <span class="token punctuation">-</span> namespaces
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> endpoints
      <span class="token punctuation">-</span> services
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token comment" spellcheck="true"># Used to discover service IPs for advertisement.</span>
      <span class="token punctuation">-</span> watch
      <span class="token punctuation">-</span> list
  <span class="token comment" spellcheck="true"># Pod CIDR auto-detection on kubeadm needs access to config maps.</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> configmaps
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> get
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> nodes/status
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token comment" spellcheck="true"># Needed for clearing NodeNetworkUnavailable flag.</span>
      <span class="token punctuation">-</span> patch

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system

<span class="token punctuation">---</span>
<span class="token comment" spellcheck="true"># Source: calico/templates/calico-node.yaml</span>
<span class="token comment" spellcheck="true"># This manifest installs the calico-node container, as well</span>
<span class="token comment" spellcheck="true"># as the CNI plugins and network config on</span>
<span class="token comment" spellcheck="true"># each master and worker node in a Kubernetes cluster.</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux
      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># Make sure calico-node gets scheduled on all nodes.</span>
        <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
          <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
        <span class="token comment" spellcheck="true"># Mark the pod as a critical add-on for rescheduling.</span>
        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> CriticalAddonsOnly
          <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
        <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoExecute
          <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
      <span class="token comment" spellcheck="true"># Minimize downtime during a rolling upgrade or deletion; tell Kubernetes to do a "force</span>
      <span class="token comment" spellcheck="true"># deletion": https://kubernetes.io/docs/concepts/workloads/pods/pod/#termination-of-pods.</span>
      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">0</span>
      <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>node<span class="token punctuation">-</span>critical
      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># This container installs the CNI binaries</span>
        <span class="token comment" spellcheck="true"># and CNI network config file on each node.</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> install<span class="token punctuation">-</span>cni
          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/dotbalo/cni<span class="token punctuation">:</span>v3.15.3
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/install-cni.sh"</span><span class="token punctuation">]</span>
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># Name of the CNI config file to create.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CNI_CONF_NAME
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"10-calico.conflist"</span>
            <span class="token comment" spellcheck="true"># The CNI network config to install on each node.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CNI_NETWORK_CONFIG
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> cni_network_config
            <span class="token comment" spellcheck="true"># The location of the etcd cluster.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_ENDPOINTS
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_endpoints
            <span class="token comment" spellcheck="true"># CNI MTU Config variable</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CNI_MTU
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> veth_mtu
            <span class="token comment" spellcheck="true"># Prevents the container from sleeping forever.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SLEEP
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"false"</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /host/opt/cni/bin
              <span class="token key atrule">name</span><span class="token punctuation">:</span> cni<span class="token punctuation">-</span>bin<span class="token punctuation">-</span>dir
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /host/etc/cni/net.d
              <span class="token key atrule">name</span><span class="token punctuation">:</span> cni<span class="token punctuation">-</span>net<span class="token punctuation">-</span>dir
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /calico<span class="token punctuation">-</span>secrets
              <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>certs
          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
            <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token comment" spellcheck="true"># Adds a Flex Volume Driver that creates a per-pod Unix Domain Socket to allow Dikastes</span>
        <span class="token comment" spellcheck="true"># to communicate with Felix over the Policy Sync API.</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flexvol<span class="token punctuation">-</span>driver
          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/dotbalo/pod2daemon<span class="token punctuation">-</span>flexvol<span class="token punctuation">:</span>v3.15.3
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flexvol<span class="token punctuation">-</span>driver<span class="token punctuation">-</span>host
            <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /host/driver
          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
            <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># Runs calico-node container on each Kubernetes node. This</span>
        <span class="token comment" spellcheck="true"># container programs network policy and routes on each</span>
        <span class="token comment" spellcheck="true"># host.</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/dotbalo/node<span class="token punctuation">:</span>v3.15.3
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># The location of the etcd cluster.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_ENDPOINTS
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_endpoints
            <span class="token comment" spellcheck="true"># Location of the CA certificate for etcd.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_CA_CERT_FILE
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_ca
            <span class="token comment" spellcheck="true"># Location of the client key for etcd.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_KEY_FILE
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_key
            <span class="token comment" spellcheck="true"># Location of the client certificate for etcd.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_CERT_FILE
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_cert
            <span class="token comment" spellcheck="true"># Set noderef for node controller.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CALICO_K8S_NODE_REF
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">fieldRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">fieldPath</span><span class="token punctuation">:</span> spec.nodeName
            <span class="token comment" spellcheck="true"># Choose the backend to use.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CALICO_NETWORKING_BACKEND
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> calico_backend
            <span class="token comment" spellcheck="true"># Cluster type to identify the deployment type</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CLUSTER_TYPE
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"k8s,bgp"</span>
            <span class="token comment" spellcheck="true"># Auto-detect the BGP IP address.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> IP
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"autodetect"</span>
            <span class="token comment" spellcheck="true"># Enable IPIP</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CALICO_IPV4POOL_IPIP
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"Always"</span>
            <span class="token comment" spellcheck="true"># Enable or Disable VXLAN on the default IP pool.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CALICO_IPV4POOL_VXLAN
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"Never"</span>
            <span class="token comment" spellcheck="true"># Set MTU for tunnel device used if ipip is enabled</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_IPINIPMTU
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> veth_mtu
            <span class="token comment" spellcheck="true"># Set MTU for the VXLAN tunnel device.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_VXLANMTU
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> veth_mtu
            <span class="token comment" spellcheck="true"># Set MTU for the Wireguard tunnel device.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_WIREGUARDMTU
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> veth_mtu
            <span class="token comment" spellcheck="true"># The default IPv4 pool to create on startup if none exists. Pod IPs will be</span>
            <span class="token comment" spellcheck="true"># chosen from this range. Changing this value after installation will have</span>
            <span class="token comment" spellcheck="true"># no effect. This should fall within `--cluster-cidr`.</span>
            <span class="token comment" spellcheck="true"># 修改3：添加ip地址信息</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CALICO_IPV4POOL_CIDR
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"172.168.0.0/12"</span>
            <span class="token comment" spellcheck="true"># Disable file logging so `kubectl logs` works.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> CALICO_DISABLE_FILE_LOGGING
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
            <span class="token comment" spellcheck="true"># Set Felix endpoint to host default action to ACCEPT.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_DEFAULTENDPOINTTOHOSTACTION
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"ACCEPT"</span>
            <span class="token comment" spellcheck="true"># Disable IPv6 on Kubernetes.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_IPV6SUPPORT
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"false"</span>
            <span class="token comment" spellcheck="true"># Set Felix logging to "info"</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_LOGSEVERITYSCREEN
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"info"</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> FELIX_HEALTHENABLED
              <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
            <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
          <span class="token key atrule">resources</span><span class="token punctuation">:</span>
            <span class="token key atrule">requests</span><span class="token punctuation">:</span>
              <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 250m
          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">exec</span><span class="token punctuation">:</span>
              <span class="token key atrule">command</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> /bin/calico<span class="token punctuation">-</span>node
              <span class="token punctuation">-</span> <span class="token punctuation">-</span>felix<span class="token punctuation">-</span>live
              <span class="token punctuation">-</span> <span class="token punctuation">-</span>bird<span class="token punctuation">-</span>live
            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">6</span>
          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">exec</span><span class="token punctuation">:</span>
              <span class="token key atrule">command</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> /bin/calico<span class="token punctuation">-</span>node
              <span class="token punctuation">-</span> <span class="token punctuation">-</span>felix<span class="token punctuation">-</span>ready
              <span class="token punctuation">-</span> <span class="token punctuation">-</span>bird<span class="token punctuation">-</span>ready
            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /lib/modules
              <span class="token key atrule">name</span><span class="token punctuation">:</span> lib<span class="token punctuation">-</span>modules
              <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /run/xtables.lock
              <span class="token key atrule">name</span><span class="token punctuation">:</span> xtables<span class="token punctuation">-</span>lock
              <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/run/calico
              <span class="token key atrule">name</span><span class="token punctuation">:</span> var<span class="token punctuation">-</span>run<span class="token punctuation">-</span>calico
              <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/calico
              <span class="token key atrule">name</span><span class="token punctuation">:</span> var<span class="token punctuation">-</span>lib<span class="token punctuation">-</span>calico
              <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /calico<span class="token punctuation">-</span>secrets
              <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>certs
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> policysync
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/run/nodeagent
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># Used by calico-node.</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> lib<span class="token punctuation">-</span>modules
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /lib/modules
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> var<span class="token punctuation">-</span>run<span class="token punctuation">-</span>calico
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/run/calico
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> var<span class="token punctuation">-</span>lib<span class="token punctuation">-</span>calico
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/lib/calico
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> xtables<span class="token punctuation">-</span>lock
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /run/xtables.lock
            <span class="token key atrule">type</span><span class="token punctuation">:</span> FileOrCreate
        <span class="token comment" spellcheck="true"># Used to install CNI.</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cni<span class="token punctuation">-</span>bin<span class="token punctuation">-</span>dir
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /opt/cni/bin
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cni<span class="token punctuation">-</span>net<span class="token punctuation">-</span>dir
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/cni/net.d
        <span class="token comment" spellcheck="true"># Mount in the etcd TLS secrets with mode 400.</span>
        <span class="token comment" spellcheck="true"># See https://kubernetes.io/docs/concepts/configuration/secret/</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>certs
          <span class="token key atrule">secret</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretName</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>secrets
            <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">0400</span>
        <span class="token comment" spellcheck="true"># Used to create per-pod Unix Domain Sockets</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> policysync
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /var/run/nodeagent
        <span class="token comment" spellcheck="true"># Used to install Flex Volume Driver</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> flexvol<span class="token punctuation">-</span>driver<span class="token punctuation">-</span>host
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">type</span><span class="token punctuation">:</span> DirectoryOrCreate
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /usr/libexec/kubernetes/kubelet<span class="token punctuation">-</span>plugins/volume/exec/nodeagent~uds
<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>node
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system

<span class="token punctuation">---</span>
<span class="token comment" spellcheck="true"># Source: calico/templates/calico-kube-controllers.yaml</span>
<span class="token comment" spellcheck="true"># See https://github.com/projectcalico/kube-controllers</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment" spellcheck="true"># The controllers can only have a single active instance.</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> Recreate
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># Mark the pod as a critical add-on for rescheduling.</span>
        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> CriticalAddonsOnly
          <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master
          <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
      <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>critical
      <span class="token comment" spellcheck="true"># The controllers must run in the host network namespace so that</span>
      <span class="token comment" spellcheck="true"># it isn't governed by policy that would prevent it from working.</span>
      <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
          <span class="token comment" spellcheck="true"># 修改4：镜像地址变更</span>
          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/dotbalo/kube<span class="token punctuation">-</span>controllers<span class="token punctuation">:</span>v3.15.3
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># The location of the etcd cluster.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_ENDPOINTS
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_endpoints
            <span class="token comment" spellcheck="true"># Location of the CA certificate for etcd.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_CA_CERT_FILE
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_ca
            <span class="token comment" spellcheck="true"># Location of the client key for etcd.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_KEY_FILE
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_key
            <span class="token comment" spellcheck="true"># Location of the client certificate for etcd.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ETCD_CERT_FILE
              <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
                <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
                  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>config
                  <span class="token key atrule">key</span><span class="token punctuation">:</span> etcd_cert
            <span class="token comment" spellcheck="true"># Choose which controllers to run.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ENABLED_CONTROLLERS
              <span class="token key atrule">value</span><span class="token punctuation">:</span> policy<span class="token punctuation">,</span>namespace<span class="token punctuation">,</span>serviceaccount<span class="token punctuation">,</span>workloadendpoint<span class="token punctuation">,</span>node
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token comment" spellcheck="true"># Mount in the etcd TLS secrets.</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /calico<span class="token punctuation">-</span>secrets
              <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>certs
          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">exec</span><span class="token punctuation">:</span>
              <span class="token key atrule">command</span><span class="token punctuation">:</span>
              <span class="token punctuation">-</span> /usr/bin/check<span class="token punctuation">-</span>status
              <span class="token punctuation">-</span> <span class="token punctuation">-</span>r
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># Mount in the etcd TLS secrets with mode 400.</span>
        <span class="token comment" spellcheck="true"># See https://kubernetes.io/docs/concepts/configuration/secret/</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> etcd<span class="token punctuation">-</span>certs
          <span class="token key atrule">secret</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretName</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>etcd<span class="token punctuation">-</span>secrets
            <span class="token key atrule">defaultMode</span><span class="token punctuation">:</span> <span class="token number">0400</span>

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> calico<span class="token punctuation">-</span>kube<span class="token punctuation">-</span>controllers
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system

<span class="token punctuation">---</span>
<span class="token comment" spellcheck="true"># Source: calico/templates/calico-typha.yaml</span>

<span class="token punctuation">---</span>
<span class="token comment" spellcheck="true"># Source: calico/templates/configure-canal.yaml</span>

<span class="token punctuation">---</span>
<span class="token comment" spellcheck="true"># Source: calico/templates/kdd-crds.yaml</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行命令开始安装<br>kubectl apply -f calico-etcd.yaml</p>
<p>需要有一个漫长的等待才能完成安装，完成后查看集群状态以及pod装填<br>kubectl -n kube-system get pod<br>NAME                                       READY   STATUS    RESTARTS   AGE<br>calico-kube-controllers-5f6d4b864b-pr5zl   1/1     Running   0          2m4s<br>calico-node-bwdmj                          1/1     Running   0          2m4s<br>calico-node-ddh6r                          1/1     Running   0          2m4s<br>calico-node-dhfb2                          1/1     Running   0          2m4s<br>calico-node-jx79z                          1/1     Running   0          2m4s<br>calico-node-x4nzm                          1/1     Running   0          2m4s<br>coredns-54d67798b7-66z7x                   1/1     Running   0          4h9m<br>coredns-54d67798b7-jzql9                   1/1     Running   0          4h9m<br>etcd-k8s-master-01                         1/1     Running   0          4h9m<br>etcd-k8s-master-02                         1/1     Running   0          3h57m<br>etcd-k8s-master-03                         1/1     Running   0          3h35m<br>kube-apiserver-k8s-master-01               1/1     Running   0          4h9m<br>kube-apiserver-k8s-master-02               1/1     Running   0          3h57m<br>kube-apiserver-k8s-master-03               1/1     Running   0          3h35m<br>kube-controller-manager-k8s-master-01      1/1     Running   1          4h9m<br>kube-controller-manager-k8s-master-02      1/1     Running   0          3h57m<br>kube-controller-manager-k8s-master-03      1/1     Running   0          3h35m<br>kube-proxy-f56vn                           1/1     Running   0          3h35m<br>kube-proxy-hzc6n                           1/1     Running   0          3h30m<br>kube-proxy-pqh28                           1/1     Running   0          4h9m<br>kube-proxy-r66cr                           1/1     Running   0          3h30m<br>kube-proxy-t7dvm                           1/1     Running   0          3h57m<br>kube-scheduler-k8s-master-01               1/1     Running   1          4h9m<br>kube-scheduler-k8s-master-02               1/1     Running   0          3h57m<br>kube-scheduler-k8s-master-03               1/1     Running   0          3h35m</p>
<p>这样整个集群算是告一段落了。</p>
<p>第7部分：metrics和dashboard的安装</p>
<p>执行metrics安装之前，需要先把下面配置文件中的证书拷贝到其它节点，否则会存在找不到证书的情况<br>for i in k8s-master-02 k8s-master-03 k8s-node-01 k8s-node-02; do scp /etc/kubernetes/pki/front-proxy-ca.crt $i:/etc/kubernetes/pki/front-proxy-ca.crt ;done</p>
<p>metrics的配置文件如下：</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
    <span class="token key atrule">rbac.authorization.k8s.io/aggregate-to-admin</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
    <span class="token key atrule">rbac.authorization.k8s.io/aggregate-to-edit</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
    <span class="token key atrule">rbac.authorization.k8s.io/aggregate-to-view</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>aggregated<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>reader
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> metrics.k8s.io
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> pods
      <span class="token punctuation">-</span> nodes
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> get
      <span class="token punctuation">-</span> list
      <span class="token punctuation">-</span> watch
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>metrics<span class="token punctuation">-</span>server
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">""</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> pods
      <span class="token punctuation">-</span> nodes
      <span class="token punctuation">-</span> nodes/stats
      <span class="token punctuation">-</span> namespaces
      <span class="token punctuation">-</span> configmaps
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> get
      <span class="token punctuation">-</span> list
      <span class="token punctuation">-</span> watch
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server<span class="token punctuation">-</span>auth<span class="token punctuation">-</span>reader
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> extension<span class="token punctuation">-</span>apiserver<span class="token punctuation">-</span>authentication<span class="token punctuation">-</span>reader
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server<span class="token punctuation">:</span>system<span class="token punctuation">:</span>auth<span class="token punctuation">-</span>delegator
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>auth<span class="token punctuation">-</span>delegator
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>metrics<span class="token punctuation">-</span>server
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> system<span class="token punctuation">:</span>metrics<span class="token punctuation">-</span>server
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> https
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">args</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>cert<span class="token punctuation">-</span>dir=/tmp
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>secure<span class="token punctuation">-</span>port=4443
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>metric<span class="token punctuation">-</span>resolution=30s
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kubelet<span class="token punctuation">-</span>insecure<span class="token punctuation">-</span>tls
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>kubelet<span class="token punctuation">-</span>preferred<span class="token punctuation">-</span>address<span class="token punctuation">-</span>types=InternalIP<span class="token punctuation">,</span>ExternalIP<span class="token punctuation">,</span>Hostname
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>requestheader<span class="token punctuation">-</span>client<span class="token punctuation">-</span>ca<span class="token punctuation">-</span>file=/etc/kubernetes/pki/front<span class="token punctuation">-</span>proxy<span class="token punctuation">-</span>ca.crt <span class="token comment" spellcheck="true"># change to front-proxy-ca.crt for kubeadm， 如果不添加证书，可能会造成监测信息获取不到的情况</span>
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>requestheader<span class="token punctuation">-</span>username<span class="token punctuation">-</span>headers=X<span class="token punctuation">-</span>Remote<span class="token punctuation">-</span>User
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>requestheader<span class="token punctuation">-</span>group<span class="token punctuation">-</span>headers=X<span class="token punctuation">-</span>Remote<span class="token punctuation">-</span>Group
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>requestheader<span class="token punctuation">-</span>extra<span class="token punctuation">-</span>headers<span class="token punctuation">-</span>prefix=X<span class="token punctuation">-</span>Remote<span class="token punctuation">-</span>Extra<span class="token punctuation">-</span>
          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/dotbalo/metrics<span class="token punctuation">-</span>server<span class="token punctuation">:</span>v0.4.1
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /livez
              <span class="token key atrule">port</span><span class="token punctuation">:</span> https
              <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTPS
            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">4443</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> https
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /readyz
              <span class="token key atrule">port</span><span class="token punctuation">:</span> https
              <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTPS
            <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
            <span class="token key atrule">readOnlyRootFilesystem</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">runAsNonRoot</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1000</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp
              <span class="token key atrule">name</span><span class="token punctuation">:</span> tmp<span class="token punctuation">-</span>dir
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ca<span class="token punctuation">-</span>ssl
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/kubernetes/pki
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux
      <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> system<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>critical
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> tmp<span class="token punctuation">-</span>dir
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ca<span class="token punctuation">-</span>ssl
          <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/kubernetes/pki
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apiregistration.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> APIService
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
  <span class="token key atrule">name</span><span class="token punctuation">:</span> v1beta1.metrics.k8s.io
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">group</span><span class="token punctuation">:</span> metrics.k8s.io
  <span class="token key atrule">groupPriorityMinimum</span><span class="token punctuation">:</span> <span class="token number">100</span>
  <span class="token key atrule">insecureSkipTLSVerify</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">service</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> metrics<span class="token punctuation">-</span>server
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
  <span class="token key atrule">version</span><span class="token punctuation">:</span> v1beta1
  <span class="token key atrule">versionPriority</span><span class="token punctuation">:</span> <span class="token number">100</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>安装命令<br>kubectl apply -f comp.yaml</p>
<p>安装完成后，查看指标信息<br>kubectl top node<br>NAME            CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%<br>k8s-master-01   161m         8%     1363Mi          35%<br>k8s-master-02   154m         7%     1310Mi          34%<br>k8s-master-03   152m         7%     1272Mi          33%<br>k8s-node-01     86m          4%     1090Mi          28%<br>k8s-node-02     92m          4%     1073Mi          28%</p>
<p>安装dashboard，配置文件有两个</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token comment" spellcheck="true"># dashboard.yaml</span>
<span class="token comment" spellcheck="true"># Copyright 2017 The Kubernetes Authors.</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># Licensed under the Apache License, Version 2.0 (the "License");</span>
<span class="token comment" spellcheck="true"># you may not use this file except in compliance with the License.</span>
<span class="token comment" spellcheck="true"># You may obtain a copy of the License at</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="token comment" spellcheck="true">#</span>
<span class="token comment" spellcheck="true"># Unless required by applicable law or agreed to in writing, software</span>
<span class="token comment" spellcheck="true"># distributed under the License is distributed on an "AS IS" BASIS,</span>
<span class="token comment" spellcheck="true"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="token comment" spellcheck="true"># See the License for the specific language governing permissions and</span>
<span class="token comment" spellcheck="true"># limitations under the License.</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard

<span class="token punctuation">---</span>

<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8443</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>certs
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>csrf
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">csrf</span><span class="token punctuation">:</span> <span class="token string">""</span>

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>key<span class="token punctuation">-</span>holder
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque

<span class="token punctuation">---</span>

<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>settings
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard

<span class="token punctuation">---</span>

<span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token comment" spellcheck="true"># Allow Dashboard to get, update and delete Dashboard exclusive secrets.</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"secrets"</span><span class="token punctuation">]</span>
    <span class="token key atrule">resourceNames</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"kubernetes-dashboard-key-holder"</span><span class="token punctuation">,</span> <span class="token string">"kubernetes-dashboard-certs"</span><span class="token punctuation">,</span> <span class="token string">"kubernetes-dashboard-csrf"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">,</span> <span class="token string">"delete"</span><span class="token punctuation">]</span>
    <span class="token comment" spellcheck="true"># Allow Dashboard to get and update 'kubernetes-dashboard-settings' config map.</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"configmaps"</span><span class="token punctuation">]</span>
    <span class="token key atrule">resourceNames</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"kubernetes-dashboard-settings"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"update"</span><span class="token punctuation">]</span>
    <span class="token comment" spellcheck="true"># Allow Dashboard to get metrics.</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"services"</span><span class="token punctuation">]</span>
    <span class="token key atrule">resourceNames</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"heapster"</span><span class="token punctuation">,</span> <span class="token string">"dashboard-metrics-scraper"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"proxy"</span><span class="token punctuation">]</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"services/proxy"</span><span class="token punctuation">]</span>
    <span class="token key atrule">resourceNames</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"heapster"</span><span class="token punctuation">,</span> <span class="token string">"http:heapster:"</span><span class="token punctuation">,</span> <span class="token string">"https:heapster:"</span><span class="token punctuation">,</span> <span class="token string">"dashboard-metrics-scraper"</span><span class="token punctuation">,</span> <span class="token string">"http:dashboard-metrics-scraper"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">]</span>

<span class="token punctuation">---</span>

<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token comment" spellcheck="true"># Allow Metrics Scraper to get metrics from the Metrics server</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"metrics.k8s.io"</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"pods"</span><span class="token punctuation">,</span> <span class="token string">"nodes"</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"get"</span><span class="token punctuation">,</span> <span class="token string">"list"</span><span class="token punctuation">,</span> <span class="token string">"watch"</span><span class="token punctuation">]</span>

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard

<span class="token punctuation">---</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard

<span class="token punctuation">---</span>

<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/dotbalo/dashboard<span class="token punctuation">:</span>v2.0.4
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8443</span>
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
          <span class="token key atrule">args</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>auto<span class="token punctuation">-</span>generate<span class="token punctuation">-</span>certificates
            <span class="token punctuation">-</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>namespace=kubernetes<span class="token punctuation">-</span>dashboard
            <span class="token comment" spellcheck="true"># Uncomment the following line to manually specify Kubernetes API server Host</span>
            <span class="token comment" spellcheck="true"># If not specified, Dashboard will attempt to auto discover the API server and connect</span>
            <span class="token comment" spellcheck="true"># to it. Uncomment only if the default does not work.</span>
            <span class="token comment" spellcheck="true"># - --apiserver-host=http://my-address:port</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>certs
              <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /certs
              <span class="token comment" spellcheck="true"># Create on-disk volume to store exec logs</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp
              <span class="token key atrule">name</span><span class="token punctuation">:</span> tmp<span class="token punctuation">-</span>volume
          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTPS
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /
              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8443</span>
            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
            <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
            <span class="token key atrule">readOnlyRootFilesystem</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1001</span>
            <span class="token key atrule">runAsGroup</span><span class="token punctuation">:</span> <span class="token number">2001</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>certs
          <span class="token key atrule">secret</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretName</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard<span class="token punctuation">-</span>certs
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tmp<span class="token punctuation">-</span>volume
          <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">"kubernetes.io/os"</span><span class="token punctuation">:</span> linux
      <span class="token comment" spellcheck="true"># Comment the following tolerations if Dashboard must not be deployed on master</span>
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master
          <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule

<span class="token punctuation">---</span>

<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> dashboard<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>scraper
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dashboard<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>scraper
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8000</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8000</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> dashboard<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>scraper

<span class="token punctuation">---</span>

<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> dashboard<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>scraper
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dashboard<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>scraper
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> dashboard<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>scraper
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">k8s-app</span><span class="token punctuation">:</span> dashboard<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>scraper
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
        <span class="token key atrule">seccomp.security.alpha.kubernetes.io/pod</span><span class="token punctuation">:</span> <span class="token string">'runtime/default'</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dashboard<span class="token punctuation">-</span>metrics<span class="token punctuation">-</span>scraper
          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>beijing.aliyuncs.com/dotbalo/metrics<span class="token punctuation">-</span>scraper<span class="token punctuation">:</span>v1.0.4
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8000</span>
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
            <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">scheme</span><span class="token punctuation">:</span> HTTP
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /
              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8000</span>
            <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
            <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
          <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp
              <span class="token key atrule">name</span><span class="token punctuation">:</span> tmp<span class="token punctuation">-</span>volume
          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
            <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
            <span class="token key atrule">readOnlyRootFilesystem</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
            <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">1001</span>
            <span class="token key atrule">runAsGroup</span><span class="token punctuation">:</span> <span class="token number">2001</span>
      <span class="token key atrule">serviceAccountName</span><span class="token punctuation">:</span> kubernetes<span class="token punctuation">-</span>dashboard
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
        <span class="token key atrule">"kubernetes.io/os"</span><span class="token punctuation">:</span> linux
      <span class="token comment" spellcheck="true"># Comment the following tolerations if Dashboard must not be deployed on master</span>
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master
          <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> tmp<span class="token punctuation">-</span>volume
          <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token comment" spellcheck="true"># dashboard-user.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> admin<span class="token punctuation">-</span>user
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1 
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding 
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> 
  <span class="token key atrule">name</span><span class="token punctuation">:</span> admin<span class="token punctuation">-</span>user
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token key atrule">rbac.authorization.kubernetes.io/autoupdate</span><span class="token punctuation">:</span> <span class="token string">"true"</span>
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cluster<span class="token punctuation">-</span>admin
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> admin<span class="token punctuation">-</span>user
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>两个配置文件放在同一个文件夹下，所以运行时不指定具体文件<br>kubectl apply -f .</p>
<p>安装完成后，为了本地可以进行访问，在google浏览器中加入启动参数，用于解决无法访问Dashboard的问题</p>
<pre><code>--test-type --ignore-certificate-errors</code></pre><p>最后需要针对dashboard修改svc设置，变更ClusterIP为nodePort</p>
<pre><code>kubectl get svc -n kubernetes-dashboard
NAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE
dashboard-metrics-scraper   ClusterIP   10.110.87.54     &lt;none&gt;        8000/TCP   3m21s
kubernetes-dashboard        ClusterIP   10.104.150.211   &lt;none&gt;        443/TCP    3m21s

kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard
# Please edit the object below. Lines beginning with a &#39;#&#39; will be ignored,
# and an empty file will abort the edit. If an error occurs while saving this file will be
# reopened with the relevant failures.
#
apiVersion: v1
kind: Service
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {&quot;apiVersion&quot;:&quot;v1&quot;,&quot;kind&quot;:&quot;Service&quot;,&quot;metadata&quot;:{&quot;annotations&quot;:{},&quot;labels&quot;:{&quot;k8s-app&quot;:&quot;kubernetes-dashboard&quot;},&quot;name&quot;:&quot;kubernetes-dashboard&quot;,&quot;namespace&quot;:&quot;kubernetes-dashboard&quot;},&quot;spec&quot;:{&quot;ports&quot;:[{&quot;port&quot;:443,&quot;targetPort&quot;:8443}],&quot;selector&quot;:{&quot;k8s-app&quot;:&quot;kubernetes-dashboard&quot;}}}
  creationTimestamp: &quot;2021-01-09T15:31:54Z&quot;
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
  resourceVersion: &quot;34046&quot;
  uid: ec006a73-60fd-412f-a4fe-19e4b0726a9b
spec:
  clusterIP: 10.104.150.211
  clusterIPs:
  - 10.104.150.211
  ports:
  - port: 443
    protocol: TCP
    targetPort: 8443
  selector:
    k8s-app: kubernetes-dashboard
  sessionAffinity: None
  type: nodePort   # 在此处更改
status:
  loadBalancer: {}


// :wq保存退出

kubectl get svc -n kubernetes-dashboard
NAME                        TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE
dashboard-metrics-scraper   ClusterIP   10.110.87.54     &lt;none&gt;        8000/TCP        7m33s
kubernetes-dashboard        NodePort    10.104.150.211   &lt;none&gt;        443:32056/TCP   7m33s

</code></pre><p>根据已有的端口号，通过任意安装了kube-proxy的宿主机，或者VIP的IP+端口即可访问到dashboard。例如<a href="https://192.168.229.60:32056" target="_blank" rel="noopener">https://192.168.229.60:32056</a>.</p>
<p>选择使用token登录，首先要先获取token值</p>
<pre><code> kubectl -n kube-system describe secret $(kubectl -n kube-system get secret | grep admin-user | awk &#39;{print $1}&#39;)
Name:         admin-user-token-wgsns
Namespace:    kube-system
Labels:       &lt;none&gt;
Annotations:  kubernetes.io/service-account.name: admin-user
              kubernetes.io/service-account.uid: b13eceff-722e-4c3c-bcce-1a001a0a698c

Type:  kubernetes.io/service-account-token

Data
====
ca.crt:     1066 bytes
namespace:  11 bytes
token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IlN4QXVXRThDdGlNMkQ0MlByVjJueElaOUtYdXhqQ0JiVjVadkFUMmVtajQifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLXdnc25zIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJiMTNlY2VmZi03MjJlLTRjM2MtYmNjZS0xYTAwMWEwYTY5OGMiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.bjITkXMzLzGTJqKScN48TSVgA4cjj7dfcTOPKlEt87hZyg9tifp3WR1bbtNowdDlEcVK2anuHXm6Z9XV6OWVBWp845b-LZPcsOkLHHcYXd16YpLfAL3_SXLQpboq-_ilQU6M4IV2zWeBYXWc03aAqSkQVS8WlE8yuTm7UqRPpNs1C3YB92c3OjlXujS38gsdkvud5Wk8Mnr8lNEyYM39HiiM8SXVdDtN1kzLQgRpFMMQq75rGtohQ4cATkla0a6VHxRh9VFXdgaytutU_hAFetA6Oia7i0j56TbJBwguJNFTTm2-sSvMnWqAPIelu-LKVoC-aYMiSAODslyXVE-L-g

</code></pre><p>将token值复制进去即可进行访问！</p>
<p>第8部分：必须要改的内容</p>
<p>8.1 修改kube-proxy的运行模式为ipvs</p>
<p>查看原来的运行模式</p>
<p>curl 127.0.0.1:10249/proxyMode<br>iptables</p>
<p>在master01节点执行，修改为ipvs<br>kubectl edit cm kube-proxy -n kube-system<br>// 找到mode位置，修改<br>mode: “ipvs”</p>
<p>修改完成后，进行kube-proxy的滚动更新<br>kubectl patch daemonset kube-proxy -p “{&quot;spec&quot;:{&quot;template&quot;:{&quot;metadata&quot;:{&quot;annotations&quot;:{&quot;date&quot;:&quot;<code>date +&#39;%s&#39;</code>&quot;}}}}}” -n kube-system</p>
<p>更新完成后再查看运行方式<br>curl 127.0.0.1:10249/proxyMode<br>ipvs</p>
<p>查看ipvs规则信息<br>ipvsadm -ln<br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br>TCP  127.0.0.1:32056 rr<br>  -&gt; 172.163.98.133:8443          Masq    1      0          0<br>TCP  172.17.0.1:32056 rr<br>  -&gt; 172.163.98.133:8443          Masq    1      0          0<br>TCP  172.174.107.64:32056 rr<br>  -&gt; 172.163.98.133:8443          Masq    1      0          0<br>TCP  192.168.229.51:32056 rr<br>  -&gt; 172.163.98.133:8443          Masq    1      0          0<br>TCP  10.96.0.1:443 rr<br>  -&gt; 192.168.229.51:6443          Masq    1      0          0<br>  -&gt; 192.168.229.52:6443          Masq    1      0          0<br>  -&gt; 192.168.229.53:6443          Masq    1      0          0<br>TCP  10.96.0.10:53 rr<br>  -&gt; 172.163.98.129:53            Masq    1      0          0<br>  -&gt; 172.175.44.1:53              Masq    1      0          0<br>TCP  10.96.0.10:9153 rr<br>  -&gt; 172.163.98.129:9153          Masq    1      0          0<br>  -&gt; 172.175.44.1:9153            Masq    1      0          0<br>TCP  10.104.150.211:443 rr<br>  -&gt; 172.163.98.133:8443          Masq    1      0          0<br>TCP  10.110.87.54:8000 rr<br>  -&gt; 172.175.44.2:8000            Masq    1      0          0<br>TCP  10.111.142.190:443 rr<br>  -&gt; 172.163.98.132:4443          Masq    1      1          0<br>UDP  10.96.0.10:53 rr<br>  -&gt; 172.163.98.129:53            Masq    1      0          0<br>  -&gt; 172.175.44.1:53              Masq    1      0          0</p>
<p>8.2 master节点可以部署非系统pod，通过对污点（taints）进行修改</p>
<p>查看节点的污点信息<br>kubectl describe node -l node-role.kubernetes.io/master= | grep Taints<br>Taints:             node-role.kubemetes.io/naster:NoSchedule<br>Taints:             node-role.kubernetes.io/master:NoSchedule<br>Taints:             node-role.kubernetes.io/master:NoSchedule</p>
<p>去除污点<br>kubectl taint node -l node-role.kubernetes.io/master node-role.kubernetes.io/master:NoSchedule-</p>
<p>再次查看<br>kubectl describe node -l node-role.kubernetes.io/master= | grep Taints<br>Taints:             <none><br>Taints:             <none><br>Taints:             <none></none></none></none></p>
<p>注意污点去除时，要和查找到的污点信息一一对应即可。</p>
<p>最后一部分：集群验证</p>
<p>注意：</p>
<ol>
<li>所有的镜像，尽量在本地镜像仓库内备份留存，这样集群一旦出现问题，在自愈的过程中拉取镜像时更快</li>
<li>在执行kubectl edit svc 命令时，可以按住shift+zz(按住shift连击两下z键)进行保存退出</li>
</ol>
<p>1.2 二进制安装</p>
<h2 id="第二章-基本概念介绍"><a href="#第二章-基本概念介绍" class="headerlink" title="第二章 基本概念介绍"></a>第二章 基本概念介绍</h2><p>2.1 为什么要使用k8s</p>
<p>2.1.1 健康检查，原生提供健康检查的功能</p>
<p>2.1.2 服务的动态扩容缩容</p>
<p>2.1.3 大规模容器管理（1000个容器），端口资源的简化管理（内部Service，不直接对外暴露的端口），减少端口冲突</p>
<p><img src="%E6%9E%B6%E6%9E%84%E5%9B%BE%E5%B1%95%E7%A4%BA.png" alt></p>
<p>2.2 master节点</p>
<p>整个集群的控制中枢</p>
<ul>
<li><p>kube-apiserver: 集群控制核心。各个模块之间的信息交互，集群管理、资源配置、安全机制的入口</p>
</li>
<li><p>controller-manager：集群状态管理器，保证pod和其它资源达到设定值，同apiserver通信，在需要的时候进行资源的增删改查</p>
</li>
<li><p>Scheduler: 集群的调度中心，会根据指定的条件，选择一个或一批符合条件的节点</p>
</li>
<li><p>etcd：键值数据库，保存集群信息，一般要部署奇数个节点（至少三个以上，避免脑裂的情况）。做了存储层面的内容，尽可能将etcd独立出来，不要和master节点部署到一台服务器上。</p>
</li>
</ul>
<p>最重要的，etcd集群一定要部署在SSD硬盘上，强制性要求，不能缩水。否则会导致整个集群运行缓慢。</p>
<p>注意：尽量将master节点设置污点，不允许master节点部署应用程序！</p>
<p>2.3 node节点（工作节点）</p>
<ul>
<li>kubelet： 负责监听节点上的pod状态，同时负责上报节点和节点上的Pod信息，负责与master节点进行通信，管理节点上的pod</li>
<li>kube-proxy：负责Pod之间的通信和负载均衡，将指定的流量分发到后端正确的机器上。</li>
</ul>
<p>查看kube-proxy的运行模式<br>curl 127.0.0.1:10249/proxyMode</p>
<ul>
<li>ipvs：监听master节点增加和删除Service和Endpoint的消息，调用Netlink接口创建相应的ipvs规则。例如，通过该规则关联物理端口与集群内Pod的访问地址信息。通过ipvs规则，将流量转发到相应的Pod上。</li>
<li>iptables：同ipvs功能相同，不同点在于，对于每一个Service都要创建一条iptables规则，将service的ClusterIP代理到后端对应的pod上。在iptables规则增多后，其性能会急剧下降。ipvs为内核级转发。</li>
</ul>
<p>2.4 常用Pod</p>
<ul>
<li><p>Calico：符合CNI标准的网络插件，给每个Pod生成一个唯一的IP地址，并且把每个节点当作一个路由器。支持网络流量策略。对比Cilium eBPF</p>
</li>
<li><p>CoreDNS：用于kubernetes集群内部Service的解析，可以让Pod把Service名称解析成IP地址，然后通过Service的IP地址连接到对应的应用上。</p>
</li>
</ul>
<p>一般认为Service网段中的第一个地址是留给kubernetes使用的，而第10个地址是留给CoreDNS使用的。</p>
<p>查：如何控制CoreDNS的个数？工具是哪个？</p>
<ul>
<li>Docker：容器引擎</li>
</ul>
<p>2.5 Pod</p>
<p>Pod具有隔离性，通过namespace进行隔离。</p>
<p>无隔离性的资源：PV、RBAC（clusterrole、clusterrolebinding）、storageclass、ingressclass</p>
<p>2.5.1 Pod概念</p>
<p>k8s中最小的单元，由一个或者多个容器组成，每个pod还包含一个Pause容器，Pause容器是pod的父容器，主要负责僵尸进程的回收管理， 通过Pause容器可以使同一个Pod中的多个容器共享存储（volume）、网络、PID、IPC等资源。</p>
<p>注意：对于docker容器，一个Container中最多启动一个进程，这样在退出、删除、杀死进程操作时，不会对其它的进程造成影响，事实上的进程隔离。</p>
<p>为何使用Pod这个概念？</p>
<pre><code>1. 一个Pod中多个容器，一个系统由多个微服务进行支撑，微服务中服务的强依赖性，通信延迟低或者数据依赖性
2. 兼容符合CRI标准的不同的容器技术，例如containerd、CRI-O等</code></pre><p>2.5.2 Pod编写解析</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1 <span class="token comment" spellcheck="true"># 必选, API的版本号</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod <span class="token comment" spellcheck="true"># 必选,类型Pod</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 必选,元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx  <span class="token comment" spellcheck="true"># 必选,符合RFC 1035规范的Pod名称</span>
  <span class="token comment" spellcheck="true"># namespace: default # 可选，Pod所在的命名空间，不指定默认为default, 可以使用 -n 指定namespace 注意：一般手动指定目标namespace，使用-n参数</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 可选,标签选择器,一般用于过滤和区分Pod</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">role</span><span class="token punctuation">:</span> frontend <span class="token comment" spellcheck="true"># 可以写多个</span>
  <span class="token key atrule">annotations</span> <span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 可选,注释列表,可以写多个</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 必选,用于定义容器的详細信息</span>
  <span class="token key atrule">initContainers</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 初始化容器,在容器启动之前执行的一些初始化操作，可以有多个，类似list或者数组，使用"-"进行区分</span>
  <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> sh
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>C
    <span class="token punctuation">-</span> echo "I am InitContainer for init some configuration"
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token key atrule">name</span><span class="token punctuation">:</span> init<span class="token punctuation">-</span>container
  <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30 </span><span class="token comment" spellcheck="true"># 设置Pod终止之前的等待时间，等待资源处理的时间</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 必选,容器列表</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx <span class="token comment" spellcheck="true"># 必选,符合RFC 1035规范的容器名称</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.16.1 <span class="token comment" spellcheck="true"># 必选,容器所用的镜像的地址，注意需要添加为自有的容器管理地址，例如10.0.98.90:5000/test/nginx:1.16.1</span>
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always <span class="token comment" spellcheck="true"># 可选,镜像拉取策略,ifNotPresent，如果宿主机有该镜像就不再拉取；Always：总是拉取；Never：不管是否存在都不拉取</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 可选,容器启动执行的命令，该处command相当于docker容器内的 ENTRYPOINT ，arg相当于docker容器中的 CMD命令</span>
    <span class="token punctuation">-</span> nginx
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>g
    <span class="token punctuation">-</span> <span class="token string">"daemon off;"</span>
    <span class="token key atrule">workingDir</span><span class="token punctuation">:</span> /usr/share/nginx/html <span class="token comment" spellcheck="true"># 可选,容器的工作目录，在登录容器后会定位到该目录下</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 可选,存储卷配置,可以配置多个</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> webroot <span class="token comment" spellcheck="true"># 存储卷名称</span>
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /usr/share/nginx/html <span class="token comment" spellcheck="true"># 挂载目录</span>
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true  </span><span class="token comment" spellcheck="true"># 只读</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 可选,容器需要暴露的端口号列表</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http  <span class="token comment" spellcheck="true"># 端口名称</span>
      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80 </span><span class="token comment" spellcheck="true"># 端口号</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP <span class="token comment" spellcheck="true"># 端口协议,默认TCP</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 可选，环境变量配置列表</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ <span class="token comment" spellcheck="true"># 变量名</span>
      <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai <span class="token comment" spellcheck="true"># 变量的值</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> LANG
      <span class="token key atrule">value</span><span class="token punctuation">:</span> en US.utf8
    <span class="token key atrule">resources</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 可选，资源限制和资源请求限制</span>
      <span class="token key atrule">limits</span><span class="token punctuation">:</span>   <span class="token comment" spellcheck="true"># 资源的最大限制</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 1000m
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 1024Mi
      <span class="token key atrule">requests</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 启动所需的资源</span>
        <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
        <span class="token key atrule">memory</span><span class="token punctuation">:</span> 512Mi
<span class="token comment" spellcheck="true"># 三种健康检查方式：startupProbe、readinessProbe、livenessProbe</span>
<span class="token comment" spellcheck="true">#    startupProbe: # 可选,检测容器内进程是否完成启动。注意三种检查方式同时只能使用一种:</span>
<span class="token comment" spellcheck="true">#      httpGet: # httpGet检测方式,生产环境建议使用httpGet实现接口级健崇栓套,健。检查由应用程序提供。</span>
<span class="token comment" spellcheck="true">#        path: /api/successStart # 检查路径</span>
<span class="token comment" spellcheck="true">#        port: 80</span>
    <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 可选,健康检查。注可三种检查方式同时只能使用一者,</span>
      <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>      <span class="token comment" spellcheck="true"># httpGet检测方式,生产环境建议使用HttpGet实现接口级健康检查,健康枪查应由应用程序提供。</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> / <span class="token comment" spellcheck="true"># 检查路径</span>
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80 </span><span class="token comment" spellcheck="true">#</span>
    <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 可选,健康检套</span>
      <span class="token comment" spellcheck="true">#exec:       #执行容器命令检测方式</span>
           <span class="token comment" spellcheck="true">#command:</span>
           <span class="token comment" spellcheck="true">#- cat</span>
           <span class="token comment" spellcheck="true">#- /health</span>
    <span class="token comment" spellcheck="true">#httpGet: #httpGet检测方式</span>
    <span class="token comment" spellcheck="true">#   path: /_health # 检查路径</span>
    <span class="token comment" spellcheck="true">#   port: 8088</span>
    <span class="token comment" spellcheck="true">#   httpHeaders:  # 检查的请求头</span>
    <span class="token comment" spellcheck="true">#     name: end-user   # 请求头的key值</span>
    <span class="token comment" spellcheck="true">#     value: Jason    # 请求头的value值</span>
      <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 端口检测方式</span>
            <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">initialDelaySeconds</span> <span class="token punctuation">:</span> <span class="token number">60 </span><span class="token comment" spellcheck="true"># 初始化时间</span>
      <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">2  </span><span class="token comment" spellcheck="true"># 超时时间</span>
      <span class="token key atrule">periodSeconds</span> <span class="token punctuation">:</span> <span class="token number">5  </span><span class="token comment" spellcheck="true"># 检测间隔</span>
      <span class="token key atrule">successThreshold</span> <span class="token punctuation">:</span> <span class="token number">1 </span><span class="token comment" spellcheck="true"># 检查成功为2次表示就绪</span>
      <span class="token key atrule">failureThreshold</span> <span class="token punctuation">:</span> <span class="token number">2 </span><span class="token comment" spellcheck="true"># 检测失败1次表示未就绪</span>
    <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 生命周期相关配置</span>
      <span class="token key atrule">postStart</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 容器创建完成后执行的指令,可以是exec httpGet TCPSocket</span>
        <span class="token key atrule">exec</span><span class="token punctuation">:</span>
          <span class="token key atrule">command</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> sh
          <span class="token punctuation">-</span> <span class="token punctuation">-</span>C
          <span class="token punctuation">-</span> <span class="token string">'mkdir /data/'</span>
      <span class="token key atrule">preStop</span><span class="token punctuation">:</span>
        <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
              <span class="token key atrule">path</span><span class="token punctuation">:</span> /
              <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token comment" spellcheck="true">#  exec:</span>
      <span class="token comment" spellcheck="true">#  command:</span>
      <span class="token comment" spellcheck="true">#  - sh</span>
      <span class="token comment" spellcheck="true">#  - -c</span>
      <span class="token comment" spellcheck="true">#  - sleep 9</span>
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always <span class="token comment" spellcheck="true"># 重启策略，可选,默认为Always：容器故障或者没有启动成功，自动重启  Onfailure：容器以不为0的状态终止，也就是异常终止的情况下，自动重启该容器，Never：总是不会重启</span>
  <span class="token comment" spellcheck="true">#nodeSelector: # 可选,指定Node节点</span>
  <span class="token comment" spellcheck="true">#      region: subnet7   # 匹配带有该标签的节点，将pod部署到该节点</span>
  <span class="token key atrule">imagePullSecrets</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 可选,拉取镜像使用的secret,可以配置多个，对应于私有镜像仓库的账号密码</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>dockercfg<span class="token punctuation">-</span><span class="token number">86258</span>
  <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">false </span><span class="token comment" spellcheck="true"># 可选,是否为主机模式,如是,会占用主机端口</span>
  <span class="token key atrule">volumes</span> <span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 共享存储卷列表</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> webroot <span class="token comment" spellcheck="true"># 名称，与上述对应</span>
    <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">#hostPath: # 挂载目录</span>
        <span class="token comment" spellcheck="true">#  path: /etc/hosts # 挂载本机目录</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>测试使用脚本信息</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token comment" spellcheck="true"># pod课程所用到的配置文件</span>

<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1 <span class="token comment" spellcheck="true"># 必选, API的版本号</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod <span class="token comment" spellcheck="true"># 必选,类型Pod</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 必选,元数据</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx  <span class="token comment" spellcheck="true"># 必选,符合RFC 1035规范的Pod名称</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 可选,标签选择器,一般用于过滤和区分Pod</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">role</span><span class="token punctuation">:</span> frontend <span class="token comment" spellcheck="true"># 可以写多个</span>
  <span class="token key atrule">annotations</span> <span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 可选,注释列表,可以写多个</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 必选,用于定义容器的详細信息</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span> <span class="token comment" spellcheck="true"># 必选,容器列表</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx <span class="token comment" spellcheck="true"># 必选,符合RFC 1035规范的容器名称</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.16.1 <span class="token comment" spellcheck="true"># 必选,容器所用的镜像的地址，注意需要添加为自有的容器管理地址，例如10.0.98.90:5000/test/nginx:1.16.1</span>
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> Always <span class="token comment" spellcheck="true"># 可选,镜像拉取策略,ifNotPresent，如果宿主机有该镜像就不再拉取；Always：总是拉取；Never：不管是否存在都不拉取</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 可选,容器启动执行的命令，该处command相当于docker容器内的 ENTRYPOINT ，arg相当于docker容器中的 CMD命令</span>
    <span class="token punctuation">-</span> nginx
    <span class="token punctuation">-</span> <span class="token punctuation">-</span>g
    <span class="token punctuation">-</span> <span class="token string">"daemon off;"</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 可选,容器需要暴露的端口号列表</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http  <span class="token comment" spellcheck="true"># 端口名称</span>
      <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80 </span><span class="token comment" spellcheck="true"># 端口号</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP <span class="token comment" spellcheck="true"># 端口协议,默认TCP</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 可选，环境变量配置列表</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ <span class="token comment" spellcheck="true"># 变量名</span>
      <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai <span class="token comment" spellcheck="true"># 变量的值</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> LANG
      <span class="token key atrule">value</span><span class="token punctuation">:</span> en US.utf8
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always <span class="token comment" spellcheck="true"># 重启策略，可选,默认为Always：容器故障或者没有启动成功，自动重启  Onfailure：容器以不为0的状态终止，也就是异常终止的情况下，自动重启该容器，Never：总是不会重启</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>常用命令：</p>
<pre class="line-numbers language-shell"><code class="language-shell">
kubectl create ns kube-public   # 创建命名空间kube-public

kubectl get po --show-labels  # 查看pod上所携带的labels

kubectl create -f pod.yaml -n kube-public  # 在kube-public命名空间上创建pod，-f指定创建资源的文件来源

kubectl apply -f pod.yaml -n kube-public  # 运行已经创建的pod，如果pod.yaml文件未修改，运行该命令不对之前的镜像造成影响

kubectl describe pod nginx    # 查看名称为nginx的pod当前状态以及配置信息

kubectl delete pod nginx   # 删除名称为nginx的pod
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>遇到问题：</p>
<pre class="line-numbers language-log"><code class="language-log"># kubectl describe pod nginx

.......

  Warning  Failed     7m47s (x4 over 10m)    kubelet            Error: ErrImagePull
  Warning  Failed     7m47s (x2 over 9m36s)  kubelet            Failed to pull image "nginx:1.16.1": rpc error: code = Unknown desc = Error response from daemon: Get https://registry-1.docker.io/v2/library/nginx/manifests/1.16.1: net/http: TLS handshake timeout
  Normal   BackOff    7m35s (x6 over 10m)    kubelet            Back-off pulling image "nginx:1.16.1"
  Warning  Failed     7m24s (x7 over 10m)    kubelet            Error: ImagePullBackOff

# docker pull nginx:1.16.1
Error response from daemon: Get https://registry-1.docker.io/v2/: net/http: TLS handshake timeout
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>解决方式：重新配置docker服务的daemon.json文件，配置完成后重启docker服务，等待集群自动恢复。</p>
<pre class="line-numbers language-json"><code class="language-json">
<span class="token punctuation">{</span>
    <span class="token property">"exec-opts"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"native.cgroupdriver=systemd"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"registry-mirrors"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">"https://registry.cn-hangzhou.aliyuncs.com"</span><span class="token punctuation">,</span>
        <span class="token string">"https://docker.mirrors.ustc.edu.cn"</span><span class="token punctuation">,</span>
        <span class="token string">"https://registry.docker-cn.com"</span><span class="token punctuation">,</span>
        <span class="token string">"http://hub-mirror.c.163.com"</span><span class="token punctuation">,</span>
        <span class="token string">"https://mirror.baidubce.com"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token property">"insecure-registries"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"harbor.xxx.cn:30002"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> // 这个配置项可以不用添加
    <span class="token property">"live-restore"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">"log-driver"</span><span class="token operator">:</span> <span class="token string">"json-file"</span><span class="token punctuation">,</span>
    <span class="token property">"log-opts"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"max-size"</span><span class="token operator">:</span> <span class="token string">"50m"</span><span class="token punctuation">,</span>
        <span class="token property">"max-file"</span><span class="token operator">:</span> <span class="token string">"3"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2.5.3 Pod探针</p>
<p>探针分类：</p>
<ul>
<li>startupProbe：k8s 1.16版本后，用于判断容器内应用程序是否启用。如果配置了该项，就会禁止其它探针的运行，优先判断startupProbe的状态，只要探测成功后就不再进行探测。如果程序启动比较慢，建议使用。</li>
<li>livenessProbe：用于探测容器是否运行，如果探测失败，kubelet会根据配置的重启策略进行处理。如果没有配置该探针，默认就是success。决定容器是否重启</li>
<li>readinessProbe：用于探测容器内的程序是否健康，其返回值如果为success，那么就代表这个容器已经完全启动，并且程序已经是可以接收流量的状态。</li>
</ul>
<p>检测方式分类（每个探针都包含）：</p>
<ul>
<li>ExecAction：在容器内执行命令，如果返回值为0，则容器健康。</li>
<li>TCPSocketAction：通过tcp连接检查容器内端口是否连通，如果是通的，就认为容器健康。（可能存在端口已经启动，但pod中的容器无法连接的情况）</li>
<li>HTTPGetAction: 通过应用程序暴露的api地址来检测程序是否是正常的，如果返回的状态码为大于等于200到小于400之间，则认为容器健康。（最常用，生产）</li>
</ul>
<p>在公司日常开发中一定要求微服务暴露readiness和liveness相对应的接口信息。</p>
<p>常用命令：</p>
<pre><code>kubectl get deployment -n kube-system

kubectl edit deploy coredns -n kube-system  # 在线编辑名称为coredns的deployment配置信息

watch kubectl get pod   # watch 循环查看某条命令的运行状态

kubectl replace -f pod.yaml  # 根据pod.yaml中配置替换已有的资源</code></pre><p>参考问题：</p>
<p><a href="https://my.oschina.net/zhangshoufu/blog/4871452" target="_blank" rel="noopener">为什么引入startupProbe</a></p>
<p>（此观点错误） <del>startupProbe配置时，针对Spring Cloud微服务的场景，可以考虑使用ExecAction的方式，判断java进程是否存在，如果java进程已经存在了，可以认为pod正常运行了。</del> 存在进程存在而readiness不工作，造成pod不能重启</p>
<p>2.5.3.1 探针检查参数配置</p>
<ul>
<li>initialDelaySeconds : 60 # 初始化时间，在pod启动后等待60秒后进行检查，不建议设置太长，否则滚动发布周期会拉长，等待时间过长</li>
<li>timeoutSeconds: 2  # 超时时间，执行命令多长时间内能返回信息，一般设置1到2秒</li>
<li>periodSeconds : 5  # 检测间隔</li>
<li>successThreshold : 1 # 检查成功为1次表示就绪，例如接口成功返回信息一次代表成功</li>
<li>failureThreshold : 2 # 检测失败2次表示未就绪，不要设置为1次，可能存在网络波动的情况导致检测不成功</li>
</ul>
<p>pod有时不能直接使用apply和replace进行替换，可能会出现替换不成功的情况，但其它高级资源可以，例如deployment。所以针对pod的操作要先删除，再创建新的。</p>
<p>readiness和liveness在配置时都使用接口级别的健康检查，这两个接口由服务提供，尽量不使用linux命令进行，例如在command下执行pgrep java命令查看java进程是否存在来判断liveness状态。<br>如果遇到上述情况，会出现以下现象，readiness接口返回信息已经表示服务不可用，而liveness的判断中，java进程始终存在，造成整个pod处于0/1的状态，无法接受流量，也无法进行重启来恢复。</p>
<p>2.5.4 lifeCycle配置–postStart和preStop</p>
<p>同probe的区别时，lifeCycle中的配置没有健康检查的各个探针参数配置。</p>
<p>postStart使用风险：postStart并不能保证在initContainers中的command之后执行，，二者可能同时执行。如果面临一些高危权限的操作，建议将这些操作放在initContainers中的command下面设置并执行。</p>
<p>postStart常用于创建文件或者创建文件夹这样的操作。</p>
<p>2.5.4.1 preStop</p>
<p>terminationGracePeriodSeconds: 30  k8s预留的终止时间，默认30秒，可以自行改动，允许在该时间内处理容器终止后的清理或者收尾工作。<br>设置时，需要放在containers之上。但是和preStop中在</p>
<p>Pod终止流程</p>
<p>用户执行删除操作———-1. 变更pod状态为Terminating<br>                   |<br>                   ——2. （存在Service的情况下）Endpoint删除该Pod内的IP地址<br>                   |<br>                   ——3. 执行preStop的指令</p>
<p>以Spring Cloud中的微服务为例，Eureka组件进行描述。</p>
<p>pod删除前，预留的时间由terminationGracePeriodSeconds配置信息决定，而如果在preStop中配置命令，例如：</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">      <span class="token key atrule">preStop</span><span class="token punctuation">:</span>
        <span class="token key atrule">exec</span><span class="token punctuation">:</span>
          <span class="token key atrule">command</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> sh
            <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
            <span class="token punctuation">-</span> sleep 90<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>则pod删除前，不会真正sleep 90秒，通过time命令查看执行时间，接近于terminationGracePeriodSeconds设定的时间。</p>
<p>如果设置sleep低于terminationGracePeriodSeconds配置的时间，而任务恰好能在sleep设置的时间内可以完成，则sleep生效，否则还是以terminationGracePeriodSeconds为准。</p>
<p>常用命令：</p>
<pre><code>
kubectl get event  # 查看默认namespace的事件

time kubectl delete pod nginx  # 查看该条命令的执行时间

</code></pre><p>注意：终止进程尽量使用kill <pid>或者kill -15 <pid>，禁止使用kill -9。最佳实践为kill <code>pgrep java</code>，前提是镜像支持pgrep命令。</pid></pid></p>
<p>2.6 RC &amp;&amp; RS</p>
<ul>
<li>Replication Controller : 可以保证Pod副本数达到期望值，可以确保一个Pod或者一组同类Pod总是可用。已经被废弃</li>
<li>ReplicaSet ：复制集。至此基于集合的标签选择器的下一代RC，主要用作Deployment协调创建、删除和更新Pod。和RC唯一区别是ReplicaSet支持标签选择器</li>
</ul>
<p>RC和RS不支持回滚，必须使用更高级资源（Deployment或者DaemonSet）进行管理，再通过RS去管理下面的Pod。</p>
<p>极少单独使用，主要是配合Deployment、StatefulSet以及DaemonSet去管理。一般建议使用Deployment来自动管理ReplicaSet。</p>
<p>2.7 Deployment</p>
<ul>
<li>Deployment：无状态服务</li>
<li>StatefulSet：有状态应用，例如Redis主从、RabbitMQ</li>
<li>DaemonSet：在每个节点上都会启动一个容器</li>
</ul>
<p>2.7.1 Deployment概念</p>
<p>用于部署无状态服务，最常用的控制器。一般用于管理维护企业内部无状态的微服务。</p>
<p>可以管理多个副本的Pod，实现无缝迁移、自动扩容缩容、自动灾难恢复、一键回滚等功能。</p>
<p>常用命令：</p>
<pre><code>
kubectl create deployment nginx --image=nginx:1.16.1  # 手动创建deployment

kubectl create deployment nginx --image=nginx:1.16.1 -o yaml &gt; nginx-deployment.yaml   # 将创建的deployment文件导出

kubectl replace -f nginx-deployment.yaml  # 通过配置文件替代当前namespace中的deployment配置

kubectl edit deployment nginx        # 在线编辑名称为nginx的deployment

# 重启deploy
kubectl patch deployment &lt;deployment-name&gt; \
  -p &#39;{&quot;spec&quot;:{&quot;template&quot;:{&quot;spec&quot;:{&quot;containers&quot;:[{&quot;name&quot;:&quot;&lt;container-name&gt;&quot;,&quot;env&quot;:[{&quot;name&quot;:&quot;RESTART_&quot;,&quot;value&quot;:&quot;&#39;$(date +%s)&#39;&quot;}]}]}}}}&#39;

# 示例
kubectl patch deployment weichai-les-app \
  -p &#39;{&quot;spec&quot;:{&quot;template&quot;:{&quot;spec&quot;:{&quot;containers&quot;:[{&quot;name&quot;:&quot;&lt;container-name&gt;&quot;,&quot;env&quot;:[{&quot;name&quot;:&quot;RESTART_&quot;,&quot;value&quot;:&quot;&#39;$(date +%s)&#39;&quot;}]}]}}}}&#39;
</code></pre><p>配置文件：</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2021-01-14T13:26:49Z"</span>
  <span class="token key atrule">generation</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">progressDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">600</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3            </span><span class="token comment" spellcheck="true"># 副本数</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10   </span><span class="token comment" spellcheck="true"># 历史记录保存个数</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>               <span class="token comment" spellcheck="true"># 滚动升级更新策略</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
  <span class="token key atrule">template</span><span class="token punctuation">:</span>                <span class="token comment" spellcheck="true"># 从该节点往下配置的信息同pod中的配置项</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.16.1
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log
        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File
      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler
      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意：尽量不要在deployment运行状态下直接修改配置中的labels信息，例如selector下matchLabels、template下的labels。无论是增加还是删除，如果修改后，可能会造成ReplicaSet资源无法删除的情况。修改labels参数，会造成启动新的ReplicaSet，而新的RS具有新的label，就无法管理之前的label了。</p>
<p>注意：可以在~/.kube/config中找到连接k8s的配置文件，配合kubectl命令在任意机器都可以连接k8s集群。</p>
<p>2.7.2 deployment状态解析</p>
<pre class="line-numbers language-shell"><code class="language-shell">
# # kubectl get pod -o wide
# NAME                     READY   STATUS    RESTARTS   AGE   IP               NODE          NOMINATED NODE   READINESS GATES
# nginx-7f785d94f5-74fr8   1/1     Running   0          19m   172.175.44.13    k8s-node-01   <none>           <none>
# nginx-7f785d94f5-tmqfd   1/1     Running   0          18m   172.175.44.14    k8s-node-01   <none>           <none>
# nginx-7f785d94f5-vcsnk   1/1     Running   0          25m   172.163.98.145   k8s-node-02   <none>           <none>

$ kubectl get deployment -o wide
NAME    READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         SELECTOR
nginx   3/3     3            3           29m   nginx        nginx:1.16.1   app=nginx
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>NAME  — deployment名称，同一个namespace下不能使用相同的名称</li>
<li>READY — pod的状态，上面命令中存在3个副本，3个已经启动</li>
<li>UP-TO-DATE  —-  已经达到期望状态的被更新的副本数</li>
<li>AVAILABLE —–  已经可以用的副本数</li>
<li>AGE    ——-   显示应用程序运行的时间</li>
<li>CONTAINERS  —–  容器名称</li>
<li>IMAGES   —— 容器的镜像</li>
<li>SELECTOR  —— 管理Pod的标签</li>
</ul>
<p>常用命令</p>
<pre><code>kubectl get pod --show-labels # 查看pod的Labels

kubectl get deploy -o yaml | grep image # 以yaml的方式输出配置信息，并且筛选查看image内容

kubectl set image deploy nginx nginx=nginx:1.15.2 --record  # --record 记录当前更改的参数，根据record下的信息可以查看各个版本的参数信息

kubectl rollout status deploy nginx   # 查看滚动更新的进度
</code></pre><p>注意：deployment通过ReplicaSet来管理Pod。</p>
<p>如何触发deployment的更新，生成新的ReplicaSet？只有在修改配置文件下的spec节点下的templete配置信息后。</p>
<p>2.7.3 滚动更新示意</p>
<p>修改nginx的docker image版本后，重新生成新的ReplicaSet，然后更新Pod信息。</p>
<p>修改命令如下：</p>
<pre><code>kubectl set image deploy nginx nginx=nginx:1.15.2 --record
</code></pre><p>通过describe命令查看如下：</p>
<pre><code>$ kubectl describe deploy nginx
......
Events:
  Type    Reason             Age    From                   Message
  ----    ------             ----   ----                   -------
  Normal  ScalingReplicaSet  57m    deployment-controller  Scaled up replica set nginx-7f785d94f5 to 2
  Normal  ScalingReplicaSet  56m    deployment-controller  Scaled up replica set nginx-7f785d94f5 to 3
  Normal  ScalingReplicaSet  6m42s  deployment-controller  Scaled up replica set nginx-66bbc9fdc5 to 1
  Normal  ScalingReplicaSet  6m41s  deployment-controller  Scaled down replica set nginx-7f785d94f5 to 2
  Normal  ScalingReplicaSet  6m41s  deployment-controller  Scaled up replica set nginx-66bbc9fdc5 to 2
  Normal  ScalingReplicaSet  6m40s  deployment-controller  Scaled down replica set nginx-7f785d94f5 to 1
  Normal  ScalingReplicaSet  6m40s  deployment-controller  Scaled up replica set nginx-66bbc9fdc5 to 3
  Normal  ScalingReplicaSet  6m38s  deployment-controller  Scaled down replica set nginx-7f785d94f5 to 0
</code></pre><p>注意：在更新手段上，尽可能使用kubectl edit命令或者修改yaml格式的配置文件使用kubectl replace命令更新deployment。</p>
<p>微服务版本发布时，可以直接使用set命令进行更新。</p>
<p>2.7.4 回滚示意</p>
<p>查看滚动更新的历史记录</p>
<pre><code>$ kubectl rollout history deployment nginx

deployment.apps/nginx
REVISION  CHANGE-CAUSE
1         &lt;none&gt;
2         kubectl set image deploy nginx nginx=nginx:1.15.2 --record=true
3         kubectl set image deploy nginx nginx=nginx:1.17.7 --record=true

</code></pre><p>回滚到上一个版本</p>
<pre><code>$ kubectl rollout undo deployment nginx
</code></pre><p>查看指定版本的详细信息</p>
<pre><code>$ kubectl rollout history deployment nginx --revision=3
deployment.apps/nginx with revision #3
Pod Template:
  Labels:       app=nginx
        pod-template-hash=6d96fd594b
  Annotations:  kubernetes.io/change-cause: kubectl set image deploy nginx nginx=nginx:1.17.7 --record=true
  Containers:
   nginx:
    Image:      nginx:1.17.7
    Port:       &lt;none&gt;
    Host Port:  &lt;none&gt;
    Environment:        &lt;none&gt;
    Mounts:     &lt;none&gt;
  Volumes:      &lt;none&gt;
</code></pre><p>回滚到指定版本</p>
<pre><code>kubectl rollout history deployment nginx --to-revision=3

</code></pre><p>2.7.5 扩容和缩容</p>
<p>可以对Deployment、ReplicaSet进行扩容</p>
<pre><code>kubectl scale --replicas=3 deployment nginx
</code></pre><p>注意：扩容和缩容命令不会产生新的ReplicaSet（未修改spec.templete下的内容），但仅限于预期内的扩容操作。有关指标信息引起的自动扩容和缩容操作，使用HPA实现。</p>
<p>2.7.6 更新暂停和恢复</p>
<p>更新多出内容只触发一次更新。</p>
<p>第一种方式，直接通过kubectl edit命令修改deployment的配置信息</p>
<pre class="line-numbers language-shell"><code class="language-shell">
kubectl edit deploy nginx
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>第二种方式，更新暂停和恢复</p>
<pre class="line-numbers language-shell"><code class="language-shell">
// 更新暂停命令
kubectl rollout pause deploy nginx

// 多次进行set
// 修改镜像版本
kubectl set image deploy nginx nginx=nginx:1.15.5 --record

// 修改镜像pod数量
kubectl scale --replicas=2 deployment nginx

// 修改cpu配置
kubectl set resources deploy nginx --limits=cpu=200m,memory=120Mi  --requests=cpu=10m,memory=16Mi

// 查看配置信息
kubectl get deploy -oyaml

// 更新恢复命令
kubectl rollout resume deploy nginx
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>2.7.7 滚动更新策略</p>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token punctuation">...</span><span class="token punctuation">...</span>
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
      <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
        <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%       <span class="token comment" spellcheck="true"># 可以超过期望值的最大Pod数，可选，默认25%，可设置数字或者百分比，若该值为0，则maxUnavailable不能为0</span>
        <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%   <span class="token comment" spellcheck="true"># 指定在回滚或者更新时最大不可用的Pod数量，可选，默认25%，可设置数字或者百分比，若该值为0，则maxSurge不能为0</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate   <span class="token comment" spellcheck="true"># 更新deployment的方式，默认RollingUpdate（滚动更新），其它还有Recreate（先删除旧的Pod，再创建新的Pod）</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>其它：<br>.spec.revisionHistoryLimit: 设置保留ReplicaSet历史记录，即revision的数量，设置为0，则不保留历史记录。<br>.spec.minReadySeconds: 可选参数，指定新创建的Pod在没有任何容器崩溃的情况下，视为其状态已经Ready（准备完成）的最小的秒数，默认为0，即一旦被创建就视为Pod可用。</p>
<p>2.8 StatefulSet</p>
<p>StatefulSet (有状态集，缩写为sts）常用于部署有状态的且需要有序启动的应用程序，比如在进行SpringCloud项目容器化时，Eureka的部署是比较适合用StatefblSet部署方式的，可以给每个Eureka实例创建一个唯一且固定的标识符，并且每个Eureka实例无需配置多余的Service，其余Spring Boot应用可以直接通过Eureka的Headless Service即可进行注册。</p>
<p>2.8.1 基本概念</p>
<p>StatefblSet 主要用于管理有状态应用程序的工作负戟API对象。比如在生产环境中.可以部署ElasticSearch集群、MongoDB集群或者需要持久化的RabbitMQ集群、Redis集群、Kafka集群和zookeeper集群等。和Deployment类似，一个StatefulSet也同样管理着基于相同容器规范的Pod。不同的是，StatefulSet为每个Pod维护了一个粘性标识。这些Pod是根据相同的规范创建的，但是不可互换.每个 Pod 都有一个持久的标识符.在重新调度时也会保留，一般格式为 StatefulSetName-Number。比如定义一个名字是Redis-Sentinel的StatefulSet，指定创建三个Pod，那么创建出来的<br>Pod 名字就为 Redis-Sentinel-0、Redis-Sentinel-1、Redis-Sentinel-2。而 StatefiilSet 创建的 Pod 一般使用Headless Service (无头服务）进行通信。和普通的Service的区别在于 Headless Service没有ClusterIP，它使用的是 Endpoint进行互相通信。</p>
<p>Headless—般的格式为：</p>
<pre><code>statefulSetName-{0...N-1}.serviceName.namespace.svc.cluster.local
</code></pre><p>说明：</p>
<ul>
<li>serviceName为Headless Service的名字，创建StatefulSet时，必须指定Headless Service的名称;</li>
<li>0…N-1为Pod所在的序号，从0开始到N-1;</li>
<li>statefulSetName为StatefulSet的名字:</li>
<li>namespace为服务所在的命名空间;</li>
<li>.cluster.local为Cluster Domain(集群域)。</li>
</ul>
<p>假如公司某个项目需要在Kubernetes中部署一个主从模式的Redis，此时使用StatefulSet部署就极为合适，因为StatefulSet启动时，只有当前一个容器完全启动时，后一个容器才会被调度，并且每个容器的标识符是固定的，那么就可以通过标识符来断定当前Pod的角色。</p>
<p>比如用一个名为redis-ms的StatefulSet部署主从架构的Redis，该StatefulSet部署在名为public-service的命名空间中。第一个容器启动时，它的标识符为redis-ms-0，并且Pod内主机名也为redis-ms-0，此时就可以根据主机名来判断，当主机名为redis-ms-0的容器作为Redis的主节点，其余容器作为从节点，那么Slave连接Master主机配置就可以使用不会更改的Master的Headless Service，此时Redis从节点(Slave)配置的链接信息为:</p>
<pre><code>redis-ms-0.redis-ms.public-service.svc.cluster.local</code></pre><p>2.8.2 注意事项</p>
<p>一般StatefulSet用于有以下一个或者多个需求的应用程序:</p>
<ul>
<li>需要稳定的独一无二的网络标识符。</li>
<li>需要持久化数据。</li>
<li>需要有序的、优雅的部署和扩展。</li>
<li>需要有序的自动滚动更新。</li>
</ul>
<p>如果应用程序不需要任何稳定的标识符或者有序的部署、删除或者扩展，应该使用无状态的控制器部署应用程序，比如Deployment或者ReplicaSet。</p>
<p>StatefulSet是Kubernetes 1.9版本之前的beta资源，在1.5版本之前的任何Kubernetes版本都没有。</p>
<p>Pod所用的存储必须由PersistentVolume Provisioner(持久化卷配置器)根据请求配置StorageClass，或者由管理员预先配置，当然也可以不配置存储。</p>
<p>为了确保数据安全，删除和缩放StatefulSet不会删除与StatefulSet关联的卷，可以手动选择性地删除PVC和PV(关于PV和PVC请参考2.2.12节)</p>
<p>StatefulSet目前使用Headless Service(无头服务)负责Pod的网络身份和通信，需要提前创建此服务。</p>
<p>删除一个StatefulSet时，不保证对Pod的终止，要在StatefulSet中实现Pod的有序和正常终止，可以在删除之前将StatefulSet的副本缩减为0。</p>
<p>2.8.3 创建一个StatefulSet</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> web
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None  <span class="token comment" spellcheck="true"># None--该Service不会存在ClusterIp，但是依旧可以通过Headless Service访问到StatefulSet</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> web
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx <span class="token comment" spellcheck="true"># has to match .spec.template.metadata.labels</span>
  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> <span class="token string">"nginx"</span>   <span class="token comment" spellcheck="true"># 注意：该serviceName必须指定一个已经存在的Service</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">2 </span><span class="token comment" spellcheck="true"># by default is 1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx <span class="token comment" spellcheck="true"># has to match .spec.selector.matchLabels</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.16.1
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> web
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建StatefulSet：</p>
<pre><code>kubectl create -f nginx-statefulset.yaml</code></pre><p>扩容StatefulSet：</p>
<pre><code>kubectl scale --replicas=3 sts web
</code></pre><p>启动busybox访问我们前面创建的StatefulSet：</p>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> busybox
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> app
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox<span class="token punctuation">:</span><span class="token number">1.28</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> sleep
      <span class="token punctuation">-</span> <span class="token string">"3600"</span>
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> ifNotPresent
  <span class="token key atrule">restartPoicy</span><span class="token punctuation">:</span> Always
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>命令如下：</p>
<pre><code>
kubectl apply -f busybox.yaml

// 进入容器内执行命令的操作
kubectl exec -it busybox -- sh
/ # nslookup web-0.nginx
Server:    10.96.0.10
Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local

Name:      web-0.nginx
Address 1: 172.163.98.154 web-0.nginx.default.svc.cluster.local
</code></pre><p>这里直接将Service解析到Pod的ip地址了，由于ClusterIP配置的为None，所以不需要转换即可解析。</p>
<p>2.8.4 StatefulSet扩容缩容</p>
<p>如果启动过程中，名称为web-0、web-1的Pod已经启动完毕，准备启动web-2的Pod时，web-0 Pod挂掉了，这时候web-2不会启动，而是等待web-0重新恢复后再进行web-2的启动。也就是说，在创建下一个pod之前，前面创建的pod存在任何的故障，下一个pod都不会被创建，而是等待所有的pod变为ready之后再启动下一个pod。</p>
<p>在Pod删除时，会先从web-2 pod开始，逐步删除web-1、web-0 这两个Pod。</p>
<p>查看所有的pod动态变化的状态：</p>
<pre><code>kubectl get pod -l app=nginx -w

// 或者是使用

watch kubectl get pod -l app=nginx
</code></pre><p>通过改变副本数，来查看整个变化趋势！</p>
<pre><code>// 扩容操作
kubectl scale --replicas=5 sts web

// 缩容操作
kubectl scale --replicas=3 sts web
</code></pre><p>2.8.5 StatefulSet更新策略</p>
<p>deployment为随机无序更新</p>
<p>StatefulSet的更新方式–RollingUpdate、OnDelete</p>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token string">"2021-01-17T03:45:43Z"</span>
  <span class="token key atrule">generation</span><span class="token punctuation">:</span> <span class="token number">5</span>
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">podManagementPolicy</span><span class="token punctuation">:</span> OrderedReady
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.16.1
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> web
          <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log
        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File
      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler
      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">partition</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
<span class="token key atrule">status</span><span class="token punctuation">:</span>
  <span class="token key atrule">collisionCount</span><span class="token punctuation">:</span> <span class="token number">0</span>
  <span class="token key atrule">currentReplicas</span><span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token key atrule">currentRevision</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>78c4f54fd4
  <span class="token key atrule">observedGeneration</span><span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token key atrule">readyReplicas</span><span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token key atrule">updateRevision</span><span class="token punctuation">:</span> web<span class="token punctuation">-</span>78c4f54fd4
  <span class="token key atrule">updatedReplicas</span><span class="token punctuation">:</span> <span class="token number">5</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>重点在于，更新时，sts会先更新web-2 的Pod，待web-2更新完成后，再去更新web-1。如果这时候web-0被删除或者因意外不可用，则更新不会继续，会等待web-0恢复后再进行更新。也就是说，在RollingUpdate模式下，StatefulSet是正序去创建，倒序去更新！</p>
<p>查看更新状态：</p>
<pre><code>// 不太准确的方式
kubectl rollout status sts web

// 精准模式
watch kubectl get pod -l app=nginx
</code></pre><p>使用edit方式修改sts的镜像信息：</p>
<pre><code>kubectl edit sts web
</code></pre><p>OnDelete方式更新如下：</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">  <span class="token punctuation">...</span><span class="token punctuation">...</span>
  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> OnDelete

  <span class="token punctuation">...</span><span class="token punctuation">...</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>更改为OnDelete模式后，只有把Pod进行删除操作，它才会去更新该Pod。</p>
<pre><code>kubectl delete pod web-2
</code></pre><p>此时查看StatefulSet下的不同的Pod，查看修改的镜像版本信息:</p>
<pre><code>kubectl get pod web-2 -oyaml | grep image

kubectl get pod web-0 -oyaml | grep image
</code></pre><p>RollingUpdate模式下设置partition信息，代表更新大于partition个数的Pod。</p>
<p>分段更新：partion设置为2，保留尾缀小于2的pod，也就是不更新web-0、web-1，更新web-2、web-3、web-4。</p>
<p>—————|<br>web-0   web-1  | web-2   web-3   web-4<br>—-不更新—–| ———更新———|</p>
<p>这样就实现了简单的灰度发布。</p>
<p>如果partition设置为0，则表示保留尾缀小于0的pod，由于尾缀小于0的pod不存在，故进行全部更新。</p>
<p>使用edit方式修改sts的镜像信息：</p>
<pre><code>kubectl edit sts web

// 修改rollingUpdate并且修改partition为0
</code></pre><p>2.8.6 StatefulSet级联删除和非级联删除</p>
<p>级联删除，删除StatefulSet时同时删除Pod。<br>非级联删除，删除StatefulSet时不删除Pod，日常用的少，仅仅作为了解。</p>
<p>默认使用级联删除</p>
<p>测试级联删除</p>
<pre><code>kubectl delete sts web</code></pre><p>测试非级联删除</p>
<pre><code>kubectl delete sts web --cascade=false

// 新版本下使用
kubectl delete sts web --cascade=orphan</code></pre><p>非级联删除下，Pod变成了孤儿Pod，此时删除Pod不会被重建。</p>
<p>2.9 守护进程服务DaemonSet</p>
<p>2.9.1 DaemonSet的概念和创建</p>
<p>DaemonSet：守护进程集，缩写为ds，在所有节点或者匹配的节点上都部署一个容器。</p>
<p>calico使用DaemonSet进行部署。</p>
<p>应用场景：</p>
<ul>
<li>运行集群存储的daemon，比如ceph、glusterd</li>
<li>节点的CNI网络插件，calico</li>
<li>节点日志的收集，fluentd或者filebeat</li>
<li>节点的监控，node-exporter</li>
<li>服务暴露：部署一个ingress nginx</li>
</ul>
<p>创建DaemonSet</p>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.16.1
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log
        <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File
      <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst
      <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Always
      <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler
      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建命令：</p>
<pre><code>kubectl create -f nginx-daemonset.yaml
</code></pre><p>对node打标签，将DaemonSet部署到特定节点上。（注意）</p>
<pre><code>// 对node打标签
kubectl label node k8s-node-01 k8s-node-02 ds=true
</code></pre><p>修改配置文件</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token key atrule">template</span><span class="token punctuation">:</span>
  <span class="token punctuation">...</span>..
  <span class="token key atrule">spec</span><span class="token punctuation">:</span>
    <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
      <span class="token key atrule">ds</span><span class="token punctuation">:</span> <span class="token string">"true"</span> <span class="token comment" spellcheck="true"># 这个true要写为字符串的形式</span>
    <span class="token key atrule">containers</span><span class="token punctuation">:</span>
<span class="token punctuation">...</span><span class="token punctuation">...</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>重新配置生效：</p>
<pre><code>kubectl replace -f nginx-daemonset.yaml
</code></pre><p>配置完成后，DaemonSet会先进行停止多余的Pod（不含ds=true标签的node节点上的Pod将会被停止），然后再对已保留的Pod进行一次滚动更新，产生一次版本记录。</p>
<p>2.9.2 DaemonSet的更新和回滚</p>
<p>DaemonSet默认的更新配置如下：</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> <span class="token number">1  </span><span class="token comment" spellcheck="true"># 建议最大不可用pod数量写为1，如果升级或者回滚出现问题，可以缩小影响范围</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>更新DaemonSet操作：</p>
<pre><code>kubectl set image ds nginx nginx=nginx:1.15.2 --record

kubectl set image ds nginx nginx=nginx:1.16.1 --record
</code></pre><p>注意：建议使用OnDelete方式去进行更新，这样在更新时，可以先操作单个节点的Pod去进行更新，不会影响其它节点正在运行的Pod。  </p>
<p>2.10 Label和Selector</p>
<p>Label：对k8s中各种资源进行分类分组，添加一个具有特别属性的一个标签。<br>Selector： 通过一些过滤的语法，查找到对应标签的资源。</p>
<p>对一个节点添加label：</p>
<pre><code>kubectl lable node k8s-node-02 region=subnet7
</code></pre><p>通过label筛选出该节点：</p>
<pre><code>kubectl get node -l region=subnet7
</code></pre><p>查看所有容器的labels</p>
<pre><code>kubectl get po -A --show-labels
</code></pre><p>注意：谨慎修改经常变动资源的标签，例如Pod或者Deployment，如果修改后，再进行部署，该修改的标签无效。</p>
<p>labels实践：</p>
<pre><code>// Pod新增label
kubectl label pod busybox state=CN

// Pod删除标签，标签名称后跟上&quot;-&quot;号
kubectl label pod busybox state-

// 根据标签筛选Pod
kubectl get pod -l app=busybox

// 修改已有的标签信息，使用--overwrite
kubectl label pod busybox app=busybox-2 --overwrite
</code></pre><p>selector实践：</p>
<pre><code>// 查看所有pod的labels
kubectl get pod -A --show-labels

// 多条件查找，查找带有k8s-app=metrics-server和k8s-app=dashboard-metrics-scraper的pod
kubectl get pod -A -l &quot;k8s-app in (metrics-server,dashboard-metrics-scraper)&quot;

// 设置pod的label为version=1.0
kubectl label pod web-0 version=1.0

// 筛选pod，label中version不等于1.0且app为nginx的pod
kubectl get pod -l version!=1.0,app=nginx
</code></pre><p>2.11 Service</p>
<p>2.11.1 南北流量和东西流量</p>
<p>在Service Mesh微服务架构中，我们常常会听到东西流量和南北流量两个术语。</p>
<p>南北流量（NORTH-SOUTH traffic）和东西流量（EAST-WEST traffic）是数据中心环境中的网络流量模式。下面我们通过一个例子来理解这两个术语。</p>
<p>假设我们尝试通过浏览器访问某些Web应用。Web应用部署在位于某个数据中心的应用服务器中。在多层体系结构中，典型的数据中心不仅包含应用服务器，还包含其他服务器，如负载均衡器、数据库等，以及路由器和交换机等网络组件。假设应用服务器是负载均衡器的前端。</p>
<p>当我们访问web应用时，会发生以下类型的网络流量：一个是客户端（位于数据中心一侧的浏览器）与负载均衡器（位于数据中心）之间的网络流量；另一个是负载均衡器、应用服务器、数据库等之间的网络流量，它们都位于数据中心。</p>
<ul>
<li>南北流量</li>
</ul>
<p>在这个例子中，前者即即客户端和服务器之间的流量被称为南北流量。简而言之，南北流量是server-client流量。</p>
<ul>
<li>东西流量</li>
</ul>
<p>不同服务器之间的流量与数据中心或不同数据中心之间的网络流被称为东西流量。简而言之，东西流量是server-server流量。</p>
<p>当下，东西流量远超南北流量，尤其是在当今的大数据生态系统中，比如Hadoop生态系统（大量server驻留在数据中心中，用map reduce处理），server-server流量远大于server-client流量。</p>
<p>大家可能会好奇，东西南北，为什么这么命名。</p>
<p>该命名来自于绘制典型network diagrams的习惯。在图表中，通常核心网络组件绘制在顶部（NORTH），客户端绘制在底部（SOUTH），而数据中心内的不同服务器水平（EAST-WEST）绘制。</p>
<p>2.11.2 传统架构服务访问方式和k8s中服务的访问方式</p>
<p>传统架构：</p>
<ul>
<li>nginx反向代理，upstream</li>
<li>Spring Cloud 注册中心，路由表</li>
</ul>
<p>k8s：</p>
<p>服务之间访问，通过Service层面进行访问，利用Service匹配后端Pod的label，来决定流量走向。外部访问整个系统，通过ingress代理到Service层面，再由Service层面匹配后向的Pod对外提供服务。</p>
<p>其实本质都是通过路由表的方式确定服务的访问，只是路由表的表达不同。</p>
<p>2.11.3 什么是Service</p>
<p>为什么不通过ip地址的方式访问pod？Pod被删除后，ip地址就会发生变化，重建后的pod就会更新ip地址，原有的访问ip就失效了。</p>
<p>Service可以简单的理解为逻辑上的一组Pod，一种可以访问Pod的策略，而且其它Pod可以通过Service访问到这个Service代理的Pod。相对于Pod而言，它会有一个固定的名称，一旦创建就固定不变。对比Pod而言更稳定。</p>
<p>常用命令：</p>
<pre><code>kubectl get svc -A // 获取集群中所有的Service信息
</code></pre><p>当Service创建后，会创建一个同名的Endpoint，该Endpoint会指向Pod的ip地址信息。</p>
<p>2.11.3 定义一个Service</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>svc
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>svc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> dns   <span class="token comment" spellcheck="true"># Service端口的名称，最好使用端口用途区分</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80    </span><span class="token comment" spellcheck="true"># Service自己的端口, serviceA-->serviceB    http://serviceB</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP  <span class="token comment" spellcheck="true"># UDP、TCP、STCP，默认TCP</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80 </span><span class="token comment" spellcheck="true"># 后端应用的端口，两个端口可以不一致，但是此处的端口必须保证填写正确</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> https
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">443</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">443</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>       <span class="token comment" spellcheck="true"># 通过这个Selector来过滤后向的Pod信息</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建Service：</p>
<pre><code>kubectl create -f Service.yaml</code></pre><p>查看pod的日志信息</p>
<pre><code>kubectl logs -f --tail=100 nginx-7f785d94f5-p9qxp
</code></pre><p>注意：访问Service时，如果不在同一个namespace中，需要在访问时添加namespace名称，例如：<a href="http://nginx-svc.default。" target="_blank" rel="noopener">http://nginx-svc.default。</a></p>
<p>应用之间的调用，尽量不要使用跨namespace的调用。</p>
<p>Service创建之后，无需关心后端应用有什么变化，直接通过Service访问即可。</p>
<p>2.11.4 通过Service代理k8s外部应用</p>
<p>使用场景：</p>
<ul>
<li>希望在生产环境中使用某个固定的名称而非IP地址访问外部的中间件服务。</li>
<li>希望Service执行另一个namespace中或者其他集群中的服务。</li>
<li>某个项目正在迁移至k8s集群，但一部分服务仍然在集群外部，此时可以使用Service代理至k8s集群外部的服务。</li>
</ul>
<p>代理外部服务的Service</p>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>svc<span class="token punctuation">-</span>external
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>svc<span class="token punctuation">-</span>external
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http   
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80    </span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP  
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80 </span>
  <span class="token comment" spellcheck="true"># 未使用selector，需要自行创建endpoint</span>
  <span class="token key atrule">sessionAffinity</span><span class="token punctuation">:</span> None
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建外部地址的endpoint，以代理百度首页为例：</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Endpoints
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>svc<span class="token punctuation">-</span>external
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>svc<span class="token punctuation">-</span>external  <span class="token comment" spellcheck="true"># endpoint的名称必须和Service的名称一致，否则建立不了连接</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">subsets</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">addresses</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">ip</span><span class="token punctuation">:</span> 220.181.38.148 <span class="token comment" spellcheck="true"># 此处为外部服务的IP地址</span>
  <span class="token comment" spellcheck="true"># 此处端口信息，必须与Service中设置的端口一致，协议一致，名称一致</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80      </span><span class="token comment" spellcheck="true"># 此处为外部服务的端口号</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建Service和Endpoint：</p>
<pre><code>kubectl create -f service-external.yaml
kubectl create -f service-external-endpoint.yaml
</code></pre><p>如果后续发生了地址变更，直接修改Endpoint的地址，不需要修改Service的配置。</p>
<p>注意：apply = replace + create</p>
<p>反向代理外部域名</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>svc<span class="token punctuation">-</span>external<span class="token punctuation">-</span>address
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>svc<span class="token punctuation">-</span>external<span class="token punctuation">-</span>address
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ExternalName
  <span class="token key atrule">externalName</span><span class="token punctuation">:</span> www.baidu.com
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>少用，出现了跨域的情况，访问<a href="http://nginx-svc-external-address，由于先解析到nginx-svc-external-address这个地址，再解析到百度官网地址，导致的跨域。" target="_blank" rel="noopener">http://nginx-svc-external-address，由于先解析到nginx-svc-external-address这个地址，再解析到百度官网地址，导致的跨域。</a></p>
<p>2.11.5 Service类型</p>
<ul>
<li>ClusterIP，在集群内部使用，也是默认值。集群内部可以进行访问，集群外部无法访问。</li>
<li>ExternalName，通过返回定义的CNAME别名，用的少</li>
<li>NodePort: 在所有安装了kube-proxy的节点上开启一个端口，此端口可以代理至后端Pod，然后集群外部可以使用节点的IP地址和NodePort端口号访问到集群Pod的服务。默认端口范围为：30000至32767。限制性使用，对外有限暴露端口号。常见于Redis、RabbitMQ等工具集群化部署后，对外提供服务。（NodePort性能有限）。</li>
<li>LoadBalancer：使用云提供商的负载均衡器公开服务。</li>
</ul>
<p>2.12 Ingress</p>
<p>为何少使用NodePort？在Service比较多的时候，NodePort的性能会急剧下降；过多的Pod带来端口管理的问题。</p>
<p>2.12.1 Ingress概念</p>
<p>Ingress用于实现用域名的方式访问k8s的内部应用。</p>
<p>服务发布的方式：负载均衡设施 –&gt; Ingress –&gt; Service –&gt; Deployment/Pod/DaemonSet/StatefulSet</p>
<p>番外：什么是eBPF？</p>
<p>2.12.2 helm安装Ingress</p>
<p>安装helm3：</p>
<pre><code>// 下载helm 3.5.0 的压缩包
wget https://get.helm.sh/helm-v3.5.0-linux-amd64.tar.gz

// 解压缩
tar -zxvf helm-v3.5.0-linux-amd64.tar.gz

// 将运行文件传入/usr/local/bin/中
mv linux-amd64/helm /usr/local/bin/helm

// 最后执行测试
helm help
</code></pre><p>安装ingress</p>
<pre><code>// 添加ingress仓库
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx

// 查看已添加仓库
helm repo list

// 搜索ingress安装包
helm search repo ingress-nginx

// 下载安装包
helm pull ingress-nginx/ingress-nginx

// 解压安装包
tar -zxvf ingress-nginx-3.20.1.tgz
</code></pre><p>解压完成后需要修改values.yaml文件，修改后如下：</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token comment" spellcheck="true">## nginx configuration</span>
<span class="token comment" spellcheck="true">## Ref: https://github.com/kubernetes/ingress-nginx/blob/master/controllers/nginx/configuration.md</span>
<span class="token comment" spellcheck="true">##</span>

<span class="token comment" spellcheck="true">## Overrides for generated resource names</span>
<span class="token comment" spellcheck="true"># See templates/_helpers.tpl</span>
<span class="token comment" spellcheck="true"># nameOverride:</span>
<span class="token comment" spellcheck="true"># fullnameOverride:</span>

<span class="token key atrule">controller</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> controller
  <span class="token key atrule">image</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># repository: google_containers/ingress-nginx/controller</span>
    <span class="token key atrule">repository</span><span class="token punctuation">:</span> pollyduan/ingress<span class="token punctuation">-</span>nginx<span class="token punctuation">-</span>controller
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"v0.43.0"</span>
    <span class="token comment" spellcheck="true"># digest: sha256:9bba603b99bf25f6d117cf1235b6598c16033ad027b143c90fa5b3cc583c5713</span>
    <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token comment" spellcheck="true"># www-data -> uid 101</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">101</span>
    <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

  <span class="token comment" spellcheck="true"># Configures the ports the nginx-controller listens on</span>
  <span class="token key atrule">containerPort</span><span class="token punctuation">:</span>
    <span class="token key atrule">http</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">https</span><span class="token punctuation">:</span> <span class="token number">443</span>

  <span class="token comment" spellcheck="true"># Will add custom configuration options to Nginx https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/</span>
  <span class="token key atrule">config</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">## Annotations to be added to the controller config configuration configmap</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">configAnnotations</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true"># Will add custom headers before sending traffic to backends according to https://github.com/kubernetes/ingress-nginx/tree/master/docs/examples/customization/custom-headers</span>
  <span class="token key atrule">proxySetHeaders</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true"># Will add custom headers before sending response traffic to the client according to: https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#add-headers</span>
  <span class="token key atrule">addHeaders</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true"># Optionally customize the pod dnsConfig.</span>
  <span class="token key atrule">dnsConfig</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true"># Optionally change this to ClusterFirstWithHostNet in case you have 'hostNetwork: true'.</span>
  <span class="token comment" spellcheck="true"># By default, while using host network, name resolution uses the host's DNS. If you wish nginx-controller</span>
  <span class="token comment" spellcheck="true"># to keep resolving names inside the k8s network, use ClusterFirstWithHostNet.</span>
  <span class="token comment" spellcheck="true"># 使用hostNetwork需要修改为这个值</span>
  <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirstWithHostNet

  <span class="token comment" spellcheck="true"># Bare-metal considerations via the host network https://kubernetes.github.io/ingress-nginx/deploy/baremetal/#via-the-host-network</span>
  <span class="token comment" spellcheck="true"># Ingress status was blank because there is no Service exposing the NGINX Ingress controller in a configuration using the host network, the default --publish-service flag used in standard cloud setups does not apply</span>
  <span class="token key atrule">reportNodeInternalIp</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

  <span class="token comment" spellcheck="true"># Required for use with CNI based kubernetes installations (such as ones set up by kubeadm),</span>
  <span class="token comment" spellcheck="true"># since CNI and hostport don't mix yet. Can be deprecated once https://github.com/kubernetes/kubernetes/issues/23920</span>
  <span class="token comment" spellcheck="true"># is merged</span>
  <span class="token comment" spellcheck="true"># 推荐使用hostNetwork方式去部署，直接使用宿主机的端口号，性能更好。</span>
  <span class="token comment" spellcheck="true"># 可以通过hostNetwork的方式部署到指定的节点上</span>
  <span class="token key atrule">hostNetwork</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

  <span class="token comment" spellcheck="true">## Use host ports 80 and 443</span>
  <span class="token comment" spellcheck="true">## Disabled by default</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">hostPort</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token key atrule">http</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">https</span><span class="token punctuation">:</span> <span class="token number">443</span>

  <span class="token comment" spellcheck="true">## Election ID to use for status update</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">electionID</span><span class="token punctuation">:</span> ingress<span class="token punctuation">-</span>controller<span class="token punctuation">-</span>leader

  <span class="token comment" spellcheck="true">## Name of the ingress class to route through this controller</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">ingressClass</span><span class="token punctuation">:</span> nginx

  <span class="token comment" spellcheck="true"># labels to add to the pod container metadata</span>
  <span class="token key atrule">podLabels</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">#  key: value</span>

  <span class="token comment" spellcheck="true">## Security Context policies for controller pods</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">podSecurityContext</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">## See https://kubernetes.io/docs/tasks/administer-cluster/sysctl-cluster/ for</span>
  <span class="token comment" spellcheck="true">## notes on enabling and using sysctls</span>
  <span class="token comment" spellcheck="true">###</span>
  <span class="token key atrule">sysctls</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true"># sysctls:</span>
  <span class="token comment" spellcheck="true">#   "net.core.somaxconn": "8192"</span>

  <span class="token comment" spellcheck="true">## Allows customization of the source of the IP address or FQDN to report</span>
  <span class="token comment" spellcheck="true">## in the ingress status field. By default, it reads the information provided</span>
  <span class="token comment" spellcheck="true">## by the service. If disable, the status field reports the IP address of the</span>
  <span class="token comment" spellcheck="true">## node or nodes where an ingress controller pod is running.</span>
  <span class="token key atrule">publishService</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token comment" spellcheck="true">## Allows overriding of the publish service to bind to</span>
    <span class="token comment" spellcheck="true">## Must be &lt;namespace>/&lt;service_name></span>
    <span class="token comment" spellcheck="true">##</span>
    <span class="token key atrule">pathOverride</span><span class="token punctuation">:</span> <span class="token string">""</span>

  <span class="token comment" spellcheck="true">## Limit the scope of the controller</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">scope</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">""</span>   <span class="token comment" spellcheck="true"># defaults to .Release.Namespace</span>

  <span class="token comment" spellcheck="true">## Allows customization of the configmap / nginx-configmap namespace</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">configMapNamespace</span><span class="token punctuation">:</span> <span class="token string">""</span>   <span class="token comment" spellcheck="true"># defaults to .Release.Namespace</span>

  <span class="token comment" spellcheck="true">## Allows customization of the tcp-services-configmap</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">tcp</span><span class="token punctuation">:</span>
    <span class="token key atrule">configMapNamespace</span><span class="token punctuation">:</span> <span class="token string">""</span>   <span class="token comment" spellcheck="true"># defaults to .Release.Namespace</span>
    <span class="token comment" spellcheck="true">## Annotations to be added to the tcp config configmap</span>
    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">## Allows customization of the udp-services-configmap</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">udp</span><span class="token punctuation">:</span>
    <span class="token key atrule">configMapNamespace</span><span class="token punctuation">:</span> <span class="token string">""</span>   <span class="token comment" spellcheck="true"># defaults to .Release.Namespace</span>
    <span class="token comment" spellcheck="true">## Annotations to be added to the udp config configmap</span>
    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true"># Maxmind license key to download GeoLite2 Databases</span>
  <span class="token comment" spellcheck="true"># https://blog.maxmind.com/2019/12/18/significant-changes-to-accessing-and-using-geolite2-databases</span>
  <span class="token key atrule">maxmindLicenseKey</span><span class="token punctuation">:</span> <span class="token string">""</span>

  <span class="token comment" spellcheck="true">## Additional command line arguments to pass to nginx-ingress-controller</span>
  <span class="token comment" spellcheck="true">## E.g. to specify the default SSL certificate you can use</span>
  <span class="token comment" spellcheck="true">## extraArgs:</span>
  <span class="token comment" spellcheck="true">##   default-ssl-certificate: "&lt;namespace>/&lt;secret_name>"</span>
  <span class="token key atrule">extraArgs</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">## Additional environment variables to set</span>
  <span class="token key atrule">extraEnvs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment" spellcheck="true"># extraEnvs:</span>
  <span class="token comment" spellcheck="true">#   - name: FOO</span>
  <span class="token comment" spellcheck="true">#     valueFrom:</span>
  <span class="token comment" spellcheck="true">#       secretKeyRef:</span>
  <span class="token comment" spellcheck="true">#         key: FOO</span>
  <span class="token comment" spellcheck="true">#         name: secret-resource</span>

  <span class="token comment" spellcheck="true">## DaemonSet or Deployment</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token comment" spellcheck="true"># 使用DaemonSet方式部署</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> DaemonSet

  <span class="token comment" spellcheck="true">## Annotations to be added to the controller Deployment or DaemonSet</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">#  keel.sh/pollSchedule: "@every 60m"</span>

  <span class="token comment" spellcheck="true">## Labels to be added to the controller Deployment or DaemonSet</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">#  keel.sh/policy: patch</span>
  <span class="token comment" spellcheck="true">#  keel.sh/trigger: poll</span>


  <span class="token comment" spellcheck="true"># The update strategy to apply to the Deployment or DaemonSet</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">#  rollingUpdate:</span>
  <span class="token comment" spellcheck="true">#    maxUnavailable: 1</span>
  <span class="token comment" spellcheck="true">#  type: RollingUpdate</span>

  <span class="token comment" spellcheck="true"># minReadySeconds to avoid killing pods before we are ready</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">minReadySeconds</span><span class="token punctuation">:</span> <span class="token number">0</span>


  <span class="token comment" spellcheck="true">## Node tolerations for server scheduling to nodes with taints</span>
  <span class="token comment" spellcheck="true">## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment" spellcheck="true">#  - key: "key"</span>
  <span class="token comment" spellcheck="true">#    operator: "Equal|Exists"</span>
  <span class="token comment" spellcheck="true">#    value: "value"</span>
  <span class="token comment" spellcheck="true">#    effect: "NoSchedule|PreferNoSchedule|NoExecute(1.6 only)"</span>

  <span class="token comment" spellcheck="true">## Affinity and anti-affinity</span>
  <span class="token comment" spellcheck="true">## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">affinity</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true"># # An example of preferred pod anti-affinity, weight is in the range 1-100</span>
    <span class="token comment" spellcheck="true"># podAntiAffinity:</span>
    <span class="token comment" spellcheck="true">#   preferredDuringSchedulingIgnoredDuringExecution:</span>
    <span class="token comment" spellcheck="true">#   - weight: 100</span>
    <span class="token comment" spellcheck="true">#     podAffinityTerm:</span>
    <span class="token comment" spellcheck="true">#       labelSelector:</span>
    <span class="token comment" spellcheck="true">#         matchExpressions:</span>
    <span class="token comment" spellcheck="true">#         - key: app.kubernetes.io/name</span>
    <span class="token comment" spellcheck="true">#           operator: In</span>
    <span class="token comment" spellcheck="true">#           values:</span>
    <span class="token comment" spellcheck="true">#           - ingress-nginx</span>
    <span class="token comment" spellcheck="true">#         - key: app.kubernetes.io/instance</span>
    <span class="token comment" spellcheck="true">#           operator: In</span>
    <span class="token comment" spellcheck="true">#           values:</span>
    <span class="token comment" spellcheck="true">#           - ingress-nginx</span>
    <span class="token comment" spellcheck="true">#         - key: app.kubernetes.io/component</span>
    <span class="token comment" spellcheck="true">#           operator: In</span>
    <span class="token comment" spellcheck="true">#           values:</span>
    <span class="token comment" spellcheck="true">#           - controller</span>
    <span class="token comment" spellcheck="true">#       topologyKey: kubernetes.io/hostname</span>

    <span class="token comment" spellcheck="true"># # An example of required pod anti-affinity</span>
    <span class="token comment" spellcheck="true"># podAntiAffinity:</span>
    <span class="token comment" spellcheck="true">#   requiredDuringSchedulingIgnoredDuringExecution:</span>
    <span class="token comment" spellcheck="true">#   - labelSelector:</span>
    <span class="token comment" spellcheck="true">#       matchExpressions:</span>
    <span class="token comment" spellcheck="true">#       - key: app.kubernetes.io/name</span>
    <span class="token comment" spellcheck="true">#         operator: In</span>
    <span class="token comment" spellcheck="true">#         values:</span>
    <span class="token comment" spellcheck="true">#         - ingress-nginx</span>
    <span class="token comment" spellcheck="true">#       - key: app.kubernetes.io/instance</span>
    <span class="token comment" spellcheck="true">#         operator: In</span>
    <span class="token comment" spellcheck="true">#         values:</span>
    <span class="token comment" spellcheck="true">#         - ingress-nginx</span>
    <span class="token comment" spellcheck="true">#       - key: app.kubernetes.io/component</span>
    <span class="token comment" spellcheck="true">#         operator: In</span>
    <span class="token comment" spellcheck="true">#         values:</span>
    <span class="token comment" spellcheck="true">#         - controller</span>
    <span class="token comment" spellcheck="true">#     topologyKey: "kubernetes.io/hostname"</span>

  <span class="token comment" spellcheck="true">## Topology spread constraints rely on node labels to identify the topology domain(s) that each Node is in.</span>
  <span class="token comment" spellcheck="true">## Ref: https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">topologySpreadConstraints</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment" spellcheck="true"># - maxSkew: 1</span>
    <span class="token comment" spellcheck="true">#   topologyKey: failure-domain.beta.kubernetes.io/zone</span>
    <span class="token comment" spellcheck="true">#   whenUnsatisfiable: DoNotSchedule</span>
    <span class="token comment" spellcheck="true">#   labelSelector:</span>
    <span class="token comment" spellcheck="true">#     matchLabels:</span>
    <span class="token comment" spellcheck="true">#       app.kubernetes.io/instance: ingress-nginx-internal</span>

  <span class="token comment" spellcheck="true">## terminationGracePeriodSeconds</span>
  <span class="token comment" spellcheck="true">## wait up to five minutes for the drain of connections</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">300</span>

  <span class="token comment" spellcheck="true">## Node labels for controller pod assignment</span>
  <span class="token comment" spellcheck="true">## Ref: https://kubernetes.io/docs/user-guide/node-selection/</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span>
    <span class="token key atrule">kubernetes.io/os</span><span class="token punctuation">:</span> linux
    <span class="token comment" spellcheck="true"># 指定部署的节点所含有的标签</span>
    <span class="token key atrule">ingress</span><span class="token punctuation">:</span> <span class="token string">"true"</span>

  <span class="token comment" spellcheck="true">## Liveness and readiness probe values</span>
  <span class="token comment" spellcheck="true">## Ref: https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#container-probes</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
    <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">5</span>
    <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10254</span>
  <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
    <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>
    <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10254</span>

  <span class="token comment" spellcheck="true"># Path of the health check endpoint. All requests received on the port defined by</span>
  <span class="token comment" spellcheck="true"># the healthz-port parameter are forwarded internally to this path.</span>
  <span class="token key atrule">healthCheckPath</span><span class="token punctuation">:</span> <span class="token string">"/healthz"</span>

  <span class="token comment" spellcheck="true">## Annotations to be added to controller pods</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">podAnnotations</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token key atrule">replicaCount</span><span class="token punctuation">:</span> <span class="token number">1</span>

  <span class="token key atrule">minAvailable</span><span class="token punctuation">:</span> <span class="token number">1</span>

  <span class="token comment" spellcheck="true"># Define requests resources to avoid probe issues due to CPU utilization in busy nodes</span>
  <span class="token comment" spellcheck="true"># ref: https://github.com/kubernetes/ingress-nginx/issues/4735#issuecomment-551204903</span>
  <span class="token comment" spellcheck="true"># Ideally, there should be no limits.</span>
  <span class="token comment" spellcheck="true"># https://engineering.indeedblog.com/blog/2019/12/cpu-throttling-regression-fix/</span>
  <span class="token comment" spellcheck="true"># 临时使用默认的配置，在生产环境中需要重新设置</span>
  <span class="token comment" spellcheck="true"># 如果是专有节点，需要尽可能配置的更大</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token comment" spellcheck="true">#  limits:</span>
  <span class="token comment" spellcheck="true">#    cpu: 100m</span>
  <span class="token comment" spellcheck="true">#    memory: 90Mi</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">cpu</span><span class="token punctuation">:</span> 100m
      <span class="token key atrule">memory</span><span class="token punctuation">:</span> 90Mi

  <span class="token comment" spellcheck="true"># Mutually exclusive with keda autoscaling</span>
  <span class="token key atrule">autoscaling</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">11</span>
    <span class="token key atrule">targetCPUUtilizationPercentage</span><span class="token punctuation">:</span> <span class="token number">50</span>
    <span class="token key atrule">targetMemoryUtilizationPercentage</span><span class="token punctuation">:</span> <span class="token number">50</span>

  <span class="token key atrule">autoscalingTemplate</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment" spellcheck="true"># Custom or additional autoscaling metrics</span>
  <span class="token comment" spellcheck="true"># ref: https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/#support-for-custom-metrics</span>
  <span class="token comment" spellcheck="true"># - type: Pods</span>
  <span class="token comment" spellcheck="true">#   pods:</span>
  <span class="token comment" spellcheck="true">#     metric:</span>
  <span class="token comment" spellcheck="true">#       name: nginx_ingress_controller_nginx_process_requests_total</span>
  <span class="token comment" spellcheck="true">#     target:</span>
  <span class="token comment" spellcheck="true">#       type: AverageValue</span>
  <span class="token comment" spellcheck="true">#       averageValue: 10000m</span>

  <span class="token comment" spellcheck="true"># Mutually exclusive with hpa autoscaling</span>
  <span class="token key atrule">keda</span><span class="token punctuation">:</span>
    <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> <span class="token string">"keda.sh/v1alpha1"</span>
  <span class="token comment" spellcheck="true"># apiVersion changes with keda 1.x vs 2.x</span>
  <span class="token comment" spellcheck="true"># 2.x = keda.sh/v1alpha1</span>
  <span class="token comment" spellcheck="true"># 1.x = keda.k8s.io/v1alpha1</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">11</span>
    <span class="token key atrule">pollingInterval</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token key atrule">cooldownPeriod</span><span class="token punctuation">:</span> <span class="token number">300</span>
    <span class="token key atrule">restoreToOriginalReplicaCount</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">triggers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
 <span class="token comment" spellcheck="true">#     - type: prometheus</span>
 <span class="token comment" spellcheck="true">#       metadata:</span>
 <span class="token comment" spellcheck="true">#         serverAddress: http://&lt;prometheus-host>:9090</span>
 <span class="token comment" spellcheck="true">#         metricName: http_requests_total</span>
 <span class="token comment" spellcheck="true">#         threshold: '100'</span>
 <span class="token comment" spellcheck="true">#         query: sum(rate(http_requests_total{deployment="my-deployment"}[2m]))</span>

    <span class="token key atrule">behavior</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
 <span class="token comment" spellcheck="true">#     scaleDown:</span>
 <span class="token comment" spellcheck="true">#       stabilizationWindowSeconds: 300</span>
 <span class="token comment" spellcheck="true">#       policies:</span>
 <span class="token comment" spellcheck="true">#       - type: Pods</span>
 <span class="token comment" spellcheck="true">#         value: 1</span>
 <span class="token comment" spellcheck="true">#         periodSeconds: 180</span>
 <span class="token comment" spellcheck="true">#     scaleUp:</span>
 <span class="token comment" spellcheck="true">#       stabilizationWindowSeconds: 300</span>
 <span class="token comment" spellcheck="true">#       policies:</span>
 <span class="token comment" spellcheck="true">#       - type: Pods</span>
 <span class="token comment" spellcheck="true">#         value: 2</span>
 <span class="token comment" spellcheck="true">#         periodSeconds: 60</span>

  <span class="token comment" spellcheck="true">## Enable mimalloc as a drop-in replacement for malloc.</span>
  <span class="token comment" spellcheck="true">## ref: https://github.com/microsoft/mimalloc</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">enableMimalloc</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

  <span class="token comment" spellcheck="true">## Override NGINX template</span>
  <span class="token key atrule">customTemplate</span><span class="token punctuation">:</span>
    <span class="token key atrule">configMapName</span><span class="token punctuation">:</span> <span class="token string">""</span>
    <span class="token key atrule">configMapKey</span><span class="token punctuation">:</span> <span class="token string">""</span>

  <span class="token key atrule">service</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token key atrule">labels</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true"># clusterIP: ""</span>

    <span class="token comment" spellcheck="true">## List of IP addresses at which the controller services are available</span>
    <span class="token comment" spellcheck="true">## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips</span>
    <span class="token comment" spellcheck="true">##</span>
    <span class="token key atrule">externalIPs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token comment" spellcheck="true"># loadBalancerIP: ""</span>
    <span class="token key atrule">loadBalancerSourceRanges</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token key atrule">enableHttp</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">enableHttps</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

    <span class="token comment" spellcheck="true">## Set external traffic policy to: "Local" to preserve source IP on</span>
    <span class="token comment" spellcheck="true">## providers supporting it</span>
    <span class="token comment" spellcheck="true">## Ref: https://kubernetes.io/docs/tutorials/services/source-ip/#source-ip-for-services-with-typeloadbalancer</span>
    <span class="token comment" spellcheck="true"># externalTrafficPolicy: ""</span>

    <span class="token comment" spellcheck="true"># Must be either "None" or "ClientIP" if set. Kubernetes will default to "None".</span>
    <span class="token comment" spellcheck="true"># Ref: https://kubernetes.io/docs/concepts/services-networking/service/#virtual-ips-and-service-proxies</span>
    <span class="token comment" spellcheck="true"># sessionAffinity: ""</span>

    <span class="token comment" spellcheck="true"># specifies the health check node port (numeric port number) for the service. If healthCheckNodePort isn’t specified,</span>
    <span class="token comment" spellcheck="true"># the service controller allocates a port from your cluster’s NodePort range.</span>
    <span class="token comment" spellcheck="true"># Ref: https://kubernetes.io/docs/tasks/access-application-cluster/create-external-load-balancer/#preserving-the-client-source-ip</span>
    <span class="token comment" spellcheck="true"># healthCheckNodePort: 0</span>

    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token key atrule">http</span><span class="token punctuation">:</span> <span class="token number">80</span>
      <span class="token key atrule">https</span><span class="token punctuation">:</span> <span class="token number">443</span>

    <span class="token key atrule">targetPorts</span><span class="token punctuation">:</span>
      <span class="token key atrule">http</span><span class="token punctuation">:</span> http
      <span class="token key atrule">https</span><span class="token punctuation">:</span> https
    <span class="token comment" spellcheck="true"># 自有资源部署，不使用LoadBalancer，使用clusterIP进行部署</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP

    <span class="token comment" spellcheck="true"># type: NodePort</span>
    <span class="token comment" spellcheck="true"># nodePorts:</span>
    <span class="token comment" spellcheck="true">#   http: 32080</span>
    <span class="token comment" spellcheck="true">#   https: 32443</span>
    <span class="token comment" spellcheck="true">#   tcp:</span>
    <span class="token comment" spellcheck="true">#     8080: 32808</span>
    <span class="token key atrule">nodePorts</span><span class="token punctuation">:</span>
      <span class="token key atrule">http</span><span class="token punctuation">:</span> <span class="token string">""</span>
      <span class="token key atrule">https</span><span class="token punctuation">:</span> <span class="token string">""</span>
      <span class="token key atrule">tcp</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token key atrule">udp</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true">## Enables an additional internal load balancer (besides the external one).</span>
    <span class="token comment" spellcheck="true">## Annotations are mandatory for the load balancer to come up. Varies with the cloud service.</span>
    <span class="token key atrule">internal</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

      <span class="token comment" spellcheck="true"># loadBalancerIP: ""</span>

      <span class="token comment" spellcheck="true">## Restrict access For LoadBalancer service. Defaults to 0.0.0.0/0.</span>
      <span class="token key atrule">loadBalancerSourceRanges</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

      <span class="token comment" spellcheck="true">## Set external traffic policy to: "Local" to preserve source IP on</span>
      <span class="token comment" spellcheck="true">## providers supporting it</span>
      <span class="token comment" spellcheck="true">## Ref: https://kubernetes.io/docs/tutorials/services/source-ip/#source-ip-for-services-with-typeloadbalancer</span>
      <span class="token comment" spellcheck="true"># externalTrafficPolicy: ""</span>

  <span class="token key atrule">extraContainers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment" spellcheck="true">## Additional containers to be added to the controller pod.</span>
  <span class="token comment" spellcheck="true">## See https://github.com/lemonldap-ng-controller/lemonldap-ng-controller as example.</span>
  <span class="token comment" spellcheck="true">#  - name: my-sidecar</span>
  <span class="token comment" spellcheck="true">#    image: nginx:latest</span>
  <span class="token comment" spellcheck="true">#  - name: lemonldap-ng-controller</span>
  <span class="token comment" spellcheck="true">#    image: lemonldapng/lemonldap-ng-controller:0.2.0</span>
  <span class="token comment" spellcheck="true">#    args:</span>
  <span class="token comment" spellcheck="true">#      - /lemonldap-ng-controller</span>
  <span class="token comment" spellcheck="true">#      - --alsologtostderr</span>
  <span class="token comment" spellcheck="true">#      - --configmap=$(POD_NAMESPACE)/lemonldap-ng-configuration</span>
  <span class="token comment" spellcheck="true">#    env:</span>
  <span class="token comment" spellcheck="true">#      - name: POD_NAME</span>
  <span class="token comment" spellcheck="true">#        valueFrom:</span>
  <span class="token comment" spellcheck="true">#          fieldRef:</span>
  <span class="token comment" spellcheck="true">#            fieldPath: metadata.name</span>
  <span class="token comment" spellcheck="true">#      - name: POD_NAMESPACE</span>
  <span class="token comment" spellcheck="true">#        valueFrom:</span>
  <span class="token comment" spellcheck="true">#          fieldRef:</span>
  <span class="token comment" spellcheck="true">#            fieldPath: metadata.namespace</span>
  <span class="token comment" spellcheck="true">#    volumeMounts:</span>
  <span class="token comment" spellcheck="true">#    - name: copy-portal-skins</span>
  <span class="token comment" spellcheck="true">#      mountPath: /srv/var/lib/lemonldap-ng/portal/skins</span>

  <span class="token key atrule">extraVolumeMounts</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment" spellcheck="true">## Additional volumeMounts to the controller main container.</span>
  <span class="token comment" spellcheck="true">#  - name: copy-portal-skins</span>
  <span class="token comment" spellcheck="true">#   mountPath: /var/lib/lemonldap-ng/portal/skins</span>

  <span class="token key atrule">extraVolumes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment" spellcheck="true">## Additional volumes to the controller pod.</span>
  <span class="token comment" spellcheck="true">#  - name: copy-portal-skins</span>
  <span class="token comment" spellcheck="true">#    emptyDir: {}</span>

  <span class="token key atrule">extraInitContainers</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment" spellcheck="true">## Containers, which are run before the app containers are started.</span>
  <span class="token comment" spellcheck="true"># - name: init-myservice</span>
  <span class="token comment" spellcheck="true">#   image: busybox</span>
  <span class="token comment" spellcheck="true">#   command: ['sh', '-c', 'until nslookup myservice; do echo waiting for myservice; sleep 2; done;']</span>

  <span class="token comment" spellcheck="true"># 准入控制配置</span>
  <span class="token comment" spellcheck="true"># 0.40以后可用</span>
  <span class="token key atrule">admissionWebhooks</span><span class="token punctuation">:</span>
    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">failurePolicy</span><span class="token punctuation">:</span> Fail
    <span class="token comment" spellcheck="true"># timeoutSeconds: 10</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8443</span>
    <span class="token key atrule">certificate</span><span class="token punctuation">:</span> <span class="token string">"/usr/local/certificates/cert"</span>
    <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"/usr/local/certificates/key"</span>
    <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token key atrule">objectSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token key atrule">service</span><span class="token punctuation">:</span>
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token comment" spellcheck="true"># clusterIP: ""</span>
      <span class="token key atrule">externalIPs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token comment" spellcheck="true"># loadBalancerIP: ""</span>
      <span class="token key atrule">loadBalancerSourceRanges</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">443</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP

    <span class="token key atrule">patch</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">image</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># repository: docker.io/jettech/kube-webhook-certgen</span>
        <span class="token key atrule">repository</span><span class="token punctuation">:</span> jettech/kube<span class="token punctuation">-</span>webhook<span class="token punctuation">-</span>certgen
        <span class="token key atrule">tag</span><span class="token punctuation">:</span> v1.5.0
        <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token comment" spellcheck="true">## Provide a priority class name to the webhook patching job</span>
      <span class="token comment" spellcheck="true">##</span>
      <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> <span class="token string">""</span>
      <span class="token key atrule">podAnnotations</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">2000</span>

  <span class="token key atrule">metrics</span><span class="token punctuation">:</span>
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10254</span>
    <span class="token comment" spellcheck="true"># if this port is changed, change healthz-port: in extraArgs: accordingly</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

    <span class="token key atrule">service</span><span class="token punctuation">:</span>
      <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token comment" spellcheck="true"># prometheus.io/scrape: "true"</span>
      <span class="token comment" spellcheck="true"># prometheus.io/port: "10254"</span>

      <span class="token comment" spellcheck="true"># clusterIP: ""</span>

      <span class="token comment" spellcheck="true">## List of IP addresses at which the stats-exporter service is available</span>
      <span class="token comment" spellcheck="true">## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips</span>
      <span class="token comment" spellcheck="true">##</span>
      <span class="token key atrule">externalIPs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

      <span class="token comment" spellcheck="true"># loadBalancerIP: ""</span>
      <span class="token key atrule">loadBalancerSourceRanges</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">9913</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
      <span class="token comment" spellcheck="true"># externalTrafficPolicy: ""</span>
      <span class="token comment" spellcheck="true"># nodePort: ""</span>

    <span class="token key atrule">serviceMonitor</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">additionalLabels</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token key atrule">namespace</span><span class="token punctuation">:</span> <span class="token string">""</span>
      <span class="token key atrule">namespaceSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token comment" spellcheck="true"># Default: scrape .Release.Namespace only</span>
      <span class="token comment" spellcheck="true"># To scrape all, use the following:</span>
      <span class="token comment" spellcheck="true"># namespaceSelector:</span>
      <span class="token comment" spellcheck="true">#   any: true</span>
      <span class="token key atrule">scrapeInterval</span><span class="token punctuation">:</span> 30s
      <span class="token comment" spellcheck="true"># honorLabels: true</span>
      <span class="token key atrule">targetLabels</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token key atrule">metricRelabelings</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token key atrule">prometheusRule</span><span class="token punctuation">:</span>
      <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
      <span class="token key atrule">additionalLabels</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token comment" spellcheck="true"># namespace: ""</span>
      <span class="token key atrule">rules</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token comment" spellcheck="true"># # These are just examples rules, please adapt them to your needs</span>
        <span class="token comment" spellcheck="true"># - alert: NGINXConfigFailed</span>
        <span class="token comment" spellcheck="true">#   expr: count(nginx_ingress_controller_config_last_reload_successful == 0) > 0</span>
        <span class="token comment" spellcheck="true">#   for: 1s</span>
        <span class="token comment" spellcheck="true">#   labels:</span>
        <span class="token comment" spellcheck="true">#     severity: critical</span>
        <span class="token comment" spellcheck="true">#   annotations:</span>
        <span class="token comment" spellcheck="true">#     description: bad ingress config - nginx config test failed</span>
        <span class="token comment" spellcheck="true">#     summary: uninstall the latest ingress changes to allow config reloads to resume</span>
        <span class="token comment" spellcheck="true"># - alert: NGINXCertificateExpiry</span>
        <span class="token comment" spellcheck="true">#   expr: (avg(nginx_ingress_controller_ssl_expire_time_seconds) by (host) - time()) &lt; 604800</span>
        <span class="token comment" spellcheck="true">#   for: 1s</span>
        <span class="token comment" spellcheck="true">#   labels:</span>
        <span class="token comment" spellcheck="true">#     severity: critical</span>
        <span class="token comment" spellcheck="true">#   annotations:</span>
        <span class="token comment" spellcheck="true">#     description: ssl certificate(s) will expire in less then a week</span>
        <span class="token comment" spellcheck="true">#     summary: renew expiring certificates to avoid downtime</span>
        <span class="token comment" spellcheck="true"># - alert: NGINXTooMany500s</span>
        <span class="token comment" spellcheck="true">#   expr: 100 * ( sum( nginx_ingress_controller_requests{status=~"5.+"} ) / sum(nginx_ingress_controller_requests) ) > 5</span>
        <span class="token comment" spellcheck="true">#   for: 1m</span>
        <span class="token comment" spellcheck="true">#   labels:</span>
        <span class="token comment" spellcheck="true">#     severity: warning</span>
        <span class="token comment" spellcheck="true">#   annotations:</span>
        <span class="token comment" spellcheck="true">#     description: Too many 5XXs</span>
        <span class="token comment" spellcheck="true">#     summary: More than 5% of all requests returned 5XX, this requires your attention</span>
        <span class="token comment" spellcheck="true"># - alert: NGINXTooMany400s</span>
        <span class="token comment" spellcheck="true">#   expr: 100 * ( sum( nginx_ingress_controller_requests{status=~"4.+"} ) / sum(nginx_ingress_controller_requests) ) > 5</span>
        <span class="token comment" spellcheck="true">#   for: 1m</span>
        <span class="token comment" spellcheck="true">#   labels:</span>
        <span class="token comment" spellcheck="true">#     severity: warning</span>
        <span class="token comment" spellcheck="true">#   annotations:</span>
        <span class="token comment" spellcheck="true">#     description: Too many 4XXs</span>
        <span class="token comment" spellcheck="true">#     summary: More than 5% of all requests returned 4XX, this requires your attention</span>

  <span class="token comment" spellcheck="true">## Improve connection draining when ingress controller pod is deleted using a lifecycle hook:</span>
  <span class="token comment" spellcheck="true">## With this new hook, we increased the default terminationGracePeriodSeconds from 30 seconds</span>
  <span class="token comment" spellcheck="true">## to 300, allowing the draining of connections up to five minutes.</span>
  <span class="token comment" spellcheck="true">## If the active connections end before that, the pod will terminate gracefully at that time.</span>
  <span class="token comment" spellcheck="true">## To effectively take advantage of this feature, the Configmap feature</span>
  <span class="token comment" spellcheck="true">## worker-shutdown-timeout new value is 240s instead of 10s.</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
    <span class="token key atrule">preStop</span><span class="token punctuation">:</span>
      <span class="token key atrule">exec</span><span class="token punctuation">:</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> /wait<span class="token punctuation">-</span>shutdown

  <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> <span class="token string">""</span>

<span class="token comment" spellcheck="true">## Rollback limit</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>

<span class="token comment" spellcheck="true">## Default 404 backend</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token key atrule">defaultBackend</span><span class="token punctuation">:</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

  <span class="token key atrule">name</span><span class="token punctuation">:</span> defaultbackend
  <span class="token comment" spellcheck="true"># 去除外部连接，通过搜索dockerhub寻找同版本替代品，使用mirrorgooglecontainers替代原来的地址信息</span>
  <span class="token key atrule">image</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># repository: k8s.gcr.io/defaultbackend-amd64</span>
    <span class="token key atrule">repository</span><span class="token punctuation">:</span> mirrorgooglecontainers/defaultbackend<span class="token punctuation">-</span>amd64
    <span class="token key atrule">tag</span><span class="token punctuation">:</span> <span class="token string">"1.5"</span>
    <span class="token key atrule">pullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token comment" spellcheck="true"># nobody user -> uid 65534</span>
    <span class="token key atrule">runAsUser</span><span class="token punctuation">:</span> <span class="token number">65534</span>
    <span class="token key atrule">runAsNonRoot</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">readOnlyRootFilesystem</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">allowPrivilegeEscalation</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

  <span class="token key atrule">extraArgs</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span>
    <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span>
  <span class="token comment" spellcheck="true">## Additional environment variables to set for defaultBackend pods</span>
  <span class="token key atrule">extraEnvs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>

  <span class="token comment" spellcheck="true">## Readiness and liveness probes for default backend</span>
  <span class="token comment" spellcheck="true">## Ref: https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
    <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">3</span>
    <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
    <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
  <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
    <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">6</span>
    <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
    <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>

  <span class="token comment" spellcheck="true">## Node tolerations for server scheduling to nodes with taints</span>
  <span class="token comment" spellcheck="true">## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token comment" spellcheck="true">#  - key: "key"</span>
  <span class="token comment" spellcheck="true">#    operator: "Equal|Exists"</span>
  <span class="token comment" spellcheck="true">#    value: "value"</span>
  <span class="token comment" spellcheck="true">#    effect: "NoSchedule|PreferNoSchedule|NoExecute(1.6 only)"</span>

  <span class="token key atrule">affinity</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">## Security Context policies for controller pods</span>
  <span class="token comment" spellcheck="true">## See https://kubernetes.io/docs/tasks/administer-cluster/sysctl-cluster/ for</span>
  <span class="token comment" spellcheck="true">## notes on enabling and using sysctls</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">podSecurityContext</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true"># labels to add to the pod container metadata</span>
  <span class="token key atrule">podLabels</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true">#  key: value</span>

  <span class="token comment" spellcheck="true">## Node labels for default backend pod assignment</span>
  <span class="token comment" spellcheck="true">## Ref: https://kubernetes.io/docs/user-guide/node-selection/</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">nodeSelector</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token comment" spellcheck="true">## Annotations to be added to default backend pods</span>
  <span class="token comment" spellcheck="true">##</span>
  <span class="token key atrule">podAnnotations</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token key atrule">replicaCount</span><span class="token punctuation">:</span> <span class="token number">1</span>

  <span class="token key atrule">minAvailable</span><span class="token punctuation">:</span> <span class="token number">1</span>


  <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment" spellcheck="true"># limits:</span>
  <span class="token comment" spellcheck="true">#   cpu: 10m</span>
  <span class="token comment" spellcheck="true">#   memory: 20Mi</span>
  <span class="token comment" spellcheck="true">#  requests:</span>
  <span class="token comment" spellcheck="true">#    cpu: 100m</span>
  <span class="token comment" spellcheck="true">#    memory: 120Mi</span>

  <span class="token key atrule">autoscaling</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">minReplicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">maxReplicas</span><span class="token punctuation">:</span> <span class="token number">2</span>
    <span class="token key atrule">targetCPUUtilizationPercentage</span><span class="token punctuation">:</span> <span class="token number">50</span>
    <span class="token key atrule">targetMemoryUtilizationPercentage</span><span class="token punctuation">:</span> <span class="token number">50</span>

  <span class="token key atrule">service</span><span class="token punctuation">:</span>
    <span class="token key atrule">annotations</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token comment" spellcheck="true"># clusterIP: ""</span>

    <span class="token comment" spellcheck="true">## List of IP addresses at which the default backend service is available</span>
    <span class="token comment" spellcheck="true">## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips</span>
    <span class="token comment" spellcheck="true">##</span>
    <span class="token key atrule">externalIPs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token comment" spellcheck="true">#loadBalancerIP: ""</span>
    <span class="token key atrule">loadBalancerSourceRanges</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token comment" spellcheck="true"># 修改为NodePort模式</span>
    <span class="token comment" spellcheck="true">#type: ClusterIP</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort

  <span class="token key atrule">priorityClassName</span><span class="token punctuation">:</span> <span class="token string">""</span>

<span class="token comment" spellcheck="true">## Enable RBAC as per https://github.com/kubernetes/ingress/tree/master/examples/rbac/nginx and https://github.com/kubernetes/ingress/issues/266</span>
<span class="token key atrule">rbac</span><span class="token punctuation">:</span>
  <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">scope</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token comment" spellcheck="true"># If true, create &amp; use Pod Security Policy resources</span>
<span class="token comment" spellcheck="true"># https://kubernetes.io/docs/concepts/policy/pod-security-policy/</span>
<span class="token key atrule">podSecurityPolicy</span><span class="token punctuation">:</span>
  <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>

<span class="token key atrule">serviceAccount</span><span class="token punctuation">:</span>
  <span class="token key atrule">create</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span>

<span class="token comment" spellcheck="true">## Optional array of imagePullSecrets containing private registry credentials</span>
<span class="token comment" spellcheck="true">## Ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/</span>
<span class="token key atrule">imagePullSecrets</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment" spellcheck="true"># - name: secretName</span>

<span class="token comment" spellcheck="true"># TCP service key:value pairs</span>
<span class="token comment" spellcheck="true"># Ref: https://github.com/kubernetes/contrib/tree/master/ingress/controllers/nginx/examples/tcp</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token key atrule">tcp</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">#  8080: "default/example-tcp-svc:9000"</span>

<span class="token comment" spellcheck="true"># UDP service key:value pairs</span>
<span class="token comment" spellcheck="true"># Ref: https://github.com/kubernetes/contrib/tree/master/ingress/controllers/nginx/examples/udp</span>
<span class="token comment" spellcheck="true">##</span>
<span class="token key atrule">udp</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token comment" spellcheck="true">#  53: "kube-system/kube-dns:53"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>需要修改的位置：</p>
<p>a) Controller和admissionWebhook的镜像地址，需要将公网镜像同步至公司内网镜像仓库<br>b) hostNetwork 设置为 true<br>c) dnsPolicy设置为 ClusterFirstWithHostNet<br>d) NodeSelector添加ingress: “true”部署至指定节点<br>e) 类型更改为 kind: DaemonSet<br>f) service.type改为NodePort</p>
<p>注意：在yaml中写入true时一定要加引号，例如 nginx: “true”。</p>
<p>最后使用命令安装ingress-nginx：</p>
<pre><code>// 创建命名空间
kubectl create ns ingress-nginx

// 对节点打标签，将目标ingress部署到该节点
kubectl label node k8s-master-03 ingress=true

// 安装
helm install ingress-nginx -n ingress-nginx .
</code></pre><p>2.12.3 ingress的扩容缩容</p>
<p>对节点打标签，进行ingress的扩容操作</p>
<pre><code>kubectl label node k8s-master-02 ingress=true</code></pre><p>DaemonSet会监听各个节点机器的变化，如果有新的节点添加了<em>ingress=true</em>这个标签，DaemonSet会控制在该节点上新部署一个ingress的实例。</p>
<p>查看ingress信息：</p>
<pre><code>kubectl get pod -n ingress-nginx -o wide

NAME                             READY   STATUS    RESTARTS   AGE     IP               NODE            NOMINATED NODE   READINESS GATES
ingress-nginx-controller-549t5   1/1     Running   0          4h33m   192.168.229.53   k8s-master-03   &lt;none&gt;           &lt;none&gt;
ingress-nginx-controller-ktx9r   1/1     Running   0          5m4s    192.168.229.52   k8s-master-02   &lt;none&gt;           &lt;none&gt;

</code></pre><p>在节点上删除<em>ingress=true</em>这个标签，DaemonSet将会删除在该节点上部署的ingress实例，如下：</p>
<pre><code>kubectl label node k8s-master-02 ingress-
node/k8s-master-02 labeled

kubectl get pod -n ingress-nginx -o wide
NAME                             READY   STATUS        RESTARTS   AGE     IP               NODE            NOMINATED NODE   READINESS GATES
ingress-nginx-controller-549t5   1/1     Running       0          4h35m   192.168.229.53   k8s-master-03   &lt;none&gt;           &lt;none&gt;
ingress-nginx-controller-ktx9r   1/1     Terminating   0          7m24s   192.168.229.52   k8s-master-02   &lt;none&gt;           &lt;none&gt;
</code></pre><p><strong>注意：</strong>如果在外部存在负载均衡器，例如硬件F5，软件上云服务厂商的SLB，在添加时需要先启动新的ingress实例，然后在负载均衡器中添加该节点的访问信息；在删除时，需要先在负载均衡器中删除该ingress配置的访问信息，再停止该实例，避免出现服务宕机的情况。</p>
<p>ingress实质是在宿主机上使用了宿主机的端口和网络，并不是使用kube-proxy进行代理。</p>
<p>2.12.4 配置ingress进行服务发布</p>
<p>通过读取配置文件的annotations节点下的配置信息，可以通过ingress-controller动态生成nginx的配置文件，达成站点部署的操作。</p>
<p>rewrite示例，配置文件如下:</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> networking.k8s.io/v1beta1   <span class="token comment" spellcheck="true"># 1.19以后建议使用networking.k8s.io/v1，但是ingress-controller有可能不支持v1，extensions/v1beta1不要再写</span>
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
    <span class="token comment" spellcheck="true"># ingress的配置写在annotations中 </span>
    <span class="token key atrule">kubernetes.io/ingress.class</span><span class="token punctuation">:</span> <span class="token string">"nginx"</span>  <span class="token comment" spellcheck="true"># 在创建ingress的时候通过ingressClass指定了该名称</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> example
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 一个ingress可以配置多个rule</span>
  <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> foo.bar.com  <span class="token comment" spellcheck="true"># 域名配置，可以不写，匹配*, 例如*.bar.com</span>
    <span class="token key atrule">http</span><span class="token punctuation">:</span>
      <span class="token key atrule">paths</span><span class="token punctuation">:</span>  <span class="token comment" spellcheck="true"># 相当于nginx的location配置，同一个host可以配置多个path</span>
      <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>
          <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span>svc
          <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">path</span><span class="token punctuation">:</span> /
      <span class="token comment" spellcheck="true"># - backend:</span>
      <span class="token comment" spellcheck="true">#     serviceName: http-svc-abc</span>
      <span class="token comment" spellcheck="true">#     servicePort: 80</span>
      <span class="token comment" spellcheck="true">#   path: /abc</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过配置域名的方式反向代理到已部署的nginx上。使上述配置生效，如下：</p>
<pre><code>kubectl create -f ingress.yaml
</code></pre><p><em>重大问题：访问504、502错误码的问题</em></p>
<p><strong>解决方式</strong>：配置了ClusterIP</p>
<pre><code>  service:
    annotations: {}

    # clusterIP: &quot;&quot;

    ## List of IP addresses at which the default backend service is available
    ## Ref: https://kubernetes.io/docs/user-guide/services/#external-ips
    ##
    externalIPs: []

    #loadBalancerIP: &quot;&quot;
    loadBalancerSourceRanges: []
    servicePort: 80
    type: ClusterIP
</code></pre><p>需要修改为NodePort，并且需要注意的是在访问域名时需要带上ingress服务的端口号。例如：</p>
<pre><code>$ curl http://foo.bar.com:30946
</code></pre><p>注意：多域名配置时，在annotion中设置rewrite时，需要rewrite方式转发的域名写在一个配置文件中，不需要的写在另一个文件中。</p>
<p>2.12.5 ingress排错</p>
<p>安装kubectl工具的krew插件管理工具，以此为基础，安装ingress的调试工具。</p>
<p>首先安装krew，执行下面的脚本内容</p>
<pre class="line-numbers language-bash"><code class="language-bash"><span class="token punctuation">(</span>
  <span class="token keyword">set</span> -x<span class="token punctuation">;</span> <span class="token function">cd</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>mktemp -d<span class="token variable">)</span></span>"</span> <span class="token operator">&amp;&amp;</span>
  curl -fsSLO <span class="token string">"https://github.com/kubernetes-sigs/krew/releases/latest/download/krew.tar.gz"</span> <span class="token operator">&amp;&amp;</span>
  <span class="token function">tar</span> zxvf krew.tar.gz <span class="token operator">&amp;&amp;</span>
  KREW<span class="token operator">=</span>./krew-<span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token operator">|</span> <span class="token function">tr</span> '<span class="token punctuation">[</span>:upper:<span class="token punctuation">]</span>' '<span class="token punctuation">[</span>:lower:<span class="token punctuation">]</span>'<span class="token variable">)</span></span>_<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -m <span class="token operator">|</span> <span class="token function">sed</span> -e 's/x86_64/amd64/' -e 's/arm.*$/arm/'<span class="token variable">)</span></span>"</span> <span class="token operator">&amp;&amp;</span>
  <span class="token string">"<span class="token variable">$KREW</span>"</span> <span class="token function">install</span> krew
<span class="token punctuation">)</span>

// （无科学上网的情况下）或者考虑提前下载好krew的安装包krew.tar.gz，以及配置文件krew.yaml，执行下面的命令

<span class="token punctuation">(</span>
  <span class="token keyword">set</span> -x<span class="token punctuation">;</span> <span class="token function">cd</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>mktemp -d<span class="token variable">)</span></span>"</span> <span class="token operator">&amp;&amp;</span>
  <span class="token function">cp</span> /root/k8s-practice/ingress/krew.tar.gz ./krew.tar.gz <span class="token operator">&amp;&amp;</span> 
  <span class="token function">cp</span> /root/k8s-practice/ingress/krew.yaml ./krew.yaml <span class="token operator">&amp;&amp;</span> 
  <span class="token function">tar</span> zxvf krew.tar.gz <span class="token operator">&amp;&amp;</span>
  KREW<span class="token operator">=</span>./krew-<span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> <span class="token operator">|</span> <span class="token function">tr</span> '<span class="token punctuation">[</span>:upper:<span class="token punctuation">]</span>' '<span class="token punctuation">[</span>:lower:<span class="token punctuation">]</span>'<span class="token variable">)</span></span>_<span class="token variable"><span class="token variable">$(</span><span class="token function">uname</span> -m <span class="token operator">|</span> <span class="token function">sed</span> -e 's/x86_64/amd64/' -e 's/arm.*$/arm/'<span class="token variable">)</span></span>"</span> <span class="token operator">&amp;&amp;</span>
  <span class="token string">"<span class="token variable">$KREW</span>"</span> <span class="token function">install</span> --archive<span class="token operator">=</span>krew.tar.gz --manifest<span class="token operator">=</span>krew.yaml <span class="token operator">&amp;&amp;</span> 
  <span class="token string">"<span class="token variable">$KREW</span>"</span> update 
<span class="token punctuation">)</span>

// 输出日志如下
Installing plugin: krew
Installed plugin: krew
\
 <span class="token operator">|</span> Use this plugin:
 <span class="token operator">|</span>      kubectl krew
 <span class="token operator">|</span> Documentation:
 <span class="token operator">|</span>      https://krew.sigs.k8s.io/
 <span class="token operator">|</span> Caveats:
 <span class="token operator">|</span> \
 <span class="token operator">|</span>  <span class="token operator">|</span> krew is now installed<span class="token operator">!</span> To start using kubectl plugins, you need to add
 <span class="token operator">|</span>  <span class="token operator">|</span> krew's installation directory to your PATH:
 <span class="token operator">|</span>  <span class="token operator">|</span>
 <span class="token operator">|</span>  <span class="token operator">|</span>   * macOS/Linux:
 <span class="token operator">|</span>  <span class="token operator">|</span>     - Add the following to your ~/.bashrc or ~/.zshrc:
 <span class="token operator">|</span>  <span class="token operator">|</span>         <span class="token function">export</span> PATH<span class="token operator">=</span><span class="token string">"<span class="token variable">${KREW_ROOT:-$HOME/.krew}</span>/bin:<span class="token variable">$PATH</span>"</span>
 <span class="token operator">|</span>  <span class="token operator">|</span>     - Restart your shell.
 <span class="token operator">|</span>  <span class="token operator">|</span>
 <span class="token operator">|</span>  <span class="token operator">|</span>   * Windows: Add %USERPROFILE%\.krew\bin to your PATH environment variable
 <span class="token operator">|</span>  <span class="token operator">|</span>
 <span class="token operator">|</span>  <span class="token operator">|</span> To list krew commands and to get help, run:
 <span class="token operator">|</span>  <span class="token operator">|</span>   $ kubectl krew
 <span class="token operator">|</span>  <span class="token operator">|</span> For a full list of available plugins, run:
 <span class="token operator">|</span>  <span class="token operator">|</span>   $ kubectl krew search
 <span class="token operator">|</span>  <span class="token operator">|</span>
 <span class="token operator">|</span>  <span class="token operator">|</span> You can <span class="token function">find</span> documentation at
 <span class="token operator">|</span>  <span class="token operator">|</span>   https://krew.sigs.k8s.io/docs/user-guide/quickstart/.
 <span class="token operator">|</span> /
/

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>安装后需要进行配置环境变量</p>
<pre><code>$ cat &gt;&gt;EOF&lt; ~/.bashrc
export PATH=&quot;${KREW_ROOT:-$HOME/.krew}/bin:$PATH&quot;
EOF
</code></pre><p>安装krew完成后，需要退出终端重新进行登录。这时候使用krew安装ingress排查工具ingress-nginx，如下：</p>
<pre><code>kubectl krew update
kubectl krew install ingress-nginx

// 或者直接通过压缩包进行安装，需要先下载该压缩包
$ wget https://github.com/kubernetes/ingress-nginx/releases/download/controller-0.31.0/kubectl-ingress_nginx-linux-amd64.tar.gz

// 还要下载yaml配置文件
$ wget https://github.com/kubernetes-sigs/krew-index/blob/master/plugins/ingress-nginx.yaml

// 通过yaml文件同压缩包一起安装
$ kubectl krew install --manifest=ingress-nginx-plugin.yaml --archive=kubectl-ingress_nginx-linux-amd64.tar.gz
Installing plugin: ingress-nginx
Installed plugin: ingress-nginx
\
 | Use this plugin:
 |      kubectl ingress-nginx
 | Documentation:
 |      https://kubernetes.github.io/ingress-nginx/kubectl-plugin/
/

// 执行命令进行验证
kubectl ingress-nginx --help
</code></pre><p>下面就可以进行问题排查了。</p>
<p><strong>参考文章</strong></p>
<ul>
<li><a href="https://segmentfault.com/a/1190000023088442" target="_blank" rel="noopener">https://segmentfault.com/a/1190000023088442</a></li>
<li><a href="https://segmentfault.com/a/1190000021784761" target="_blank" rel="noopener">https://segmentfault.com/a/1190000021784761</a></li>
</ul>
<p>2.12.6 ingress替代品：traefik</p>
<p>需要解决的问题是，如何让traefik使用ClusterIP的方式部署在node节点，通过80端口访问。</p>
<p>需要验证的问题是，如果ingress-nginx使用默认部署的方式，通过port-forward是否可以正常进行访问？</p>
<p>2.13 ConfigMap &amp;&amp; Secret</p>
<p>2.13.1 ConfigMap</p>
<p>ConfigMap管理配置文件或者一些大量的环境变量信息。ConfigMap将配置和Pod分离，更易于配置文件的更改和管理。</p>
<p>Secret更倾向于存储和共享敏感、加密的配置信息。</p>
<p>2.13.2 创建ConfigMap</p>
<p>通过本地目录下的多个配置文件创建配置信息</p>
<pre><code>mkdir -p configure-pod-container/configmap

touch game.properties &amp;&amp; touch user-interface.properties

cat &lt;&lt;EOF&gt; game.properties
enemy.types=aliens,monsters
player.maximum-lives=5 
EOF

cat &lt;&lt;EOF&gt;&lt;/EOF&gt; user-interface.properties
color.good=purple
color.bad=yellow
allow.textmode=true
EOF

// 从文件中创建配置信息
kubectl create configmap game-config --from-file=configure-pod-container/configmap/

kubectl describe cm game-config

// 通过yaml文件的方式创建
kubectl get cm game-config -o yaml</code></pre><p><strong>注意：</strong>在实际使用过程中，尽可能使用配置文件进行创建，减少直接在命令行中编写配置信息的方式。</p>
<p>通过本地配置文件创建配置信息</p>
<pre><code>
kubectl create configmap game-config-ui --from-file=configure-pod-container/configmap/user-interface.properties

// 更改配置文件名称，在--from-file=后指定名称
kubectl create configmap game-config-ui-rename --from-file=ui-pro=configure-pod-container/configmap/user-interface.properties
</code></pre><p>创建key-value形式的配置文件，不展示配置文件名称。</p>
<pre><code>touch configure-pod-container/configmap/user-env-interface.properties

cat &lt;&lt;EOF&gt; configure-pod-container/configmap/user-env-interface.properties
color.good=red
color.bad=yellow
color.middle=blue
allow.textmode=true
EOF

kubectl create configmap game-config-env --from-env-file=configure-pod-container/configmap/user-env-interface.properties

// 以key-value形式展示，不包含文件名称信息
# kubectl describe configmap game-config-env
Name:         game-config-env
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Data
====
allow.textmode:
----
true
color.bad:
----
yellow
color.good:
----
red
color.middle:
----
blue
Events:  &lt;none&gt;


// 查看生成的配置信息
kubectl get configmap game-config-env -o yaml</code></pre><p>可以通过上述方式生成配置文件信息，利用yaml格式进行创建。</p>
<p><strong>注意：</strong> 如果指定了多个–from-env-file后，只有最后一个指定的生效，前面指定的配置信息将会被覆盖掉。</p>
<p>从一个字段创建ConfigMap</p>
<pre><code>kubectl create cm bite-config --from-literal=special.how=very --from-literal=special.types=vtec --from-literal=special.who=JIM
</code></pre><p>2.13.3 ConfigMap用途</p>
<p>2.13.3.1 作为环境变量的方式</p>
<p>在Pod中读取ConfigMap的信息，实现将上面创建的ConfigMap中的值作为环境变量在Pod中输出。Pod的配置文件如下：</p>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mypod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>container
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"env"</span><span class="token punctuation">]</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> SPECIAL_LEVEL_KEY
      <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span> 
        <span class="token key atrule">configMapKeyRef</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> bite<span class="token punctuation">-</span>config
          <span class="token key atrule">key</span><span class="token punctuation">:</span> special.how
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建上面的Pod信息并查看输出的环境变量：</p>
<pre><code>kubectl create -f test-pod.yaml

kubectl logs -f mypod | grep SPECIAL_LEVEL_KEY
SPECIAL_LEVEL_KEY=very


// 查看bite-config的key-value信息
kubectl get cm bite-config -o yaml</code></pre><p>上述方式用的少，尽量使用一个ConfigMap就把所有环境变量包含进去，不要一个个设置。</p>
<pre class="line-numbers language-yaml"><code class="language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>config
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">SPECIAL_LEVEL</span><span class="token punctuation">:</span> very
  <span class="token key atrule">SPECIAL_TYPE</span><span class="token punctuation">:</span> charm

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mypod<span class="token punctuation">-</span>multi
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>container<span class="token punctuation">-</span>multi
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"env"</span><span class="token punctuation">]</span>
    <span class="token key atrule">envFrom</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">configMapRef</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>config <span class="token comment" spellcheck="true"># name should be indented under the secretRef or configMapRef fields</span>
    <span class="token comment" spellcheck="true"># 手动添加</span>
    <span class="token key atrule">env</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test1
      <span class="token key atrule">value</span><span class="token punctuation">:</span> test1<span class="token punctuation">-</span>value
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> port
      <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"3306"</span>  <span class="token comment" spellcheck="true"># value部分只能是字符串</span>
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以<em>envFrom</em>这种形式设置环境变量最常用。</p>
<p>2.13.3.2 作为配置文件的方式</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mypod<span class="token punctuation">-</span>volume
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>container<span class="token punctuation">-</span>volume
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"sleep 3600"</span><span class="token punctuation">]</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /mnt/1
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume<span class="token punctuation">-</span>file
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /mnt/2
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume
    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> env<span class="token punctuation">-</span>config
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>volume<span class="token punctuation">-</span>file
    <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> game<span class="token punctuation">-</span>config<span class="token punctuation">-</span>ui
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>通过延时来保证Pod运行，然后进入镜像中查看配置信息，如下：</p>
<pre><code># kubectl exec -it mypod-volume -- sh
/ # ls
bin   dev   etc   home  mnt   proc  root  sys   tmp   usr   var
/ # cd /mnt/
/mnt # ls
1  2
/mnt # cd 1/
/mnt/1 # ls
SPECIAL_LEVEL  SPECIAL_TYPE
/mnt/1 # cat SPECIAL_LEVEL
very/mnt/1 # cd ..
/mnt # ls
1  2
/mnt # cd 2/
/mnt/2 # ls
user-interface.properties
/mnt/2 # cat user-interface.properties
color.good=purple
color.bad=yellow
allow.textmode=true
</code></pre><p>key-value的形式一半用作环境变量，文件的形式一般通过挂载的方式作为配置文件使用。</p>
<p>2.13.4 Secret</p>
<p>Secret：用来保存敏感信息的，比如密码、令牌或者key值，例如Redis、MySQL的密码等。</p>
<p>2.13.4.1 Secret创建</p>
<p>通过配置文件来创建Secret</p>
<pre><code>
echo &quot;admin&quot; &gt; ./admin.txt

echo &quot;1234567&quot; &gt; ./password.txt

kubectl create secret generic db-user-pass --from-file=admin.txt --from-file=password.txt

kubectl get secret db-user-pass -o yaml
apiVersion: v1
data:
  admin.txt: YWRtaW4K
  password.txt: MTIzNDU2Nwo=
kind: Secret
metadata:
  creationTimestamp: &quot;2021-01-26T14:28:41Z&quot;
  managedFields:
  - apiVersion: v1
    fieldsType: FieldsV1
    fieldsV1:
      f:data:
        .: {}
        f:admin.txt: {}
        f:password.txt: {}
      f:type: {}
    manager: kubectl-create
    operation: Update
    time: &quot;2021-01-26T14:28:41Z&quot;
  name: db-user-pass
  namespace: default
  resourceVersion: &quot;798263&quot;
  uid: df3f2dd3-3f5d-4d90-993b-39a5c0ce7845


echo &quot;MTIzNDU2Nwo=&quot; | base64 --decode
</code></pre><p><strong>注意：</strong>在Secret存储时，使用base64进行了加密。</p>
<p>直接通过命令行创建，但是需要注意的是，在双引号字符串中，使用特殊字符的，必须使用命令行进行转译，例如$，\，*，!，否则无法创建。如果含有特殊字符时使用单引号，则特殊字符不需要转义。</p>
<pre><code>
kubectl create secret generic db-user --from-literal=username=user001 --from-literal=passwd=&quot;\!\\\*QAZxsw2&quot;

// 等同于

kubectl create secret generic db-user-2 --from-literal=username=user001 --from-literal=passwd=&#39;!\*QAZxsw2&#39;
</code></pre><p>可以通过配置文件的方式进行创建，但是创建之前需要注意，在data下所使用的字符串必须经过base64加密，而在stringData下使用的字符串则不需要加密，如下：</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> db<span class="token punctuation">-</span>user<span class="token punctuation">-</span><span class="token number">3</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">passwd</span><span class="token punctuation">:</span> XCFcXCpRQVp4c3cy
  <span class="token key atrule">username</span><span class="token punctuation">:</span> dXNlcjAwMQ==
<span class="token key atrule">stringData</span><span class="token punctuation">:</span>
  <span class="token key atrule">center</span><span class="token punctuation">:</span> daioafiah
  <span class="token key atrule">username</span><span class="token punctuation">:</span> myname
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>执行命令创建</p>
<pre><code>kubectl create -f secret.yaml
</code></pre><p><strong>注意：</strong>stringData优先级高于data，如果stringData中存在和data中同样key值的字符串，以stringData中的为准。</p>
<p>默认类型为Opaque，</p>
<p>2.13.4.2 Secret使用</p>
<p>配置secretName的方式进行读写。</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mypod<span class="token punctuation">-</span>secret
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> test<span class="token punctuation">-</span>container<span class="token punctuation">-</span>volume
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"sleep 3600"</span><span class="token punctuation">]</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> secret<span class="token punctuation">-</span>volume
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /mnt/1
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true  </span><span class="token comment" spellcheck="true"># 只读模式</span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> secret<span class="token punctuation">-</span>volume
    <span class="token key atrule">secret</span><span class="token punctuation">:</span>
      <span class="token key atrule">secretName</span><span class="token punctuation">:</span> db<span class="token punctuation">-</span>user<span class="token punctuation">-</span><span class="token number">3</span>
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code>kubectl create -f pod-secret.yaml
</code></pre><p><strong>注意：</strong>将信息挂载到镜像后，在对应路径的文件中，会以明文的形式保存。</p>
<p>典型用法：ImagePullSecret，Pod拉取私有镜像仓库时使用的账号密码，里面的账号信息会传递给kubelet，然后kubelet就可以拉取有用户名密码设置的镜像仓库中的镜像。</p>
<p>创建一个docker registry类型的secret</p>
<pre><code>
kubectl create secret docker-registry docker-secret --docker-server=DOCKER_REGISTRY_SERVER --docker-username=DOCKER_USER --docker-password=DOCKER_PASSWORD --docker-email=DOCKER_EMAIL

kubectl get secret docker-secret -o yaml
apiVersion: v1
data:
  .dockerconfigjson: eyJhdXRocyI6eyJET0NLRVJfUkVHSVNUUllfU0VSVkVSIjp7InVzZXJuYW1lIjoiRE9DS0VSX1VTRVIiLCJwYXNzd29yZCI6IkRPQ0tFUl9QQVNTV09SRCIsImVtYWlsIjoiRE9DS0VSX0VNQUlMIiwiYXV0aCI6IlJFOURTMFZTWDFWVFJWSTZSRTlEUzBWU1gxQkJVMU5YVDFKRSJ9fX0=
kind: Secret
metadata:
  creationTimestamp: &quot;2021-01-27T14:19:59Z&quot;
  managedFields:
  - apiVersion: v1
    fieldsType: FieldsV1
    fieldsV1:
      f:data:
        .: {}
        f:.dockerconfigjson: {}
      f:type: {}
    manager: kubectl-create
    operation: Update
    time: &quot;2021-01-27T14:19:59Z&quot;
  name: docker-secret
  namespace: default
  resourceVersion: &quot;811770&quot;
  uid: 80501ce1-ead7-4b7f-af33-5df46b8674fa
type: kubernetes.io/dockerconfigjson

</code></pre><p>下面将该secret挂载到创建容器的配置文件上，如下：</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">imagePullSecrets</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> docker<span class="token punctuation">-</span>secret
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> tomcat<span class="token punctuation">:</span>8.0.51<span class="token punctuation">-</span>alpine
    <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
    <span class="token key atrule">name</span><span class="token punctuation">:</span> tomcat
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
      <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log
    <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/run/secrets/kubernetes.io/serviceaccount
      <span class="token key atrule">name</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>token<span class="token punctuation">-</span>fzgbs
      <span class="token key atrule">readOnly</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后执行生效，pod将会从指定的镜像地址中，通过验证信息确定拉取镜像！</p>
<p>也可以将Secret放在ServiceAccount中，pod挂载ServiceAccount来实现私有仓库拉取时的验证！</p>
<p><strong>补充：</strong> ServiceAccount</p>
<p>2.13.4.3 SubPath使用</p>
<p>由于将配置文件或者Secret挂载到容器内的某个目录时，会覆盖该目录下的所有文件，可能会引起容器工作不正常。利用Subpath来解决目录覆盖的问题。</p>
<p>以nginx容器作为示例，首先导出nginx容器的配置：</p>
<pre><code>kubectl exec -it nginx-app-76b5cd66f5-mvc5d -- cat /etc/nginx/nginx.conf &gt; nginx.conf
</code></pre><p>然后通过该配置文件创建ConfigMap，</p>
<pre><code>kubectl create configmap nginx-conf --from-file=nginx.conf
</code></pre><p>修改deployment为nginx-app的配置信息，挂载该配置文件，如下：</p>
<pre><code>kubectl edit deploy nginx-app
// 修改配置

      name: nginx
      // 3. 修改启动命令
      command: [&quot;sh&quot;,&quot;-c&quot;,&quot;sleep 3600&quot;]
      ......
      ......
      containers:
      - image: nginx
        imagePullPolicy: Always
        name: nginx
        // 2. 添加volumeMounts挂载到容器的目录下
        volumeMounts:
        - name: config-volume
          mountPath: /etc/nginx
      ......
      ......    
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
      // 1. 添加volume信息
      volumes:
      - name: config-volume
        configMap:
          name: nginx-conf

</code></pre><p>最后来查看效果，会发现，原来nginx容器/etc/nginx目录下会被覆盖掉。</p>
<pre><code>kubectl exec -it       nginx-app-6dcd794b48-hx784 -- ls /etc/nginx
// 只有一条结果，其它的配置文件不存在
nginx.conf
</code></pre><p>使用subpath来解决这个问题，如下：</p>
<pre><code>kubectl edit deploy nginx-app
// 修改配置

      name: nginx
      command: [&quot;sh&quot;,&quot;-c&quot;,&quot;sleep 3600&quot;]
      ......
      ......
      containers:
      - image: nginx
        imagePullPolicy: Always
        name: nginx
        volumeMounts:
        - name: config-volume
          // 1. 首先修改mountPath信息，加入文件的完整路径
          mountPath: /etc/nginx/nginx.conf
          // 3. 添加subPath
          // 该处subPath路径和下面编写的items下的路径相同
          subPath：etc/nginx/nginx.conf
      ......
      ......    
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
      volumes:
      - name: config-volume
        configMap:
          name: nginx-conf
          // 2. 添加items
          items:
          - key: nginx.conf
            // 注意：path的位置不能以“/”开头
            path: etc/nginx/nginx.conf
</code></pre><p>这样配置完成后，在subPath中以文件形式挂载，就能正常在nginx配置中生效了，下面查看该configMap的信息如下：</p>
<pre><code>kubectl get cm nginx-conf -oyaml
// 所有配置信息如下
apiVersion: v1
data:
  nginx.conf: &quot;\r\nuser  nginx;\r\nworker_processes  1;\r\n\r\nerror_log  /var/log/nginx/error.log
    warn;\r\npid        /var/run/nginx.pid;\r\n\r\n\r\nevents {\r\n    worker_connections
    \ 1024;\r\n}\r\n\r\n\r\nhttp {\r\n    include       /etc/nginx/mime.types;\r\n
    \   default_type  application/octet-stream;\r\n\r\n    log_format  main  &#39;$remote_addr
    - $remote_user [$time_local] \&quot;$request\&quot; &#39;\r\n                      &#39;$status
    $body_bytes_sent \&quot;$http_referer\&quot; &#39;\r\n                      &#39;\&quot;$http_user_agent\&quot;
    \&quot;$http_x_forwarded_for\&quot;&#39;;\r\n\r\n    access_log  /var/log/nginx/access.log  main;\r\n\r\n
    \   sendfile        on;\r\n    #tcp_nopush     on;\r\n\r\n    keepalive_timeout
    \ 65;\r\n\r\n    #gzip  on;\r\n\r\n    include /etc/nginx/conf.d/*.conf;\r\n}\r\n&quot;
kind: ConfigMap
metadata:
  creationTimestamp: &quot;2021-02-09T02:24:49Z&quot;
  managedFields:
  - apiVersion: v1
    fieldsType: FieldsV1
    fieldsV1:
      f:data:
        .: {}
        f:nginx.conf: {}
    manager: kubectl-create
    operation: Update
    time: &quot;2021-02-09T02:24:49Z&quot;
  name: nginx-conf
  namespace: default
  resourceVersion: &quot;835513&quot;
  uid: 87638177-e623-40e9-96bd-eb39fb84c5c7

// 查看该目录下的所有文件信息，发现目录下的文件不再被覆盖
kubectl exec -it nginx-app-5cbd79f89c-2qwdf -- ls /etc/nginx

conf.d  fastcgi_params  koi-utf  koi-win  mime.types  modules  nginx.conf  scgi_params  uwsgi_params  win-utf
</code></pre><p>subPath也可以用在动态PV中，在一个目录下挂载两个path。</p>
<p><strong>补充：</strong> 以图形化的方式编写k8s的配置文件。</p>
<p>2.13.4.4 配置信息的热更新</p>
<p>如果ConfigMap和Secret如果是以subPath的形式挂载的，那么Pod是不会感知到ConfigMap和Secret的更新。也就是无法将配置信息同步到Pod中。</p>
<p>如果Pod的变量来自于ConfigMap和Secret中定义的内容，那么ConfigMap和Secret更新后，也不会更新Pod中的变量。</p>
<p>在上一节操作的基础上，添加一组对照的内容，如下：</p>
<pre><code>kubectl edit deploy nginx-app
// 修改配置信息
    ......
    ......
    spec:
      containers:
      - command:
        - sh
        - -c
        - sleep 3600
        image: nginx
        imagePullPolicy: Always
        name: nginx
        ports:
        - containerPort: 80
          protocol: TCP
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        // 2. 添加新的挂载点
        volumeMounts:
        - mountPath: /etc/nginx/nginx.conf
          name: config-volume
          subPath: etc/nginx/nginx.conf
        // 添加mnt挂载新的路径
        - mountPath: /mnt/
          name: config-volume-non-subpath
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
      volumes:
      - configMap:
          defaultMode: 420
          items:
          - key: nginx.conf
            path: etc/nginx/nginx.conf
          name: nginx-conf
        name: config-volume
      // 1. 添加新的配置信息
      - configMap:
          defaultMode: 420
          name: nginx-conf
        name: config-volume-non-subpath
        ......
        ......</code></pre><p>查看最终结果信息，如下：</p>
<pre><code>
kubectl exec -it nginx-app-d87589bdc-jsc9r -- cat /etc/nginx/nginx.conf
// 输出结果如下
user  nginx;
worker_processes  2;

kubectl exec -it nginx-app-d87589bdc-jsc9r -- cat /mnt/nginx.conf
// 输出结果如下
user  nginx;
worker_processes  2;
</code></pre><p>修改ConfigMap，将work_processes的值改为3，然后再进行查看，如下：</p>
<pre><code>
kubectl edit cm nginx-conf
// 修改配置信息
worker_processes 3;

// 等待2分钟左右会在Pod中生效

// 查看如下：
kubectl exec -it nginx-app-d87589bdc-jsc9r -- cat /etc/nginx/nginx.conf
// 输出结果如下
user  nginx;
worker_processes  2;

kubectl exec -it nginx-app-d87589bdc-jsc9r -- cat /mnt/nginx.conf
// 输出结果如下
user  nginx;
worker_processes  3;
</code></pre><p>由上述结果对比，subPath的方式不能进行配置信息的热更新。</p>
<p>在热更新修改ConfigMap的时候，有以下三种方式，修改比较完善：</p>
<ol>
<li>（<strong>待补充</strong>）图形化资源管理平台进行修改–Ratel</li>
<li>kubectl edit cm ConfigMap名称，在线进行修改</li>
<li>修改配置文件后，使用create + –dry-run命令进行运行，如下：</li>
</ol>
<pre><code>kubectl create cm nginx-conf --from-file=nginx.conf --dry-run=client -oyaml | kubectl replace -f-
</code></pre><p><em>–dry-run</em>:–dry-run=’none’: Must be “none”, “server”, or “client”. If client strategy, only print the object that would be sent, without sending it. If server strategy, submit server-side request without persisting the resource.</p>
<p>分两步区别的话，通过–dry-run命令生成配置文件的yaml信息，然后使用replace来进行替代。</p>
<p>热更新Secret时，将上述命令中的ConfigMap更换为Secret即可。</p>
<p><strong>注意：</strong>不可变的ConfigMap和Secret，immutable ConfigMap和immutable Secret。</p>
<p>在yaml配置文件中，添加<strong>immutable: true</strong>这一句配置信息。k8s 1.18版本以后可用。</p>
<p>2.14 存储卷和存储–Volumes</p>
<p>2.14.1 Volumes</p>
<p>解决问题：</p>
<ol>
<li>Container中的磁盘文件是短暂的，但容器崩溃时，kubelet会重新启动容器，但最初的文件会丢失。通过Volumes来保存这些文件。</li>
<li>当一个Pod运行多个Container时，各个容器可能需要共享一些文件，通过Volumes来进行共享文件的存储。同时可以支持多个Pod之间的文件共享。</li>
</ol>
<p>总结：一些需要持久化数据的程序或者需要共享数据的容器需要使用Volumes。例如：Redis-Cluster中的配置文件nodes.conf，日志收集的需求，需要在应用程序的容器里面加一个SideCar，这个容器专门负责收集日志，比如filebeat，它通过volumes共享应用程序的日志文件目录。</p>
<p>其它：nfs作为存储来说效率太低。使用其它的后端存储或者云存储代替。</p>
<p>2.14.2 HostPath模式</p>
<p>hostPath：将节点上的文件和目录挂载到Pod上，如果Pod被删除，将会hostPath指定的路径将会不变。</p>
<p>不推荐使用，无法保证Pod总是部署在特定的节点上，如果更换了节点，将会导致对应的文件找不到，导致运行失败的情况。</p>
<p>演示：通过hostPath挂载timezone文件信息</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token comment" spellcheck="true"># vim nginx-volumes.yaml</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.16.1
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> enter
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token comment" spellcheck="true"># 2. 挂载该volume文件信息 </span>
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/timezone
          <span class="token key atrule">name</span><span class="token punctuation">:</span> timezone
      <span class="token comment" spellcheck="true"># 1. 添加该Volume信息，挂载/etc/timezone文件</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> timezone
        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/timezone
          <span class="token key atrule">type</span><span class="token punctuation">:</span> File
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使配置信息生效，并且查看时区信息，如下：</p>
<pre><code>// 使配置信息生效
# kubectl apply -f nginx-volumes.yaml

# kubectl exec -it nginx-689f8fd586-mq57p -- cat /etc/timezone
Asia/Shanghai

# cat /etc/timezone
Asia/Shanghai

# kubectl exec -it nginx-app-d87589bdc-jsc9r -- cat /etc/timezone
Etc/UTC
</code></pre><p>hostPath支持的类型如下：</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>解释</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>空字符串（默认）用于向后兼容，这意味着在安装 hostPath 卷之前不会执行任何检查。</td>
</tr>
<tr>
<td>DirectoryOrCreate</td>
<td>如果在给定路径上什么都不存在，那么将根据需要创建空目录，权限设置为 0755，具有与 kubelet 相同的组和属主信息。</td>
</tr>
<tr>
<td>Directory</td>
<td>在给定路径上必须存在的目录。</td>
</tr>
<tr>
<td>FileOrCreate</td>
<td>如果在给定路径上什么都不存在，那么将在那里根据需要创建空文件，权限设置为 0644，具有与 kubelet 相同的组和所有权。</td>
</tr>
<tr>
<td>File</td>
<td>在给定路径上必须存在的文件。</td>
</tr>
<tr>
<td>Socket</td>
<td>在给定路径上必须存在的 UNIX 套接字。</td>
</tr>
<tr>
<td>CharDevice</td>
<td>在给定路径上必须存在的字符设备。</td>
</tr>
<tr>
<td>BlockDevice</td>
<td>在给定路径上必须存在的块设备。</td>
</tr>
</tbody></table>
<p>当使用这种类型的卷时要小心，因为：</p>
<ol>
<li>具有相同配置（例如基于同一 PodTemplate 创建）的多个 Pod 会由于节点上文件的不同 而在不同节点上有不同的行为。</li>
<li>下层主机上创建的文件或目录只能由 root 用户写入。你需要在 特权容器 中以 root 身份运行进程，或者修改主机上的文件权限以便容器能够写入 hostPath 卷。</li>
</ol>
<p>2.14.3 emptyDir模式</p>
<p>共享目录使用该模式进行，可以被挂载到相同或者不同的卷上。如果删除Pod，emptyDir卷中的数据也将被删除。</p>
<p>默认情况下，emptyDir卷支持节点上的任何介质，可能是SSD、磁盘或网络存储，具体取决于自身的环境。可以将emptyDir.medium字段设置为Memory,让Kubernetes使用tmpfs （内存支持的文件系统），虽然tmpfs非常快，但是tmpfs在节点重启时，数据同样会被清除，并且设置的大小会被计入到Container的内存限制当中。</p>
<p>在上一个hostPath的基础上，进行修改：</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token comment" spellcheck="true"># 3. 创建一个非同名容器，挂载到/opt目录下</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.16.1
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> enter
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /opt
          <span class="token key atrule">name</span><span class="token punctuation">:</span> share<span class="token punctuation">-</span>volume
      <span class="token comment" spellcheck="true"># 2. 创建一个非同名容器，挂载到/mnt目录下</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.16.1
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span><span class="token number">2</span>
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> enter
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /mnt
          <span class="token key atrule">name</span><span class="token punctuation">:</span> share<span class="token punctuation">-</span>volume

      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token comment" spellcheck="true"># 1. 创建一个emptyDir路径</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> share<span class="token punctuation">-</span>volume
        <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
          <span class="token comment" spellcheck="true"># 如果使用Memory的设置，需要去除上面的花括号</span>
          <span class="token comment" spellcheck="true">#medium: Memory</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> timezone
        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/timezone
          <span class="token key atrule">type</span><span class="token punctuation">:</span> File
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在一个Pod中启动多个容器，其网络空间是共享的，而两个nginx容器，均使用了80端口，在启动第二个容器时出现了端口被占用的问题。</p>
<p>临时的解决方式是，修改启动的command命令，例如将第二个pod重新配置command命令信息，如下：</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token punctuation">...</span><span class="token punctuation">...</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.16.1
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx<span class="token punctuation">-</span><span class="token number">2</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span> 
        <span class="token punctuation">-</span> sh
        <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
        <span class="token punctuation">-</span> sleep 3600
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> enter
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /mnt
          <span class="token key atrule">name</span><span class="token punctuation">:</span> share<span class="token punctuation">-</span>volume

<span class="token punctuation">...</span><span class="token punctuation">...</span>

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>彻底的解决办法是，尽可能不使用相同的pod进行部署，或者修改command启动命令，更换端口号信息。</p>
<p>这样修改完成后，在第一个名称为nginx的container中创建文件并添加内容如下：</p>
<pre><code># kubectl exec -it nginx-5d67cccf59-69fv8 -c nginx --  bash

root@nginx-5d67cccf59-69fv8:/# touch /mnt/123 &amp;&amp; echo &#39;111111&#39; &gt; 123

// exit退出该容器
</code></pre><p>第一个container中挂载的目录为/mnt，因此在/mnt目录下创建，而第二个container中挂载的目录为/opt，这样在第二个容器的opt目录中查看第一个容器中创建的文件信息</p>
<pre><code>
# kubectl exec -it nginx-5d67cccf59-69fv8 -c nginx2 --  bash

root@nginx-5d67cccf59-69fv8:/# cat /opt/123
// 输出内容如下
111111
</code></pre><p>这样就实现了文件的共享。需要注意的是，在含有多个容器的Pod中，指定要访问的容器信息，需要使用”-c”来进行指定。</p>
<p>2.14.4 nfs安装与挂载</p>
<p>在192.168.229.54这台机器上安装nfs，如下：</p>
<pre><code>
# yum install nfs-utils -y

# systemctl enable nfs-server &amp;&amp; systemctl start nfs-server
</code></pre><p>这样就启动了nfs服务，查看当前nfs服务支持的nfs版本，如下：</p>
<pre><code># cat /proc/fs/nfsd/versions
-2 +3 +4 +4.1 +4.2
</code></pre><p>下面开始创建并配置共享目录，如下：</p>
<pre><code># mkdir -p /data/nfs

// 修改export配置文件，加入该目录

# vim /etc/exports
// 添加以下内容
/data/nfs 192.168.229.0/24(rw,sync,no_subtree_check,no_root_squash)

// :wq保存退出

// 配置完成后需要使配置生效
# exportfs -r

# systemctl restart nfs-server</code></pre><p>这样nfs就安装完成了，重要的是，需要给剩下的每个节点装一下nfs-utils，否则会出现挂载的时候识别不了nfs存储。全部安装完成后，下面回到192.168.229.51这台机器上，尝试挂载nfs，操作如下：</p>
<pre><code># mount -t nfs 192.168.229.54:/data/nfs /mnt/
</code></pre><p>挂载完成后可以在nfs安装的机器上查看挂载信息，如下：</p>
<pre><code># showmount -e
Export list for k8s-node-01:
/data/nfs 192.168.229.0/24
</code></pre><p>这时回到192.168.229.51机器上，创建文件，测试nfs是否可用，如下：</p>
<pre><code># cd /mnt &amp;&amp; touch 123 &amp;&amp; echo &quot;111111111111111111&quot; &gt; 123
</code></pre><p>在nginx中挂载nfs服务，首先在192.168.229.51所在机器上，卸载nfs服务所在的文件夹，然后再进行挂载。</p>
<pre><code>
# umount /mnt

// 找到之前的nginx配置文件，通过volumes挂载nfs服务
# cd ~/k8s-practice/volumes &amp;&amp; vim nginx-volumes.yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: nginx
  name: nginx
  namespace: default
spec:
  replicas: 3
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: nginx
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - image: nginx:1.16.1
        imagePullPolicy: IfNotPresent
        name: nginx
        ports:
        - name: enter
          containerPort: 80
        volumeMounts:
        - mountPath: /mnt
          name: share-volume

      - image: nginx:1.15.2
        imagePullPolicy: IfNotPresent
        name: nginx2
        command:
        - sh
        - -c
        - sleep 3600
        ports:
        - name: enter2
          containerPort: 81
        volumeMounts:
        - mountPath: /opt
          name: share-volume
        # 2. 挂载nfs服务
        - mountPath: /mnt
          name: nfs-volume          

      volumes:
      - name: share-volume
        emptyDir: {}
          # 如果使用Memory的设置，需要去除上面的花括号
          #medium: Memory
      - name: timezone
        hostPath:
          path: /etc/timezone
          type: File
      # 1. 添加nfs目录
      - name: nfs-volume
        nfs:
          server: 192.168.229.54
          # 0. 记得在nfs服务器上首先创建该目录，并且在该目录下创建名称为123的文件
          path: /data/nfs/test-dp

// :wq保存退出

// 使配置信息生效并进行查看
# kubectl replace -f nginx-deployment.yaml

// 查看结果
# kubectl exec -it nginx-64fcb85cd9-5gk8x -- ls -al /opt
drwxrwxrwx 2 root root 17 Feb 27 04:25 .
drwxr-xr-x 1 root root 28 Feb 27 04:28 ..
-rw-r--r-- 1 root root 19 Feb 27 04:25 123
</code></pre><p><strong>注意：</strong>在生产环境中还是不推荐使用nfs存储的，由于nfs没有任何高可用的保障，难以实现高可用的架构。</p>
<p>一般情况下使用pv和pvc的方式挂载nfs。</p>
<p>2.14.5 持久化存储PV和PVC</p>
<p>Volume：NFS、Ceph、GFS</p>
<p>PV：PersistentVolume，NFS、Ceph、GFS，由k8s配置连接不同的存储，PV同样使集群的一类资源，可以用yaml进行定义，相当于一块存储。可以由管理员定义，由PV去连接后向的存储。</p>
<p>PVC：PersistentVolumeClaim，对PV的申请。将PVC挂载到容器中，由容器去使用。</p>
<p>Pod –&gt; PVC –&gt; PV –&gt; Storage</p>
<p>PV/PVC用来管理k8s的存储，降低了复杂度和简化了使用。PV通过不同的配置，连接对应的后向存储，但是PVC连接PV的时候，使用相同的方式连接。PV用作申请存储，而PVC用作绑定存储。</p>
<p>PV又区分为动态存储和静态存储。</p>
<p>2.14.5.1 使用PV连接nfs存储</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0003
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment" spellcheck="true"># PV的容量</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
  <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token comment" spellcheck="true"># 回收策略</span>
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Recycle
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> slow
  <span class="token key atrule">mountOptions</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> hard
    <span class="token punctuation">-</span> nfsvers=4.1
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /tmp
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 172.17.0.2

<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>回收策略persistentVolumeReclaimPolicy: Retain、Recycle和Delete</p>
<ul>
<li>Recycle：回收并销毁文件，rm -rf</li>
<li>Retain: 保留</li>
<li>Delete：删除了PVC，同时也会删除PV，这一类的PV需要支持删除的功能（动态存储支持）</li>
</ul>
<p>Capacity：PV的容量</p>
<p>volumeMode： 挂载类型，FileSystem、block</p>
<p>accessModes：访问模式</p>
<ul>
<li>ReadWriteOnce： RWO，可以被单节点以读写模式挂载</li>
<li>ReadWriteMany： RWX，可以被多节点以读写模式挂载</li>
<li>ReadOnlyMany： ROX，可以被多个节点以只读模式挂载</li>
</ul>
<p>storageClassName：PV的类（类名），PVC和PV的这个名字一样才能被绑定，名字不同，读写权限不同是不能进行绑定的。</p>
<p>mountOptions：挂载参数</p>
<p><strong>注意：</strong>不需要记住所有的配置，只需要知道连接的原理即可。</p>
<p>实际操作，创建PV，配置文件如下：</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> pv0001
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment" spellcheck="true"># PV的容量</span>
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
  <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteMany
  <span class="token comment" spellcheck="true"># 回收策略</span>
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Recycle
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>slow
  <span class="token key atrule">mountOptions</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> hard
    <span class="token punctuation">-</span> nfsvers=4.1
  <span class="token key atrule">nfs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /data/nfs/test<span class="token punctuation">-</span>dp
    <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.229.54


<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>注意：PV没有namespace的限制，直接创建即可。但PVC有namespace限制！</p>
<pre><code>// 创建pv
# kubectl create -f nginx-pv.yaml

// 查看pv
# kubectl get pv
NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE
pv0001   1Gi        RWX            Recycle          Available           nfs-slow                9s
</code></pre><p>PV的状态：</p>
<ul>
<li>Available：空闲的，没有被任何pvc绑定</li>
<li>Bound: 已经被pvc绑定</li>
<li>Released： pvc被删除，但是资源未被重新使用</li>
<li>Failed：自动回收失败</li>
</ul>
<p>创建一个pvc去申请使用pv，配置文件如下：</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> myclaim
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token comment" spellcheck="true"># 访问策略要和pv中配置的权限一致</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token comment" spellcheck="true"># 存储大小不能超过pv创建时配置的文件大小</span>
      <span class="token comment" spellcheck="true"># 如果超过pv创建时配置的存储大小，将会导致找不到对应的pv</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
  <span class="token comment" spellcheck="true"># 这个位置名称要和pv中配置的名称一致</span>
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>slow
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建pv信息如下：</p>
<pre><code># kubectl create -f nginx-pvc.yaml

# kubectl get pvc
NAME     STATUS   VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS   AGE
my-pvc   Bound    pv0001   1Gi        RWX            nfs-slow       19s

# kubectl get pv
NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM            STORAGECLASS   REASON   AGE
pv0001   1Gi        RWX            Recycle          Bound    default/my-pvc   nfs-slow                12m
</code></pre><p>创建成功后，可以看到pv和pvc的状态，均为bound的状态，pv的claim下也显示了哪个pvc绑定了该pv。</p>
<p><strong>注意：</strong>PVC不允许使用kubectl edit命令进行更改</p>
<p>最后在deployment中使用这个pvc。</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">labels</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">revisionHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">10</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
  <span class="token key atrule">strategy</span><span class="token punctuation">:</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
      <span class="token key atrule">maxSurge</span><span class="token punctuation">:</span> 25%
      <span class="token key atrule">maxUnavailable</span><span class="token punctuation">:</span> 25%
    <span class="token key atrule">type</span><span class="token punctuation">:</span> RollingUpdate
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.16.1
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> enter
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /mnt
          <span class="token key atrule">name</span><span class="token punctuation">:</span> share<span class="token punctuation">-</span>volume
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /opt
          <span class="token key atrule">name</span><span class="token punctuation">:</span> nfs<span class="token punctuation">-</span>volume

      <span class="token punctuation">-</span> <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.15.2
        <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
        <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx2
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> sh
        <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
        <span class="token punctuation">-</span> sleep 3600
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> enter2
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">81</span>
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token comment" spellcheck="true"># 2. 挂载pvc所在的目录</span>
        <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /tmp/pvc
          <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc<span class="token punctuation">-</span>test

      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> share<span class="token punctuation">-</span>volume
        <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
          <span class="token comment" spellcheck="true"># 如果使用Memory的设置，需要去除上面的花括号</span>
          <span class="token comment" spellcheck="true">#medium: Memory</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> timezone
        <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
          <span class="token key atrule">path</span><span class="token punctuation">:</span> /etc/timezone
          <span class="token key atrule">type</span><span class="token punctuation">:</span> File
      <span class="token comment" spellcheck="true"># 1. 新增pvc的引用</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> pvc<span class="token punctuation">-</span>test
        <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
          <span class="token comment" spellcheck="true"># 注意：claimName对应的是pvc的名称</span>
          <span class="token key atrule">claimName</span><span class="token punctuation">:</span> my<span class="token punctuation">-</span>pvc
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>创建pv的配置文件信息可能有不同，但是对于pvc和volume的挂载，使用方式是一致的。</p>
<p>最后使其生效，然后查看结果：</p>
<pre><code># kubectl create -f nginx-pv-pvc.yaml

# kubectl get pod
NAME                          READY   STATUS      RESTARTS   AGE
nginx-6976f57754-75chk        2/2     Running     0          4m42s
nginx-6976f57754-8fjzp        2/2     Running     0          4m42s
nginx-6976f57754-rp6p5        2/2     Running     0          4m42s

# kubectl exec -it nginx-6976f57754-rp6p5 -c nginx2 -- df -Th
Filesystem                       Type     Size  Used Avail Use% Mounted on
overlay                          overlay   17G  5.0G   13G  30% /
tmpfs                            tmpfs     64M     0   64M   0% /dev
tmpfs                            tmpfs    2.0G     0  2.0G   0% /sys/fs/cgroup
/dev/mapper/centos-root          xfs       17G  5.0G   13G  30% /opt
192.168.229.54:/data/nfs/test-dp nfs4      17G  5.0G   13G  30% /tmp/pvc
shm                              tmpfs     64M     0   64M   0% /dev/shm
tmpfs                            tmpfs    2.0G   12K  2.0G   1% /run/secrets/kubernetes.io/serviceaccount
tmpfs                            tmpfs    2.0G     0  2.0G   0% /proc/acpi
tmpfs                            tmpfs    2.0G     0  2.0G   0% /proc/scsi
tmpfs                            tmpfs    2.0G     0  2.0G   0% /sys/firmware
</code></pre><p>可以看到<em>192.168.229.54:/data/nfs/test-dp nfs4      17G  5.0G   13G  30% /tmp/pvc</em>记录已经显示pvc挂载到该容器中。</p>
<p>这时候，可以进入到容器中对应的/tmp/pvc目录下，创建文件并添加内容，最终可以在nfs存储所在的机器上同时看到该文件。</p>
<p>2.14.5.2 常见问题</p>
<ul>
<li>创建PVC之后一致绑定不上PV</li>
</ul>
<ol>
<li>PVC的空间申请大小大于PV的大小</li>
<li>PVC的StorageClassName没有和PV中设定的一致</li>
<li>PVC的访问模式accessModes和PV中设定的不一致</li>
</ol>
<ul>
<li>创建挂载了PVC的Pod之后，一直处于Pending状态</li>
</ul>
<ol>
<li>PVC没有创建成功，或者没有被创建</li>
<li>PVC和Pod不在同一个namespace下</li>
</ol>
<p>存储删除时，如果要删除PVC，必须要先删除挂载该PVC的容器或者Deployment，之后再删除该PVC，否则PVC一直处于Terminal状态。</p>
<p>如果删除了PVC，再删除Pod，将会导致Deployment下的pod重新上线时，一直处在pending的状态，无法找到该PVC，也就无法挂载，导致Pod无法重新启动。这时候，PVC删除会出现超时的情况。</p>
<p>如果出现了上述情况，还要删除PVC，那么必须先删除使用该PVC的容器，因为PVC被删掉后，容器的运行状态不正常，无法对外提供服务。</p>
<p>删除时，必须先删除PV再删除PVC，如果先删除PVC，必须要把挂载该PVC的容器或者deployment删掉，</p>
<ul>
<li><p>PVC有namespace的区分，PV则是全局存在的。</p>
</li>
<li><p>Recycle模式下，回收PV时，会主动创建一个回收镜像来进行回收操作。删除PVC以后，k8s或创建一个用于回收的Pod，根据PV的回收策略进行PV的回收，回收完以后，PV的状态就会变成可被绑定的状态，也就是空闲状态，其它Pending状态的PVC如果匹配到这个PV，就可以和这个PV进行绑定。</p>
</li>
</ul>
<p>注意：PVC在任意一个namespace下都可以和对应的PV进行绑定。</p>
<ul>
<li><p>PV支持selector标签挂载。</p>
</li>
<li><p>自定义存储CSI的使用（待补充）</p>
</li>
</ul>
<p>2.14.6 cronjob计划任务</p>
<p>在k8s里面运行周期性的计划任务，类型linux上的crontab。</p>
<ul>
<li><p>“* * * * * 分 时 日 月 周”的编写方式，同crontab</p>
</li>
<li><p>计划任务可能需要调用应用的接口，可能需要依赖某些环境，例如php中运行cronjob，不需要在宿主机安装php环境，直接借助php的docker镜像（但是拉取镜像需要时间，需要考虑cronjob的运行调度）</p>
</li>
<li><p>cronjob被调用的时间，同controller-manager的时间一致。如果controller-manager是二进制进行启动，其时间和宿主机一致。如果部署在容器中，要保证容器的时间是正确的。</p>
</li>
</ul>
<p><strong>注意：</strong>cronjob的名字不能超过52个字符，创建时，会在该名称后面添加11个字符，如果超过63个字符，名称会过长导致不能解析该名称。</p>
<p>下面开始演示cronjob的编写方式。</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> hello
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token string">"*/2 * * * *"</span>
  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">template</span><span class="token punctuation">:</span>
        <span class="token key atrule">spec</span><span class="token punctuation">:</span>
          <span class="token key atrule">containers</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> hello
            <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
            <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
            <span class="token key atrule">command</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> /bin/sh
            <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
            <span class="token punctuation">-</span> date; echo Hello from the Kubernetes cluster
          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre><code># kubectl apply -f busybox-cronjob.yaml

# kubectl get cj hello
NAME    SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
hello   */2 * * * *   False     1        5s              10s

// 查看创建后的cronjob信息
# kubectl get cj hellp -oyaml
</code></pre><p>查看具体的cronjob配置信息如下：</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> batch/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CronJob
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> hello
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span> 
  <span class="token key atrule">concurrencyPolicy</span><span class="token punctuation">:</span> Allow  <span class="token comment" spellcheck="true"># 并发调度控制，Allow：允许同时运行多个任务；Forbid：不进行并发执行多个任务；Replace：替换之前的任务</span>
  <span class="token key atrule">failedJobsHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">1  </span><span class="token comment" spellcheck="true"># 保留失败的任务数，可以按需设置较大的数值，看到为何执行出错的问题</span>
  <span class="token key atrule">jobTemplate</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">template</span><span class="token punctuation">:</span>
        <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
          <span class="token key atrule">creationTimestamp</span><span class="token punctuation">:</span> <span class="token null important">null</span>
        <span class="token key atrule">spec</span><span class="token punctuation">:</span>
          <span class="token key atrule">containers</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">command</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> /bin/sh
            <span class="token punctuation">-</span> <span class="token punctuation">-</span>c
            <span class="token punctuation">-</span> date; echo Hello from the Kubernetes cluster
            <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
            <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
            <span class="token key atrule">name</span><span class="token punctuation">:</span> hello
            <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token key atrule">terminationMessagePath</span><span class="token punctuation">:</span> /dev/termination<span class="token punctuation">-</span>log
            <span class="token key atrule">terminationMessagePolicy</span><span class="token punctuation">:</span> File
          <span class="token key atrule">dnsPolicy</span><span class="token punctuation">:</span> ClusterFirst
          <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> OnFailure
          <span class="token key atrule">schedulerName</span><span class="token punctuation">:</span> default<span class="token punctuation">-</span>scheduler
          <span class="token key atrule">securityContext</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
          <span class="token key atrule">terminationGracePeriodSeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
  <span class="token key atrule">schedule</span><span class="token punctuation">:</span> <span class="token string">'*/2 * * * *'</span>   <span class="token comment" spellcheck="true"># 调度策略</span>
  <span class="token key atrule">successfulJobsHistoryLimit</span><span class="token punctuation">:</span> <span class="token number">3  </span><span class="token comment" spellcheck="true"># 成功的job保留的次数</span>
  <span class="token key atrule">suspend</span><span class="token punctuation">:</span> <span class="token boolean important">false  </span><span class="token comment" spellcheck="true"># 任务挂起，true，cronjob不会被执行</span>
  <span class="token key atrule">startingDeadlineSeconds</span><span class="token punctuation">:</span> <span class="token number">30 </span><span class="token comment" spellcheck="true"># 在30秒内失败后会继续重新调用执行该cronjob，直到成功执行为止</span>
<span class="token key atrule">status</span><span class="token punctuation">:</span>
  <span class="token key atrule">lastScheduleTime</span><span class="token punctuation">:</span> <span class="token string">"2021-03-07T01:58:00Z"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>最后，需要查看cronjob的执行内容，如下：</p>
<pre><code># kubectl get pod
NAME                          READY   STATUS      RESTARTS   AGE
hello-1615082760-wpkzd        0/1     Completed   0          6m
hello-1615082880-gvqg2        0/1     Completed   0          4m
hello-1615083000-vzhc6        0/1     Completed   0          119s

# kubectl logs -f hello-1615083000-vzhc6
Sun Mar  7 02:10:05 UTC 2021
Hello from the Kubernetes cluster
</code></pre><p><strong>注意：</strong>1. cronjob有namespace隔离的概念。2. pod随着执行完成的job，保留的数量有限，在查看执行结果前要想查看该pod是否还存在。</p>
<p>2.14.7 Taint &amp; Toleration</p>
<p>类比NodeSelector的内容。</p>
<p>污点和容忍的理念</p>
<p>Taint：在一类服务器上打上污点，让不能容忍这个污点的Pod不能部署在打了污点的服务器上。</p>
<p>例如Master节点不应该部署系统Pod之外的任何Pod上。可以用Taint进行打污点，每个节点可以打多个污点。</p>
<p>举例子如下：</p>
<p>某个Node机器上存在<em>gpu-server:true</em>的Taint污点存在，该节点只能部署容忍该污点的容器存在，而这时某个Pod上添加了一个Toleration满足<em>gpu-server:true</em>，才能部署到这个Node机器上。</p>
<p><em>taint的结构为： key=value:effect</em>。</p>
<p>在没打污点之前，查看一下各个Pod在k8s中的部署情况</p>
<pre><code># kubectl get pod -o wide
NAME                          READY   STATUS      RESTARTS   AGE     IP                NODE            NOMINATED NODE   READINESS GATES
busybox                       1/1     Running     163        48d     172.163.98.171    k8s-node-02     &lt;none&gt;           &lt;none&gt;
hello-1615085760-6mx25        0/1     Completed   0          5m56s   172.165.176.216   k8s-master-02   &lt;none&gt;           &lt;none&gt;
hello-1615085880-x2x4r        0/1     Completed   0          3m56s   172.164.183.161   k8s-master-03   &lt;none&gt;           &lt;none&gt;
hello-1615086000-hbbzz        0/1     Completed   0          115s    172.164.183.162   k8s-master-03   &lt;none&gt;           &lt;none&gt;
mypod                         0/1     Completed   0          40d     172.175.44.56     k8s-node-01     &lt;none&gt;           &lt;none&gt;
mypod-multi                   0/1     Completed   0          40d     172.175.44.57     k8s-node-01     &lt;none&gt;           &lt;none&gt;
mypod-secret                  0/1     Completed   0          39d     172.175.44.61     k8s-node-01     &lt;none&gt;           &lt;none&gt;
mypod-volume                  0/1     Completed   0          40d     172.175.44.58     k8s-node-01     &lt;none&gt;           &lt;none&gt;
nginx-6976f57754-75chk        2/2     Running     6          6d23h   172.163.98.187    k8s-node-02     &lt;none&gt;           &lt;none&gt;
nginx-6976f57754-8fjzp        2/2     Running     6          6d23h   172.174.107.71    k8s-master-01   &lt;none&gt;           &lt;none&gt;
nginx-6976f57754-rp6p5        2/2     Running     6          6d23h   172.175.44.19     k8s-node-01     &lt;none&gt;           &lt;none&gt;
nginx-app-d87589bdc-bqpff     1/1     Running     71         24d     172.175.44.60     k8s-node-01     &lt;none&gt;           &lt;none&gt;
nginx-app-d87589bdc-jsc9r     1/1     Running     71         24d     172.163.98.175    k8s-node-02     &lt;none&gt;           &lt;none&gt;
tomcat-app-866957f847-cth22   1/1     Running     1          41d     172.175.44.2      k8s-node-01     &lt;none&gt;           &lt;none&gt;
tomcat-app-866957f847-z87bw   1/1     Running     1          41d     172.163.98.176    k8s-node-02     &lt;none&gt;           &lt;none&gt;
</code></pre><p>可以看到k8s-master-01上有部署的业务Pod。在master节点打一个污点如下：</p>
<pre><code># kubectl taint node k8s-master-01 master-test=test:NoSchedule 
</code></pre><p><strong>注意：</strong>NoSchedule：只是让该节点不会被调度，无法进行强制迁移；</p>
<pre><code># kubectl edit deploy nginx

......
      restartPolicy: Always
      schedulerName: default-scheduler
      # 添加下面的nodeSelector信息
      nodeSelector:
        kubernetes.io/hostname: k8s-master-01
      securityContext: {}
      terminationGracePeriodSeconds: 30
      volumes:

......

# kubectl get pod -o wide

NAME                          READY   STATUS      RESTARTS   AGE     IP                NODE            NOMINATED NODE   READINESS GATES

nginx-7bd9f58674-w5fnp        0/2     Pending     0          3m22s   &lt;none&gt;            &lt;none&gt;          &lt;none&gt;           &lt;none&gt;

# kubectl describe pod  nginx-7bd9f58674-w5fnp
......
Events:
  Type     Reason            Age    From               Message
  ----     ------            ----   ----               -------
  Warning  FailedScheduling  4m46s  default-scheduler  0/5 nodes are available: 1 node(s) had taint {master-test: test}, that the pod didn&#39;t tolerate, 4 node(s) didn&#39;t match Pod&#39;s node affinity.
  Warning  FailedScheduling  4m46s  default-scheduler  0/5 nodes are available: 1 node(s) had taint {master-test: test}, that the pod didn&#39;t tolerate, 4 node(s) didn&#39;t match Pod&#39;s node affinity.
</code></pre><p>可以看到pod上没有master-test: test没有这个Toleration，不符合k8s-master-01节点上刚刚设置的Taint，导致pod无法被部署。</p>
<p>重新修改deploy，添加toleration测试：</p>
<pre><code># kubectl edit deploy nginx

......
      restartPolicy: Always
      schedulerName: default-scheduler
      # 添加下面的nodeSelector信息
      nodeSelector:
        kubernetes.io/hostname: k8s-master-01
      tolerations:
      - key: &quot;master-test&quot;
        value: &quot;test&quot;
        effect: &quot;NoSchedule&quot;
        operator: &quot;Equal&quot;
      securityContext: {}
      terminationGracePeriodSeconds: 30
      volumes:

......

# kubectl get pod -o wide
NAME                          READY   STATUS        RESTARTS   AGE     IP                NODE            NOMINATED NODE   READINESS GATES
nginx-6976f57754-75chk        2/2     Terminating   7          6d23h   172.163.98.187    k8s-node-02     &lt;none&gt;           &lt;none&gt;
nginx-6976f57754-8fjzp        2/2     Terminating   7          6d23h   172.174.107.71    k8s-master-01   &lt;none&gt;           &lt;none&gt;
nginx-6976f57754-rp6p5        2/2     Terminating   7          6d23h   172.175.44.19     k8s-node-01     &lt;none&gt;           &lt;none&gt;
nginx-6dfccfcb68-dct2p        2/2     Running       0          8s      172.174.107.73    k8s-master-01   &lt;none&gt;           &lt;none&gt;
nginx-6dfccfcb68-fm26r        2/2     Running       0          6s      172.174.107.74    k8s-master-01   &lt;none&gt;           &lt;none&gt;
nginx-6dfccfcb68-vkvcx        2/2     Running       0          10s     172.174.107.72    k8s-master-01   &lt;none&gt;           &lt;none&gt;

# kubectl describe pod nginx-6dfccfcb68-vkvcx 
......
Tolerations:     master-test=test:NoSchedule
                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                 node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type    Reason     Age   From               Message
  ----    ------     ----  ----               -------
  Normal  Scheduled  60s   default-scheduler  Successfully assigned default/nginx-6dfccfcb68-vkvcx to k8s-master-01
  Normal  Pulled     60s   kubelet            Container image &quot;nginx:1.16.1&quot; already present on machine
  Normal  Created    59s   kubelet            Created container nginx
  Normal  Started    59s   kubelet            Started container nginx
  Normal  Pulled     59s   kubelet            Container image &quot;nginx:1.15.2&quot; already present on machine
  Normal  Created    59s   kubelet            Created container nginx2
  Normal  Started    59s   kubelet            Started container nginx2
</code></pre><p>可以看到添加toleration以后，nginx的pod全部调度到k8s-master-01节点上。</p>
<pre class="line-numbers language-yaml"><code class="language-yaml">      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"master-test"</span>
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"test"</span>
        <span class="token key atrule">effect</span><span class="token punctuation">:</span> <span class="token string">"NoSchedule"</span>
        <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">"Equal"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>effect参数信息：</p>
<ul>
<li>NoSchedule：禁止调度</li>
<li>NoExecute：如果不符合这个污点，会立刻被驱逐</li>
</ul>
<pre class="line-numbers language-yaml"><code class="language-yaml">      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"master-test"</span>
        <span class="token key atrule">value</span><span class="token punctuation">:</span> <span class="token string">"test"</span>
        <span class="token key atrule">effect</span><span class="token punctuation">:</span> <span class="token string">"NoExecute"</span>
        <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">"Equal"</span>
        <span class="token key atrule">tolerationSeconds</span><span class="token punctuation">:</span> <span class="token number">60 </span><span class="token comment" spellcheck="true"># 在节点上允许的停留时间，超过这个时间还是要被驱逐</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>PreferNoSchedule：尽量避免将Pod调度到指定的节点上（软污点，非强制性的）</li>
</ul>
<p>operator参数信息：</p>
<ul>
<li>Equal：完全匹配key、value、effect这三个taint才能被调度。</li>
<li>Exists：</li>
</ul>
<pre class="line-numbers language-yaml"><code class="language-yaml">
<span class="token comment" spellcheck="true"># 只要匹配到key和effect都可以容忍，不管value是多少</span>
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"master-test"</span>
        <span class="token key atrule">effect</span><span class="token punctuation">:</span> <span class="token string">"NoSchedule"</span>
        <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">"Exists"</span>

<span class="token comment" spellcheck="true"># 或者如下所示，容忍所有的taint</span>
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">"Exists"</span>

<span class="token comment" spellcheck="true"># 或者如下所示，只要节点存在matest-test的key，容忍匹配的taint</span>
      <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">operator</span><span class="token punctuation">:</span> <span class="token string">"Exists"</span>
        <span class="token key atrule">key</span><span class="token punctuation">:</span> <span class="token string">"master-test"</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果node节点有多个Taint，在Pod/Deployment上设置每个Taint都需要容忍才能部署到该node上。</p>
<p>删除污点的操作如下：</p>
<pre><code># kubectl taint node k8s-master-01 master-test:NoExecute-
node/k8s-master-01 untainted
</code></pre><p>当某个节点不正常时，k8s中master会自动给不正常的节点，添加几个Taint。通过describe命令可以查看，排查节点问题。</p>
<pre><code>
# kubectl describe node k8s-master-01

node.kubernetes.io/unreachable:NoExecute
node.kubernetes.io/unreachable:NoSchedule

node.kubernetes.io/not-ready:NoExecute for 300s   # 节点没有准备好
node.kubernetes.io/unreachable:NoExecute for 300s
</code></pre><p>参考连接：<a href="https://www.cnblogs.com/tylerzhou/p/11026364.html" target="_blank" rel="noopener">https://www.cnblogs.com/tylerzhou/p/11026364.html</a></p>
<p>周国通系列文章：<a href="https://www.cnblogs.com/tylerzhou/p/10969041.html" target="_blank" rel="noopener">https://www.cnblogs.com/tylerzhou/p/10969041.html</a></p>
<p>2.14.8 InitContainer初始化容器</p>
<p>在我们应用容器启动之前做的一些初始化操作。例如：初始化环境，执行一些内核变更的命令。保证一定会在容器启动之前运行。</p>
<p>postStart：在容器启动之前做一些操作。不能保证在你的container的EntryPoint之前运行。</p>
<p>可以指定多个initContainer，只有上面的运行成功之后，才能运行下一个container。当所有的initContainers执行完毕后，它才会运行真正要部署的container。</p>
<pre><code>
$ kubectl edit deploy nginx

// 修改如下内容
spec:
  progressDeadlineSeconds: 600
  replicas: 3
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: nginx
  strategy:
    rollingUpdate:
      maxSurge: 25%
      maxUnavailable: 25%
    type: RollingUpdate
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: nginx
    spec:
      // 添加初始化容器的内容，向容器文件中添加内容
      initContainers:
      - command:
        - sh
        - -c
        - echo &quot;InitAllContainers&quot; &gt;&gt; /mnt/init
        image: nginx
        imagePullPolicy: IfNotPresent
        name: init1
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /mnt
          name: share-volume

      containers:
      - image: nginx:1.16.1
        imagePullPolicy: I

。。。。。
</code></pre><p>在容器三次初始化时，会发现往文件中追加了三次写入！</p>
<p>2.14.9 Affinity亲和力</p>
<ol>
<li><p>NodeAffinity: 节点亲和力</p>
<ul>
<li>requiredDuringSchedulingIgnoredDuringExecution：硬亲和力，必须。既支持必须部署在指定节点上，也支持必须不部署在指定的节点上。</li>
<li>preferredDuringSchedulingIgnoredDuringExecution：软亲和力，尽量。尽量部署在满足条件的节点上，尽量不要部署在被匹配的节点。</li>
</ul>
</li>
</ol>
<p>nodeSelector仅仅支持部署在指定节点上，不支持必须不部署在指定节点上。</p>
<ol start="2">
<li><p>PodAffinity：Pod亲和力</p>
<p> A应用、B应用、C应用，将A应用根据某种策略尽量部署在一块。使用Label进行区分</p>
<ul>
<li>requiredDuringSchedulingIgnoredDuringExecution：将A应用和B应用部署在一块</li>
<li>preferredDuringSchedulingIgnoredDuringExecution：尽量将A应用和B应用部署在一块</li>
</ul>
</li>
<li><p>PodAntiAffinity：Pod反亲和力</p>
<p> A应用、B应用、C应用，将A应用根据某种策略尽量不部署在一块。</p>
<ul>
<li>requiredDuringSchedulingIgnoredDuringExecution：不要将A应用和与之匹配的应用部署在一块</li>
<li>preferredDuringSchedulingIgnoredDuringExecution：尽量不要将A应用和与之匹配的应用部署在一块</li>
</ul>
</li>
</ol>
<p>如果集群节点数超过1000，不建议使用该方式进行调度，由于需要计算的关系，会导致调度时间过长。优化的方式是，减少调度的节点，也就是对部分节点进行调度，这样可以加快调度的速度，而且不影响其它节点的运行。</p>

            </div>
            <hr />

            
            <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.88rem;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-large waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fa fa-close"></i></a>
            <h4 class="reward-title">写作不易，客官能否打赏一杯奶茶？</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.png" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>
            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            

    <div class="reprint" id="reprint-statement">
        <p class="reprint-tip">
            <i class="fa fa-exclamation-triangle"></i>&nbsp;&nbsp;
            <span>转载规则</span>
        </p>
        
            <div class="center-align">
                <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                    <img alt=""
                         style="border-width:0"
                         src="https://i.creativecommons.org/l/by/4.0/88x31.png"/>
                </a>
            </div>
            <br/>
            <span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Text"
                  property="dct:title" rel="dct:type">
                    《k8s一阶段学习记录》
                </span> 由
            <a xmlns:cc="http://creativecommons.org/ns#" href="/2021/03/19/k8s-yi-jie-duan-xue-xi-ji-lu/" property="cc:attributionName"
               rel="cc:attributionURL">
                JamesLiAndroid
            </a> 采用
            <a rel="license" href="https://creativecommons.org/licenses/by/4.0/deed.zh">
                知识共享署名 4.0 国际许可协议
            </a>进行许可。
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>


        </div>
    </div>

    

    

    

    

    
    <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments input[type=text],
    #vcomments input[type=email],
    #vcomments input[type=url],
    #vcomments textarea {
        box-sizing: border-box;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #42b983;
        font-weight: 500;
        text-decoration: underline;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div id="vcomments" class="card-content"></div>
</div>

<script src="/libs/valine/av-min.js"></script>
<script src="/libs/valine/Valine.min.js"></script>
<!-- <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script> -->

<script>
    new Valine({
        el: '#vcomments',
        appId: '',
        appKey: '',
        notify: 'false' === 'true',
        verify: 'false' === 'true',
        visitor: 'false' === 'true',
        avatar: 'wavatar',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: '如果你没有GitHub账号，还可以在这里评论啦！'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2021/04/04/k8s-1-20-5-er-jin-zhi-an-zhuang-jiao-cheng/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/14.jpg" class="responsive-img" alt="k8s 1.20.5 二进制安装教程">
                        
                        <span class="card-title">k8s 1.20.5 二进制安装教程</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            k8s 1.20.5 二进制安装教程资源准备以及ip地址分配准备了六台机器进行安装，全部部署kubelet以及kube-porxy，不是在特定机器上进行部署，通过标签的方式控制业务服务的部署范围。
机器列表以及安装内容如下:



机器名

                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2021-04-04
                        </span>
                        <span class="publish-author">
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2021/03/06/quan-lian-lu-hui-du-fa-bu-shi-jian/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/11.jpg" class="responsive-img" alt="全链路灰度发布实践">
                        
                        <span class="card-title">全链路灰度发布实践</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            全链路灰度发布方案前言根据目前公司现状，需要进行上云的操作，涉及到服务保障的部分，要求做到三个9的可用率，所以率先进行灰度发布的预研，保证发布过程中进行平滑升级的操作，及早暴露发布问题，做到尽可能的无损发布。
方案综述目前平台这边整个技术栈
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2021-03-06
                            </span>
                        <span class="publish-author">
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: 时代与猫的脚步<br />'
            + '作者: JamesLiAndroid<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。感谢您的支持。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () { bodyElement.removeChild(newdiv); }, 200);
    });
</script>

    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fa fa-list"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).slideUp(500);
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).slideDown(500);
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>
    

</main>


<script src="https://cdn.bootcss.com/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script>
    MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$', '$'], ['\(', '\)']]}
    });
</script>

    <footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
            &copy; 2019 WeiYang. All Rights Reserved.
            <a href="http://www.beian.miit.gov.cn">鲁ICP备17011350号</a>
            
            &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
            <span class="white-color">287.2k</span>
            

            <br>
            <span id="sitetime"></span>

            
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/JamesLiAndroid" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fa fa-github"></i>
    </a>



    <a href="mailto:lsy1234567@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>



    <a href="https://zhihu.com/people/li-tian-90-66" class="tooltipped" target="_blank" data-tooltip="访问我的知乎" data-position="top" data-delay="50">
        <i class="fa fa-inverse">知</i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fa fa-rss"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>

<!-- 不蒜子计数初始值纠正 -->
<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);
        var pvcountOffset = 80000;
        var uvcountOffset = 20000;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int);
            }
        }
    });
</script>

<script language=javascript>
    function siteTime() {
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth() + 1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        /* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
        year - 作为date对象的年份，为4位年份值
        month - 0-11之间的整数，做为date对象的月份
        day - 1-31之间的整数，做为date对象的天数
        hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
        minutes - 0-59之间的整数，做为date对象的分钟数
        seconds - 0-59之间的整数，做为date对象的秒数
        microseconds - 0-999之间的整数，做为date对象的毫秒数 */
        var t1 = Date.UTC(2020, 01, 28, 00, 00, 00); //北京时间2018-2-13 00:00:00
        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
        var diff = t2 - t1;
        var diffYears = Math.floor(diff / years);
        var diffDays = Math.floor((diff / days) - diffYears * 365);
        var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
        var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) / minutes);
        var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours - diffMinutes * minutes) / seconds);
        document.getElementById("sitetime").innerHTML = "本站已运行 " + diffYears + " 年 " + diffDays + " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
    }/*因为建站时间还没有一年，就将之注释掉了。需要的可以取消*/
    siteTime();
</script>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <script type="text/javascript"> var OriginTitile = document.title, st; document.addEventListener("visibilitychange", function () { document.hidden ? (document.title = "Σ(っ °Д °;)っ喔哟，崩溃啦！", clearTimeout(st)) : (document.title = "φ(゜▽゜*)♪咦，又好了！", st = setTimeout(function () { document.title = OriginTitile }, 3e3)) })
    </script>

    <!-- Global site tag (gtag.js) - Google Analytics -->



    
    <script src="/libs/others/clicklove.js"></script>
    

    

    <!-- 雪花特效 -->
    

</body>

</html>